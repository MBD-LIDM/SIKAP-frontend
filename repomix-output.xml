This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.dart_tool/dartpad/web_plugin_registrant.dart
analysis_options.yaml
lib/core/auth/ensure_guest_auth.dart
lib/core/auth/session_service.dart
lib/core/network/api_client.dart
lib/core/network/api_env.dart
lib/core/network/api_exception.dart
lib/core/network/api_response.dart
lib/core/network/auth_header_provider.dart
lib/core/network/logging.dart
lib/core/network/multipart_client.dart
lib/core/network/paging.dart
lib/core/network/query.dart
lib/core/theme/app_theme.dart
lib/core/theme/usage_examples.dart
lib/features/accounts/data/models/accounts_create_response.dart
lib/features/accounts/data/models/accounts_detail_response.dart
lib/features/accounts/data/models/accounts_list_response.dart
lib/features/accounts/data/models/accounts_model.dart
lib/features/accounts/data/repositories/accounts_repository.dart
lib/features/accounts/domain/entities/accounts_entity.dart
lib/features/accounts/domain/enums/accounts_status.dart
lib/features/accounts/presentation/pages/accounts_detail_page.dart
lib/features/accounts/presentation/pages/accounts_form_page.dart
lib/features/accounts/presentation/pages/accounts_request_status_page.dart
lib/features/accounts/utils/accounts_validator.dart
lib/features/authentication/authentication.dart
lib/features/authentication/presentation/pages/login_page.dart
lib/features/authentication/presentation/pages/pages.dart
lib/features/authentication/presentation/pages/teacher_login_page.dart
lib/features/bullying/data/models/bullying_create_response.dart
lib/features/bullying/data/models/bullying_detail_response.dart
lib/features/bullying/data/models/bullying_list_response.dart
lib/features/bullying/data/models/bullying_model.dart
lib/features/bullying/data/repositories/bullying_repository.dart
lib/features/bullying/domain/entities/bullying_entity.dart
lib/features/bullying/domain/enums/bullying_severity.dart
lib/features/bullying/domain/enums/bullying_type.dart
lib/features/bullying/presentation/pages/bullying_detail_page.dart
lib/features/bullying/presentation/pages/bullying_form_page.dart
lib/features/bullying/presentation/pages/bullying_report_wizard_page.dart
lib/features/bullying/presentation/pages/bullying_reports_list_page.dart
lib/features/bullying/presentation/pages/bullying_request_status_page.dart
lib/features/bullying/utils/bullying_validator.dart
lib/features/cases/presentation/pages/case_confirmation_page.dart
lib/features/cases/presentation/pages/case_detail_page.dart
lib/features/cases/presentation/pages/case_list_page.dart
lib/features/dashboard/presentation/dashboard_global.dart
lib/features/home/presentation/pages/home_page.dart
lib/features/home/presentation/pages/home_teacher_page.dart
lib/features/home/presentation/widgets/feature_button_placeholder.dart
lib/features/mood_check/presentation/pages/mood_check_page.dart
lib/features/mood_check/presentation/pages/mood_check_recording_page.dart
lib/features/mood_check/presentation/pages/mood_check_result_page.dart
lib/features/reflections/presentation/reflection_list.dart
lib/features/reflections/presentation/reflection_scenario.dart
lib/features/scenarios/data/scenario_repository.dart
lib/features/scenarios/domain/models/scenario_models.dart
lib/features/scenarios/presentation/pages/scenario_catalog_page.dart
lib/features/scenarios/presentation/pages/scenario_intro_item_page.dart
lib/features/scenarios/presentation/pages/scenario_intro_page.dart
lib/features/scenarios/presentation/pages/scenario_runner_page.dart
lib/features/screening/data/models/student_survey_list_response.dart
lib/features/screening/data/models/student_survey_submit_response.dart
lib/features/screening/data/repositories/screening_repository.dart
lib/features/screening/presentation/controllers/student_survey_controller.dart
lib/features/screening/presentation/pages/student_survey_my_history_page.dart
lib/features/screening/presentation/pages/student_survey_submit_page.dart
lib/features/screening/presentation/pages/student_survey_teacher_list_page.dart
lib/features/venting/data/repositories/venting_repository.dart
lib/features/wellbeing_resources/data/models/wellbeing_resources_create_response.dart
lib/features/wellbeing_resources/data/models/wellbeing_resources_detail_response.dart
lib/features/wellbeing_resources/data/models/wellbeing_resources_list_response.dart
lib/features/wellbeing_resources/data/models/wellbeing_resources_model.dart
lib/features/wellbeing_resources/data/repositories/wellbeing_resources_repository.dart
lib/features/wellbeing_resources/domain/entities/wellbeing_resources_entity.dart
lib/features/wellbeing_resources/domain/enums/resource_category.dart
lib/features/wellbeing_resources/domain/enums/resource_type.dart
lib/features/wellbeing_resources/presentation/pages/artikel_bullying_detail_page.dart
lib/features/wellbeing_resources/presentation/pages/artikel_info_page.dart
lib/features/wellbeing_resources/presentation/pages/hubungi_bantuan_page.dart
lib/features/wellbeing_resources/presentation/pages/pojok_tenang_page.dart
lib/features/wellbeing_resources/presentation/pages/wellbeing_resources_detail_page.dart
lib/features/wellbeing_resources/presentation/pages/wellbeing_resources_form_page.dart
lib/features/wellbeing_resources/presentation/pages/wellbeing_resources_request_status_page.dart
lib/main.dart
pubspec.yaml
test/widget_test.dart
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".dart_tool/dartpad/web_plugin_registrant.dart">
// Flutter web plugin registrant file.
//
// Generated file. Do not edit.
//

// @dart = 2.13
// ignore_for_file: type=lint

import 'package:file_picker/_internal/file_picker_web.dart';
import 'package:flutter_secure_storage_web/flutter_secure_storage_web.dart';
import 'package:record_web/record_web.dart';
import 'package:flutter_web_plugins/flutter_web_plugins.dart';

void registerPlugins([final Registrar? pluginRegistrar]) {
  final Registrar registrar = pluginRegistrar ?? webPluginRegistrar;
  FilePickerWeb.registerWith(registrar);
  FlutterSecureStorageWeb.registerWith(registrar);
  RecordPluginWeb.registerWith(registrar);
  registrar.registerMessageHandler();
}
</file>

<file path="analysis_options.yaml">
include: package:flutter_lints/flutter.yaml
</file>

<file path="lib/core/auth/ensure_guest_auth.dart">
// lib/core/auth/ensure_guest.dart
import 'package:uuid/uuid.dart';
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/api_exception.dart';
import 'package:sikap/core/auth/session_service.dart';

/// (Opsional) resolve school_code -> school_id.
/// Untuk sementara pakai fallback seed SMATS -> 12345.
Future<int> _resolveSchoolIdOrThrow(ApiClient api, String schoolCode) async {
  if (schoolCode.toUpperCase() == 'SMATS') return 12345;
  throw ApiException(
    message: "Belum ada resolver school_code → school_id untuk: $schoolCode",
    code: 400,
  );
}

/// Pastikan ada sesi guest.
/// - Ambil profil dari SessionService (schoolCode/grade/deviceId).
/// - Lengkapi schoolId/gradeId kalau perlu.
/// - Quick-login → simpan guest_id (+ guest_token jika ada).
Future<void> ensureGuestAuthenticated({
  int? schoolId,
  String? schoolCode,
  int? gradeId,
  String? gradeStr, // "10" | "11" | "12"
  String? deviceId,
}) async {
  final session = SessionService();
  final profile = await session.loadProfile();

  // Fast path: kalau sudah punya guest_id, selesai.
  final existingGid = await session.loadGuestId();
  if (existingGid != null) return;

  final api = ApiClient();

  // Lengkapi deviceId
  final dev = (deviceId ?? profile.deviceId ?? '').trim().isEmpty
      ? const Uuid().v4()
      : (deviceId ?? profile.deviceId!);

  // Lengkapi schoolId
  int? sid = schoolId ?? profile.schoolId;
  final scode = schoolCode ?? profile.schoolCode;
  if (sid == null) {
    if (scode == null || scode.trim().isEmpty) {
      throw ApiException(message: "Harap isi kode sekolah atau school_id.", code: 400);
    }
    sid = await _resolveSchoolIdOrThrow(api, scode.trim());
  }

  // Lengkapi gradeId
  int? gid = gradeId ?? profile.gradeId;
  if (gid == null) {
    final gs = (gradeStr ?? profile.grade ?? '').trim();
    if (gs.isEmpty) {
      throw ApiException(message: "Harap isi grade/grade_id.", code: 400);
    }
    gid = int.tryParse(gs);
    if (gid == null) {
      throw ApiException(message: "Grade harus numerik (mis. 10/11/12).", code: 400);
    }
  }

  // Simpan profil yang sudah lengkap
  await session.saveProfile(schoolId: sid, schoolCode: scode, gradeId: gid, deviceId: dev);

  // === QUICK-LOGIN STUDENT ===
  final payload = {
    "username": "g-$dev",
    "school_id": sid,
    "grade_id": gid,
    "device_id": dev,
  };

  final res = await api.post<Map<String, dynamic>>(
    "/api/accounts/student/quick-login/",
    payload,
    headers: const {
      "Accept": "application/json",
      "Content-Type": "application/json",
    },
    expectEnvelope: false, // respons BE kamu bukan {success,data}
    transform: (raw) => Map<String, dynamic>.from(raw as Map),
  );

  // Contoh respons BE kamu:
  // {
  //   "guest_id": 5, "username": "g-dev-123", "school_id": 12345,
  //   "grade_id": 10, "device_id": "dev-123", "expires_at": "...",
  //   (opsional) "guest_token": "..." 
  // }
  final rawId = res.data['guest_id'];
  if (rawId == null) {
    throw ApiException(message: "guest_id tidak ada di respons BE.", code: 500);
  }
  final gId = (rawId is num) ? rawId.toInt() : int.tryParse(rawId.toString());
  if (gId == null) {
    throw ApiException(message: "guest_id bukan integer: $rawId", code: 500);
  }

  final token = res.data['guest_token'] ?? res.data['token'];
  await session.saveGuest(guestId: gId, token: token is String ? token : null);

  // ignore: avoid_print
  print("[GUEST] stored guest_id=$gId (device=$dev, school=$sid, grade=$gid)");
}
</file>

<file path="lib/core/auth/session_service.dart">
// lib/core/auth/session_service.dart
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class UserProfile {
  final int? schoolId;
  final String? schoolCode;
  final int? gradeId;
  final String? grade;       // "10" | "11" | "12"
  final String? deviceId;

  const UserProfile({
    this.schoolId,
    this.schoolCode,
    this.gradeId,
    this.grade,
    this.deviceId,
  });
}

class SessionService {
  static const _kGuestId     = 'guest_id';
  static const _kGuestToken  = 'guest_token';   // opsional bila BE nanti menambah token
  static const _kSchoolId    = 'school_id';
  static const _kSchoolCode  = 'school_code';
  static const _kGradeId     = 'grade_id';
  static const _kGrade       = 'grade_str';
  static const _kDeviceId    = 'device_id';

  final FlutterSecureStorage _s = const FlutterSecureStorage();

  // ===== Guest creds =====
  Future<void> saveGuest({required int guestId, String? token}) async {
    await _s.write(key: _kGuestId, value: guestId.toString());
    if (token != null && token.isNotEmpty) {
      await _s.write(key: _kGuestToken, value: token);
    }
  }

  Future<int?> loadGuestId() async {
    final v = await _s.read(key: _kGuestId);
    return v == null ? null : int.tryParse(v);
    }

  Future<String?> loadGuestToken() => _s.read(key: _kGuestToken);

  Future<void> clearGuest() async {
    await _s.delete(key: _kGuestId);
    await _s.delete(key: _kGuestToken);
  }

  // ===== Profile (school/grade/device) =====
  Future<void> saveProfile({
    int? schoolId,
    String? schoolCode,
    int? gradeId,
    String? grade,
    String? deviceId,
  }) async {
    if (schoolId != null)   await _s.write(key: _kSchoolId, value: schoolId.toString());
    if (schoolCode != null) await _s.write(key: _kSchoolCode, value: schoolCode);
    if (gradeId != null)    await _s.write(key: _kGradeId, value: gradeId.toString());
    if (grade != null)      await _s.write(key: _kGrade, value: grade);
    if (deviceId != null)   await _s.write(key: _kDeviceId, value: deviceId);
  }

  Future<UserProfile> loadProfile() async {
    final sid = await _s.read(key: _kSchoolId);
    final sc  = await _s.read(key: _kSchoolCode);
    final gid = await _s.read(key: _kGradeId);
    final gs  = await _s.read(key: _kGrade);
    final dev = await _s.read(key: _kDeviceId);

    return UserProfile(
      schoolId: sid == null ? null : int.tryParse(sid),
      schoolCode: sc,
      gradeId: gid == null ? null : int.tryParse(gid),
      grade: gs,
      deviceId: dev,
    );
  }
}
</file>

<file path="lib/core/network/logging.dart">
import 'dart:convert';
import 'package:flutter/foundation.dart';

/// Aktifkan via: --dart-define=LOG_HTTP=true
const bool kLogHttp = bool.fromEnvironment('LOG_HTTP', defaultValue: false);

String _safeJson(dynamic body) {
  try {
    if (body is String) return body;
    return const JsonEncoder.withIndent('  ').convert(body);
  } catch (_) {
    return '<non-json body>';
  }
}

void logHttp({
  required String phase,        // REQ | RES | ERR
  required String requestId,
  required String method,       // GET | POST | PATCH | DELETE | POST-MULTIPART
  required Uri uri,
  Map<String, String>? headers,
  dynamic body,
  int? status,
  Duration? duration,
  Object? error,
}) {
  if (!kLogHttp && !kDebugMode) return; // hanya log saat dev/diaktifkan

  final b = StringBuffer();
  b.writeln('[HTTP $phase] $method ${uri.toString()}');
  b.writeln('  id: $requestId');
  if (status != null) b.writeln('  status: $status');
  if (duration != null) b.writeln('  duration: ${duration.inMilliseconds} ms');

  if (headers != null && headers.isNotEmpty) {
    final redacted = Map<String, String>.from(headers);
    // Mask token
    if (redacted.containsKey('Authorization')) redacted['Authorization'] = '<redacted>';
    if (redacted.containsKey('X-Guest-Token')) redacted['X-Guest-Token'] = '<redacted>';
    b.writeln('  headers: $redacted');
  }
  if (body != null) {
    b.writeln('  body:\n${_safeJson(body)}');
  }
  if (error != null) {
    b.writeln('  error: $error');
  }
  // ignore: avoid_print
  print(b.toString());
}
</file>

<file path="lib/core/network/paging.dart">
import 'api_exception.dart';

T transformList<T>(dynamic json, T Function(List<dynamic>) mapper) {
  if (json is Map && json["results"] is List) return mapper(json["results"]);
  if (json is List) return mapper(json);
  throw ApiException(message: "Format list tidak dikenali");
}
</file>

<file path="lib/features/accounts/data/models/accounts_create_response.dart">
class AccountsCreateResponse {
  final bool success;
  final String message;
  final Map<String, dynamic>? data;

  AccountsCreateResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory AccountsCreateResponse.fromJson(Map<String, dynamic> json) {
    return AccountsCreateResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/accounts/data/models/accounts_detail_response.dart">
class AccountsDetailResponse {
  final bool success;
  final String message;
  final Map<String, dynamic>? data;

  AccountsDetailResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory AccountsDetailResponse.fromJson(Map<String, dynamic> json) {
    return AccountsDetailResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/accounts/data/models/accounts_list_response.dart">
class AccountsListResponse {
  final bool success;
  final String message;
  final List<dynamic>? data;

  AccountsListResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory AccountsListResponse.fromJson(Map<String, dynamic> json) {
    return AccountsListResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/accounts/data/models/accounts_model.dart">
class AccountsModel {
  final String id;
  final String username;
  final String email;
  final String? fullName;
  final String? role;
  final DateTime createdAt;
  final DateTime? updatedAt;

  AccountsModel({
    required this.id,
    required this.username,
    required this.email,
    this.fullName,
    this.role,
    required this.createdAt,
    this.updatedAt,
  });

  factory AccountsModel.fromJson(Map<String, dynamic> json) {
    return AccountsModel(
      id: json['id'] ?? '',
      username: json['username'] ?? '',
      email: json['email'] ?? '',
      fullName: json['full_name'],
      role: json['role'],
      createdAt: DateTime.parse(json['created_at'] ?? DateTime.now().toIso8601String()),
      updatedAt: json['updated_at'] != null ? DateTime.parse(json['updated_at']) : null,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'username': username,
      'email': email,
      'full_name': fullName,
      'role': role,
      'created_at': createdAt.toIso8601String(),
      'updated_at': updatedAt?.toIso8601String(),
    };
  }
}
</file>

<file path="lib/features/accounts/domain/entities/accounts_entity.dart">
class AccountsEntity {
  final String id;
  final String username;
  final String email;
  final String? fullName;
  final String? role;
  final DateTime createdAt;
  final DateTime? updatedAt;

  AccountsEntity({
    required this.id,
    required this.username,
    required this.email,
    this.fullName,
    this.role,
    required this.createdAt,
    this.updatedAt,
  });
}
</file>

<file path="lib/features/authentication/authentication.dart">
export 'presentation/pages/pages.dart';
</file>

<file path="lib/features/authentication/presentation/pages/pages.dart">
export 'login_page.dart';
</file>

<file path="lib/features/cases/presentation/pages/case_list_page.dart">
import 'package:flutter/material.dart';
import 'case_detail_page.dart';

class CasesListPage extends StatefulWidget {
  const CasesListPage({super.key});

  @override
  State<CasesListPage> createState() => _CasesListPageState();
}

class _CasesListPageState extends State<CasesListPage> {
  final List<_CaseItem> _all = [
    _CaseItem(status: 'Baru', title: 'Bullying Verbal', createdAt: DateTime(2025, 8, 22, 9, 18)),
    _CaseItem(status: 'Diproses', title: 'Pengucilan', createdAt: DateTime(2025, 8, 21, 15, 10)),
    _CaseItem(status: 'Selesai', title: 'Cyberbullying', createdAt: DateTime(2025, 8, 18, 8, 30)),
  ];

  String _filter = 'Semua';
  String _sort = 'Terbaru';

  List<_CaseItem> get _filteredSorted {
    List<_CaseItem> list = _all.where((c) => _filter == 'Semua' || c.status == _filter).toList();
    list.sort((a, b) => _sort == 'Terbaru' ? b.createdAt.compareTo(a.createdAt) : a.createdAt.compareTo(b.createdAt));
    return list;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Lihat Kasus'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFF7F55B1), Color(0xFFFFDBB6)],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 12),
            child: Column(
              children: [
                // Filter & Sort Row
                Row(
                  children: [
                    Expanded(child: _buildPillButton(icon: Icons.filter_list, label: 'Filter', onTap: _showFilterDialog)),
                    const SizedBox(width: 12),
                    Expanded(child: _buildPillButton(icon: Icons.sort, label: 'Urutkan', onTap: _showSortDialog)),
                  ],
                ),
                const SizedBox(height: 16),
                Expanded(
                  child: ListView.builder(
                    itemCount: _filteredSorted.length,
                    itemBuilder: (context, index) {
                      final item = _filteredSorted[index];
                      return _CaseCard(item: item);
                    },
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildPillButton({required IconData icon, required String label, required VoidCallback onTap}) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        height: 44,
        decoration: BoxDecoration(
          color: Colors.white.withValues(alpha: 0.8),
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 8, offset: const Offset(0, 2)),
          ],
        ),
        padding: const EdgeInsets.symmetric(horizontal: 16),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, color: const Color(0xFF7F55B1)),
            const SizedBox(width: 8),
            Text(label, style: const TextStyle(color: Colors.black87, fontWeight: FontWeight.w600)),
          ],
        ),
      ),
    );
  }

  void _showFilterDialog() {
    showDialog(
      context: context,
      builder: (context) {
        return SimpleDialog(
          title: const Text('Filter status'),
          children: [
            RadioGroup<String>(
              groupValue: _filter,
              onChanged: (val) {
                if (val == null) return;
                setState(() => _filter = val);
                Navigator.pop(context);
              },
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  ...['Semua', 'Baru', 'Diproses', 'Selesai'].map(
                    (s) => RadioListTile<String>(
                      title: Text(s),
                      value: s,
                    ),
                  ),
                ],
              ),
            ),
          ],
        );
      },
    );
  }

  void _showSortDialog() {
    showDialog(
      context: context,
      builder: (context) {
        return SimpleDialog(
          title: const Text('Urutkan'),
          children: [
            RadioGroup<String>(
              groupValue: _sort,
              onChanged: (val) {
                if (val == null) return;
                setState(() => _sort = val);
                Navigator.pop(context);
              },
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  ...['Terbaru', 'Terlama'].map(
                    (s) => RadioListTile<String>(
                      title: Text(s),
                      value: s,
                    ),
                  ),
                ],
              ),
            ),
          ],
        );
      },
    );
  }
}

class _CaseItem {
  _CaseItem({required this.status, required this.title, required this.createdAt});
  final String status;
  final String title;
  final DateTime createdAt;
}

class _CaseCard extends StatelessWidget {
  const _CaseCard({required this.item});
  final _CaseItem item;

  Color get statusColor {
    switch (item.status) {
      case 'Baru':
        return const Color(0xFF2196F3);
      case 'Diproses':
        return const Color(0xFFFF9800);
      case 'Selesai':
        return const Color(0xFF2E7D32);
      default:
        return Colors.grey;
    }
  }

  @override
  Widget build(BuildContext context) {
    final card = Container(
      margin: const EdgeInsets.only(bottom: 12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(color: Colors.black.withValues(alpha: 0.1), blurRadius: 12, offset: const Offset(0, 4)),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Status Chip
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
              decoration: BoxDecoration(color: statusColor.withValues(alpha: 0.15), borderRadius: BorderRadius.circular(20)),
              child: Text(item.status, style: TextStyle(color: statusColor, fontWeight: FontWeight.w700, fontSize: 12)),
            ),
            const SizedBox(height: 8),
            Text(item.title, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w800, color: Colors.black87)),
            const SizedBox(height: 8),
            Row(
              children: [
                const Icon(Icons.edit_calendar, size: 18, color: Colors.black45),
                const SizedBox(width: 8),
                Text(_formatDate(item.createdAt), style: const TextStyle(color: Colors.black45)),
              ],
            ),
          ],
        ),
      ),
    );

    if (item.title == 'Bullying Verbal') {
      return GestureDetector(
        onTap: () {
          Navigator.of(context).push(
            MaterialPageRoute(
              builder: (context) => CaseDetailPage(
                title: item.title,
                status: item.status,
                createdAt: item.createdAt,
                category: 'Secara verbal',
                description:
                    'Terjadi tindakan bullying secara verbal seperti mengejek dan menghina saat pelajaran berlangsung. Terjadi tindakan bullying secara verbal seperti mengejek dan menghina saat pelajaran berlangsungTerjadi tindakan bullying secara verbal seperti mengejek dan menghina saat pelajaran berlangsungTerjadi tindakan bullying secara verbal seperti mengejek dan menghina saat pelajaran berlangsungTerjadi tindakan bullying secara verbal seperti mengejek dan menghina saat pelajaran berlangsungTerjadi tindakan bullying secara verbal seperti mengejek dan menghina saat pelajaran berlangsung',
                evidences: const ['Screenshot chat', 'Catatan kronologi'],
                anonymous: false,
                confirmTruth: true,
              ),
            ),
          );
        },
        child: card,
      );
    }
    return card;
  }

  static String _formatDate(DateTime dt) {
    String two(int n) => n.toString().padLeft(2, '0');
    return '${dt.year}-${two(dt.month)}-${two(dt.day)} ${two(dt.hour)}:${two(dt.minute)}:${two(dt.second)}';
  }
}
</file>

<file path="lib/features/reflections/presentation/reflection_list.dart">
import 'package:flutter/material.dart';

class ReflectionListPage extends StatefulWidget {
  const ReflectionListPage({
    super.key,
    required this.scenarioTitle,
    required this.scenarioDescription,
    required this.question,
  });

  final String scenarioTitle;
  final String scenarioDescription;
  final String question;

  @override
  State<ReflectionListPage> createState() => _ReflectionListPageState();
}

class _ReflectionListPageState extends State<ReflectionListPage> {
  String _sort = 'Terbaru';

  // Placeholder data. Nantinya dapat diganti dari API/backend.
  final List<_ReflectionItem> _reflections = [
    _ReflectionItem(createdAt: DateTime.now().subtract(const Duration(hours: 2)), text: 'Saya belajar untuk minta bantuan wali kelas saat melihat teman dibully.'),
    _ReflectionItem(createdAt: DateTime.now().subtract(const Duration(days: 1, hours: 3)), text: 'Saat sedih, saya mencoba bernapas dalam dan bicara ke orang tua.'),
    _ReflectionItem(createdAt: DateTime.now().subtract(const Duration(days: 3)), text: 'Saya akan melapor dengan aman dan tidak menghadapi sendiri pelaku.'),
  ];

  List<_ReflectionItem> get _sortedList {
    final list = [..._reflections];
    list.sort((a, b) => _sort == 'Terbaru' ? b.createdAt.compareTo(a.createdAt) : a.createdAt.compareTo(b.createdAt));
    return list;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Daftar Refleksi Siswa'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      body: Container(
        color: const Color(0xFF7F55B1),
        child: SafeArea(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(widget.scenarioTitle, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w800)),
                    const SizedBox(height: 8),
                    Text('Deskripsi Skenario: ${widget.scenarioDescription}', style: const TextStyle(color: Colors.white70)),
                    const SizedBox(height: 8),
                    Text('Pertanyaan yang diberikan: ${widget.question}', style: const TextStyle(color: Colors.white70)),
                  ],
                ),
              ),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16.0),
                child: Row(
                  children: [
                    Expanded(
                      child: Container(
                        height: 44,
                        decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(24), boxShadow: [
                          BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 8, offset: const Offset(0, 2)),
                        ]),
                        child: DropdownButtonHideUnderline(
                          child: DropdownButton<String>(
                            value: _sort,
                            padding: const EdgeInsets.symmetric(horizontal: 16),
                            items: const [
                              DropdownMenuItem(value: 'Terbaru', child: Text('Terbaru')),
                              DropdownMenuItem(value: 'Terlama', child: Text('Terlama')),
                            ],
                            onChanged: (v) => setState(() => _sort = v ?? 'Terbaru'),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 12),
              Expanded(
                child: ListView.builder(
                  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  itemCount: _sortedList.length,
                  itemBuilder: (context, index) {
                    final item = _sortedList[index];
                    return _ReflectionCard(item: item);
                  },
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _ReflectionItem {
  _ReflectionItem({required this.createdAt, required this.text});
  final DateTime createdAt;
  final String text;
}

class _ReflectionCard extends StatelessWidget {
  const _ReflectionCard({required this.item});
  final _ReflectionItem item;

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(color: Colors.black.withValues(alpha: 0.12), blurRadius: 12, offset: const Offset(0, 4)),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                const Icon(Icons.schedule, size: 18, color: Colors.black54),
                const SizedBox(width: 8),
                Text(_formatDate(item.createdAt), style: const TextStyle(color: Colors.black54)),
              ],
            ),
            const SizedBox(height: 8),
            Text(item.text),
          ],
        ),
      ),
    );
  }

  static String _formatDate(DateTime dt) {
    String two(int n) => n.toString().padLeft(2, '0');
    return '${dt.year}-${two(dt.month)}-${two(dt.day)} ${two(dt.hour)}:${two(dt.minute)}:${two(dt.second)}';
  }
}
</file>

<file path="lib/features/scenarios/data/scenario_repository.dart">
import 'dart:convert';
import 'package:flutter/services.dart' show rootBundle;
import '../../scenarios/domain/models/scenario_models.dart';

class ScenarioRepository {
  ScenarioRepository({this.assetPath = 'assets/data/scenarios_data.json'});

  final String assetPath;

  Future<List<ScenarioItem>> loadScenarios() async {
    final jsonString = await rootBundle.loadString(assetPath);
    final List<dynamic> list = json.decode(jsonString) as List<dynamic>;
    return list.map((e) => ScenarioItem.fromJson(e as Map<String, dynamic>)).toList();
  }

  Future<Map<String, List<ScenarioItem>>> loadByLevel() async {
    final scenarios = await loadScenarios();
    final Map<String, List<ScenarioItem>> grouped = {};
    for (final item in scenarios) {
      grouped.putIfAbsent(item.level, () => []).add(item);
    }
    return grouped;
  }
}
</file>

<file path="lib/features/scenarios/domain/models/scenario_models.dart">
class ScenarioOption {
  ScenarioOption({
    required this.id,
    required this.answer,
    required this.feedback,
    required this.nextStage,
  });

  final String id;
  final String answer;
  final String feedback;
  final int nextStage; // tahap_ke tujuan (1-based)

  factory ScenarioOption.fromJson(Map<String, dynamic> json) {
    return ScenarioOption(
      id: json['id'] as String,
      answer: json['jawaban'] as String,
      feedback: json['umpan_balik'] as String,
      nextStage: (json['lanjut_ke_tahap'] as num).toInt(),
    );
  }
}

class ScenarioStage {
  ScenarioStage({
    required this.stageNumber,
    required this.narration,
    required this.question,
    required this.illustrationFile,
    required this.options,
  });

  final int stageNumber; // 1-based
  final String narration;
  final String question;
  final String illustrationFile; // e.g., sd_1_1.png
  final List<ScenarioOption> options; // kosong jika tahap refleksi

  bool get isReflection => options.isEmpty;

  factory ScenarioStage.fromJson(Map<String, dynamic> json) {
    final List<dynamic> rawOptions = json['pilihan'] as List<dynamic>;
    return ScenarioStage(
      stageNumber: (json['tahap_ke'] as num).toInt(),
      narration: json['narasi'] as String,
      question: json['pertanyaan'] as String,
      illustrationFile: json['ilustrasi_file'] as String,
      options: rawOptions.map((e) => ScenarioOption.fromJson(e as Map<String, dynamic>)).toList(),
    );
  }
}

class ScenarioItem {
  ScenarioItem({
    required this.level,
    required this.title,
    required this.srlLesson,
    required this.stages,
  });

  final String level; // SD/SMP/SMA
  final String title; // Nama skenario
  final String srlLesson; // pelajaran_srl
  final List<ScenarioStage> stages;

  factory ScenarioItem.fromJson(Map<String, dynamic> json) {
    final List<dynamic> rawStages = json['tahapan'] as List<dynamic>;
    return ScenarioItem(
      level: json['jenjang'] as String,
      title: json['skenario'] as String,
      srlLesson: json['pelajaran_srl'] as String,
      stages: rawStages.map((e) => ScenarioStage.fromJson(e as Map<String, dynamic>)).toList(),
    );
  }
}
</file>

<file path="lib/features/scenarios/presentation/pages/scenario_catalog_page.dart">
import 'package:flutter/material.dart';
import '../../../scenarios/data/scenario_repository.dart';
import '../../../scenarios/domain/models/scenario_models.dart';
import '../../../../core/theme/app_theme.dart';
import 'scenario_intro_item_page.dart';

class ScenarioCatalogPage extends StatefulWidget {
  const ScenarioCatalogPage({super.key});

  @override
  State<ScenarioCatalogPage> createState() => _ScenarioCatalogPageState();
}

class _ScenarioCatalogPageState extends State<ScenarioCatalogPage> {
  final ScenarioRepository _repo = ScenarioRepository();
  late Future<Map<String, List<ScenarioItem>>> _future;

  @override
  void initState() {
    super.initState();
    _future = _repo.loadByLevel();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFFFE7CE),
      appBar: AppBar(
        title: const Text('Skenario Intervensi'),
        backgroundColor: const Color(0xFFFFE7CE),
        foregroundColor: const Color(0xFF7F55B1),
      ),
      body: Container(
        color: const Color(0xFFFFE7CE),
        child: SafeArea(
          child: FutureBuilder<Map<String, List<ScenarioItem>>>(
            future: _future,
            builder: (context, snapshot) {
              if (snapshot.connectionState != ConnectionState.done) {
                return const Center(child: CircularProgressIndicator(color: Color(0xFF7F55B1)));
              }
              if (snapshot.hasError) {
                return Center(
                  child: Text('Gagal memuat skenario', style: AppTheme.bodyLarge.copyWith(color: const Color(0xFF3F3F3F))),
                );
              }
              final data = snapshot.data ?? {};
              final levels = ['SD', 'SMP', 'SMA'];
              return ListView(
                padding: const EdgeInsets.all(16),
                children: [
                  for (final level in levels)
                    if ((data[level] ?? []).isNotEmpty) ...[
                      Text(level, style: AppTheme.headingMedium.copyWith(color: const Color(0xFF7F55B1))),
                      const SizedBox(height: 12),
                      ...List.generate((data[level] ?? []).length, (index) {
                        final item = data[level]![index];
                        return _ScenarioTile(
                          title: item.title,
                          description: item.srlLesson,
                          onTap: () {
                            Navigator.of(context).push(
                              MaterialPageRoute(builder: (_) => ScenarioIntroItemPage(item: item)),
                            );
                          },
                        );
                      }),
                      const SizedBox(height: 20),
                    ],
                ],
              );
            },
          ),
        ),
      ),
    );
  }
}

class _ScenarioTile extends StatelessWidget {
  const _ScenarioTile({required this.title, required this.description, required this.onTap});
  final String title;
  final String description;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(color: Colors.black.withValues(alpha: 0.12), blurRadius: 12, offset: const Offset(0, 4)),
        ],
      ),
      child: ListTile(
        title: Text(title, style: const TextStyle(fontWeight: FontWeight.w700, color: Color(0xFF7F55B1))),
        subtitle: Text(description, maxLines: 2, overflow: TextOverflow.ellipsis, style: const TextStyle(color: Color(0xFF3F3F3F))),
        trailing: const Icon(Icons.chevron_right, color: Color(0xFF7F55B1)),
        onTap: onTap,
      ),
    );
  }
}
</file>

<file path="lib/features/scenarios/presentation/pages/scenario_intro_item_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';
import '../../../scenarios/domain/models/scenario_models.dart';
import '../../../../core/theme/app_theme.dart';
import 'scenario_runner_page.dart';

class ScenarioIntroItemPage extends StatelessWidget {
  const ScenarioIntroItemPage({super.key, required this.item});
  final ScenarioItem item;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFFFE7CE),
      body: Container(
        color: const Color(0xFFFFE7CE),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                IconButton(
                  icon: const Icon(Icons.arrow_back, color: Color(0xFF7F55B1)),
                  onPressed: () => Navigator.of(context).pop(),
                ),
                const SizedBox(height: 8),
                Text(item.title, style: AppTheme.headingLarge.copyWith(color: const Color(0xFF7F55B1))),
                const SizedBox(height: 16),
                Center(
                  child: SizedBox(
                    width: 280,
                    height: 220,
                    child: SvgPicture.asset(
                      'assets/images/scenario_intro.svg',
                      fit: BoxFit.contain,
                      allowDrawingOutsideViewBox: true,
                    ),
                  ),
                ),
                const SizedBox(height: 16),
                Text(item.srlLesson, style: AppTheme.bodyLarge.copyWith(color: const Color(0xFF3F3F3F))),
                const Spacer(),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF7F55B1),
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                    ),
                    onPressed: () {
                      Navigator.of(context).push(
                        MaterialPageRoute(
                          builder: (_) => ScenarioRunnerPage(item: item),
                        ),
                      );
                    },
                    child: Text('Mulai Skenario  →', style: AppTheme.buttonText.copyWith(color: Colors.white)),
                  ),
                ),
                const SizedBox(height: 24),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/scenarios/presentation/pages/scenario_intro_page.dart">
import 'package:flutter/material.dart';
import '../../../../core/theme/app_theme.dart';

class ScenarioIntroPage extends StatelessWidget {
  const ScenarioIntroPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFFFE7CE),
      body: Container(
        color: const Color(0xFFFFE7CE),
        child: SafeArea(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Back button
              IconButton(
                icon: const Icon(Icons.arrow_back, color: Color(0xFF7F55B1)),
                onPressed: () => Navigator.of(context).pop(),
              ),
              Expanded(
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 24.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const SizedBox(height: 16),
                      Text('Berani Menolong\nTeman', style: AppTheme.headingLarge.copyWith(color: const Color(0xFF7F55B1))),
                      const SizedBox(height: 24),
                      Text(
                        'Halo!\n\nSebelum kita mulai, bayangkan kamu akan menjadi pahlawan bagi dirimu sendiri atau orang lain.\n\nSetiap pilihan yang kamu buat di sini adalah langkah menuju keberanian.',
                        style: AppTheme.bodyLarge.copyWith(color: const Color(0xFF3F3F3F)),
                      ),
                      const Spacer(),
                      Center(
                        child: SizedBox(
                          height: 180,
                          child: Image.asset('assets/icons/sikap_icon.jpg', fit: BoxFit.contain),
                        ),
                      ),
                      const Spacer(),
                      SizedBox(
                        width: double.infinity,
                        child: ElevatedButton(
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFF7F55B1),
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 16),
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                          ),
                          onPressed: () {
                            Navigator.of(context).push(
                              MaterialPageRoute(
                                builder: (_) => const ScenarioQuestionPage(),
                              ),
                            );
                          },
                          child: Text('Mulai Skenario  →', style: AppTheme.buttonText.copyWith(color: Colors.white)),
                        ),
                      ),
                      const SizedBox(height: 24),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class ScenarioQuestionPage extends StatelessWidget {
  const ScenarioQuestionPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFFFFEDE0), Color(0xFF0C58B9)],
            stops: [0.45, 0.46],
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                IconButton(
                  icon: const Icon(Icons.arrow_back, color: Color(0xFF0C58B9)),
                  onPressed: () => Navigator.of(context).pop(),
                ),
                const SizedBox(height: 12),
                Text(
                  'Di kelas, kamu melihat Darrel sedang menangis di mejanya. Ada beberapa teman yang berbisik-bisik sambil menunjuk ke arahnya.\n\nDarrel terlihat sangat sedih dan tidak berani menoleh.',
                  style: AppTheme.bodyLarge.copyWith(color: const Color(0xFF3F3F3F)),
                ),
                const SizedBox(height: 16),
                Expanded(
                  child: ListView(
                    children: [
                      _OptionTile(
                        text: "Mendatangi Darrel dan bertanya, 'Kamu baik-baik saja?'",
                        onTap: () {
                          Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => const ScenarioFeedbackGoodPage(),
                            ),
                          );
                        },
                      ),
                      const SizedBox(height: 12),
                      _OptionTile(
                        text: 'Pergi ke guru di luar kelas dan melapor secara diam-diam.',
                        onTap: () {
                          Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => const ScenarioFeedbackGoodPage(),
                            ),
                          );
                        },
                      ),
                      const SizedBox(height: 12),
                      _OptionTile(
                        text: 'Mengabaikannya dan pura-pura tidak melihat.',
                        onTap: () {
                          Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => const ScenarioFeedbackBadPage(),
                            ),
                          );
                        },
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class ScenarioFeedbackGoodPage extends StatelessWidget {
  const ScenarioFeedbackGoodPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFFFFEDE0), Color(0xFF0C58B9)],
            stops: [0.45, 0.46],
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                IconButton(
                  icon: const Icon(Icons.arrow_back, color: Color(0xFF0C58B9)),
                  onPressed: () => Navigator.of(context).pop(),
                ),
                const SizedBox(height: 12),
                Text('Pilihan jawabanmu adalah', style: AppTheme.headingMedium.copyWith(color: Colors.white)),
                const SizedBox(height: 12),
                _ChoiceBubble(text: "Mendatangi Darrel dan bertanya, 'Kamu baik-baik saja?'"),
                const SizedBox(height: 16),
                Text(
                  'Hebat! Kamu memilih untuk peduli. Pilihanmu membuat Darrel merasa tidak sendirian.\n\nDengan langsung bertanya, kamu menunjukkan bahwa ada teman yang peduli padanya.',
                  style: AppTheme.bodyLarge,
                ),
                const Spacer(),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF7F55B1),
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                    ),
                    onPressed: () {
                      Navigator.of(context).push(
                        MaterialPageRoute(
                          builder: (_) => const ScenarioReflectionPage(),
                        ),
                      );
                    },
                    child: Text('Skenario Berikutnya  →', style: AppTheme.buttonText.copyWith(color: Colors.white)),
                  ),
                ),
                const SizedBox(height: 24),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class ScenarioFeedbackBadPage extends StatelessWidget {
  const ScenarioFeedbackBadPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFFFFEDE0), Color(0xFF0C58B9)],
            stops: [0.45, 0.46],
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                IconButton(
                  icon: const Icon(Icons.arrow_back, color: Color(0xFF0C58B9)),
                  onPressed: () => Navigator.of(context).pop(),
                ),
                const SizedBox(height: 12),
                Text('Pilihan jawabanmu adalah', style: AppTheme.headingMedium.copyWith(color: Colors.white)),
                const SizedBox(height: 12),
                _ChoiceBubble(text: 'Mengabaikannya dan pura-pura tidak melihat.'),
                const SizedBox(height: 16),
                Text(
                  'Kamu memilih untuk tidak ikut campur. Kadang itu adalah cara yang paling aman, tapi temanmu mungkin tetap merasa sendirian.',
                  style: AppTheme.bodyLarge,
                ),
                const Spacer(),
                Row(
                  children: [
                    Expanded(
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.white,
                          foregroundColor: const Color(0xFF7F55B1),
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                        ),
                        onPressed: () {
                          Navigator.of(context).pop();
                        },
                        child: Text('Coba Lagi', style: AppTheme.buttonTextPurple),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF7F55B1),
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                        ),
                        onPressed: () {
                          Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => const ScenarioReflectionPage(),
                            ),
                          );
                        },
                        child: Text('Skenario Berikutnya  →', style: AppTheme.buttonText.copyWith(color: Colors.white)),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 24),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class ScenarioReflectionPage extends StatelessWidget {
  const ScenarioReflectionPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Skenario Selesai 🥳'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      body: Container(
        color: const Color(0xFF7F55B1),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.all(16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('Berani Menolong\nTeman', style: AppTheme.headingLarge),
                const SizedBox(height: 16),
                Text('Bagaimana perasaanmu saat membuat pilihan tadi?', style: AppTheme.bodyLarge),
                const SizedBox(height: 12),
                _ReflectionBox(hint: 'Ketik jawaban di sini...'),
                const SizedBox(height: 16),
                Text('Apakah ada hal yang akan kamu lakukan berbeda jika ini terjadi sungguhan?', style: AppTheme.bodyLarge),
                const SizedBox(height: 12),
                _ReflectionBox(hint: 'Ketik jawaban di sini...'),
                const Spacer(),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.white,
                      foregroundColor: const Color(0xFF7F55B1),
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                    ),
                    onPressed: () {
                      Navigator.of(context).popUntil((route) => route.isFirst);
                    },
                    child: Text('Kembali ke Homepage', style: AppTheme.buttonTextPurple),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _OptionTile extends StatelessWidget {
  const _OptionTile({required this.text, required this.onTap});

  final String text;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 8, offset: const Offset(0, 4))],
        ),
        child: Row(
          children: [
            Expanded(child: Text(text, style: const TextStyle(fontSize: 16, color: Colors.black87, height: 1.4))),
            const Icon(Icons.chevron_right, color: Color(0xFF7F55B1)),
          ],
        ),
      ),
    );
  }
}

class _ChoiceBubble extends StatelessWidget {
  const _ChoiceBubble({required this.text});

  final String text;

  @override
  Widget build(BuildContext context) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFFF6E7FF),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: const Color(0xFFEDC7FF)),
      ),
      child: Text(text, style: const TextStyle(color: Color(0xFF7F55B1), fontWeight: FontWeight.w600)),
    );
  }
}

class _ReflectionBox extends StatelessWidget {
  const _ReflectionBox({required this.hint});
  final String hint;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 140,
      decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(12)),
      padding: const EdgeInsets.all(12),
      child: TextField(
        maxLines: null,
        expands: true,
        decoration: InputDecoration.collapsed(hintText: hint, hintStyle: const TextStyle(color: Colors.black38)),
        style: const TextStyle(color: Colors.black87),
      ),
    );
  }
}
</file>

<file path="lib/features/scenarios/presentation/pages/scenario_runner_page.dart">
import 'package:flutter/material.dart';
import '../../../scenarios/domain/models/scenario_models.dart';
import '../../../../core/theme/app_theme.dart';

class ScenarioRunnerPage extends StatefulWidget {
  const ScenarioRunnerPage({super.key, required this.item});
  final ScenarioItem item;

  @override
  State<ScenarioRunnerPage> createState() => _ScenarioRunnerPageState();
}

class _ScenarioRunnerPageState extends State<ScenarioRunnerPage> {
  late int _currentIndex; // index stages (0-based)
  ScenarioOption? _lastSelection;
  bool _showFeedback = false;
  final TextEditingController _reflectionController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _currentIndex = 0;
  }

  @override
  void dispose() {
    _reflectionController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final stage = widget.item.stages[_currentIndex];
    return Scaffold(
      backgroundColor: const Color(0xFFFFE7CE),
      appBar: AppBar(
        title: Text(widget.item.title),
        backgroundColor: const Color(0xFFFFE7CE),
        foregroundColor: const Color(0xFF7F55B1),
      ),
      body: Container(
        color: const Color(0xFFFFE7CE),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8),
            child: stage.isReflection ? _buildReflection(stage) : (_showFeedback ? _buildFeedback(stage) : _buildQuestion(stage)),
          ),
        ),
      ),
    );
  }

  Widget _buildQuestion(ScenarioStage stage) {
    final String imagePath = 'assets/images/scenario_illustration/${stage.illustrationFile}';
    return SingleChildScrollView(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const SizedBox(height: 8),
          Text(stage.narration, style: AppTheme.bodyLarge.copyWith(color: const Color(0xFF3F3F3F))),
          const SizedBox(height: 12),
          AspectRatio(
            aspectRatio: 16 / 9,
            child: ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: Image.asset(imagePath, fit: BoxFit.cover),
            ),
          ),
          const SizedBox(height: 12),
          Text(stage.question, style: AppTheme.headingMedium.copyWith(color: const Color(0xFF7F55B1))),
          const SizedBox(height: 12),
          ListView.separated(
            itemCount: stage.options.length,
            physics: const NeverScrollableScrollPhysics(),
            shrinkWrap: true,
            separatorBuilder: (_, __) => const SizedBox(height: 12),
            itemBuilder: (context, index) {
              final opt = stage.options[index];
              return _OptionTile(
                text: opt.answer,
                onTap: () {
                  setState(() {
                    _lastSelection = opt;
                    _showFeedback = true;
                  });
                },
              );
            },
          ),
          const SizedBox(height: 12),
        ],
      ),
    );
  }

  Widget _buildFeedback(ScenarioStage stage) {
    final String imagePath = 'assets/images/scenario_illustration/${stage.illustrationFile}';
    final bool hasNext = _lastSelection != null && _lastSelection!.nextStage != stage.stageNumber;
    return SingleChildScrollView(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const SizedBox(height: 8),
          Text('Pilihan jawabanmu adalah', style: AppTheme.headingMedium.copyWith(color: const Color(0xFF7F55B1))),
          const SizedBox(height: 12),
          if (_lastSelection != null) _ChoiceBubble(text: _lastSelection!.answer),
          const SizedBox(height: 16),
          Text(_lastSelection?.feedback ?? '', style: AppTheme.bodyLarge.copyWith(color: const Color(0xFF3F3F3F))),
          const SizedBox(height: 12),
          AspectRatio(
            aspectRatio: 16 / 9,
            child: ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: Image.asset(imagePath, fit: BoxFit.cover),
            ),
          ),
          const SizedBox(height: 12),
          if (hasNext)
            Row(
              children: [
                Expanded(
                  child: ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.white,
                      foregroundColor: const Color(0xFF7F55B1),
                      padding: const EdgeInsets.symmetric(vertical: 14),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                    ),
                    onPressed: () {
                      setState(() {
                        _showFeedback = false; // kembali ke pertanyaan yang sama
                      });
                    },
                    child: Text('Coba Lagi', style: AppTheme.buttonTextPurple),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF7F55B1),
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 14),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                    ),
                    onPressed: () {
                      if (_lastSelection == null) return;
                      final nextIdx = widget.item.stages.indexWhere((s) => s.stageNumber == _lastSelection!.nextStage);
                      setState(() {
                        _currentIndex = nextIdx >= 0 ? nextIdx : _currentIndex;
                        _showFeedback = false;
                      });
                    },
                    child: Text('Skenario Berikutnya  →', style: AppTheme.buttonText.copyWith(color: Colors.white)),
                  ),
                ),
              ],
            )
          else
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.white,
                  foregroundColor: const Color(0xFF7F55B1),
                  padding: const EdgeInsets.symmetric(vertical: 14),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                ),
                onPressed: () {
                  setState(() {
                    _showFeedback = false; // tetap di tahap yang sama untuk pilih ulang
                  });
                },
                child: Text('Coba Lagi', style: AppTheme.buttonTextPurple),
              ),
            ),
          const SizedBox(height: 12),
        ],
      ),
    );
  }

  Widget _buildReflection(ScenarioStage stage) {
    return SingleChildScrollView(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          if (_lastSelection != null) ...[
            Text('Pilihanmu sebelumnya:', style: AppTheme.bodyLarge.copyWith(color: const Color(0xFF3F3F3F))),
            const SizedBox(height: 8),
            _ChoiceBubble(text: _lastSelection!.answer),
            const SizedBox(height: 8),
            Text(_lastSelection!.feedback, style: AppTheme.bodyLarge.copyWith(color: const Color(0xFF3F3F3F))),
            const SizedBox(height: 16),
          ],
          // Tidak ada ilustrasi pada langkah refleksi (tahap ke-4)
          Text(stage.narration, style: AppTheme.bodyLarge.copyWith(color: const Color(0xFF3F3F3F))),
          const SizedBox(height: 12),
          Text(stage.question, style: AppTheme.headingMedium.copyWith(color: const Color(0xFF7F55B1))),
          const SizedBox(height: 8),
          Container(
            decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(12)),
            padding: const EdgeInsets.all(12),
            child: TextField(
              controller: _reflectionController,
              minLines: 4,
              maxLines: 8,
              decoration: const InputDecoration.collapsed(hintText: 'Ketik jawaban di sini...'),
              style: const TextStyle(color: Colors.black87),
            ),
          ),
          const SizedBox(height: 12),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton(
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.white,
                foregroundColor: const Color(0xFF7F55B1),
                padding: const EdgeInsets.symmetric(vertical: 14),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
              ),
              onPressed: () {
                Navigator.of(context).popUntil((route) => route.isFirst);
              },
              child: Text('Submit dan Kembali ke Homepage', style: AppTheme.buttonTextPurple),
            ),
          ),
          const SizedBox(height: 8),
        ],
      ),
    );
  }
}

class _OptionTile extends StatelessWidget {
  const _OptionTile({required this.text, required this.onTap});
  final String text;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 8, offset: const Offset(0, 4))],
        ),
        child: Row(
          children: [
            Expanded(child: Text(text, style: const TextStyle(fontSize: 16, color: Colors.black87, height: 1.4))),
            const Icon(Icons.chevron_right, color: Color(0xFF7F55B1)),
          ],
        ),
      ),
    );
  }
}

class _ChoiceBubble extends StatelessWidget {
  const _ChoiceBubble({required this.text});
  final String text;
  @override
  Widget build(BuildContext context) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFFF6E7FF),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: const Color(0xFFEDC7FF)),
      ),
      child: Text(text, style: const TextStyle(color: Color(0xFF7F55B1), fontWeight: FontWeight.w600)),
    );
  }
}
</file>

<file path="lib/features/screening/data/models/student_survey_list_response.dart">
class StudentSurveyListResponse {
  final bool success;
  final String message;
  final List<dynamic>? data;

  StudentSurveyListResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory StudentSurveyListResponse.fromJson(Map<String, dynamic> json) {
    return StudentSurveyListResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'] == null ? null : List<dynamic>.from(json['data'] as List),
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/screening/data/models/student_survey_submit_response.dart">
class StudentSurveySubmitResponse {
  final bool success;
  final String message;
  final Map<String, dynamic>? data;

  StudentSurveySubmitResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory StudentSurveySubmitResponse.fromJson(Map<String, dynamic> json) {
    return StudentSurveySubmitResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'] == null ? null : Map<String, dynamic>.from(json['data'] as Map),
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/screening/data/repositories/screening_repository.dart">
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/auth_header_provider.dart';
import '../models/student_survey_submit_response.dart';
import '../models/student_survey_list_response.dart';

class ScreeningRepository {
  final ApiClient apiClient;
  final AuthHeaderProvider auth;

  ScreeningRepository({required this.apiClient, required this.auth});

  /// POST /api/screenings/student-surveys/
  /// Submit student survey data. Pass asGuest=true for guest submissions.
  Future<StudentSurveySubmitResponse> submitStudentSurvey(
    Map<String, dynamic> data, {
    bool asGuest = true,
  }) async {
  final headers = await auth.buildHeaders(asGuest: asGuest);
    // [DEBUG]
    // ignore: avoid_print
    print('[DEBUG] submitStudentSurvey() payload=${data.keys.toList()} asGuest=$asGuest');

    final resp = await apiClient.post<Map<String, dynamic>>(
      '/api/screenings/student-surveys/',
      data,
      headers: headers,
      transform: (raw) => raw as Map<String, dynamic>,
    );

    // [DEBUG]
    // ignore: avoid_print
    print('[DEBUG] submitStudentSurvey() response keys=${resp.data.keys.toList()}');

    return StudentSurveySubmitResponse.fromJson(
      {'success': true, 'message': '', 'data': resp.data},
    );
  }

  /// GET /api/screenings/student-surveys/my/
  Future<StudentSurveyListResponse> getMySurveys({bool asGuest = false}) async {
  final headers = await auth.buildHeaders(asGuest: asGuest);
    // [DEBUG]
    // ignore: avoid_print
    print('[DEBUG] getMySurveys() asGuest=$asGuest');

    final resp = await apiClient.get<List<dynamic>>(
      '/api/screenings/student-surveys/my/',
      headers: headers,
      transform: (raw) => raw as List<dynamic>,
    );

    // [DEBUG]
    // ignore: avoid_print
    print('[DEBUG] getMySurveys() count=${resp.data.length}');

    return StudentSurveyListResponse.fromJson(
      {'success': true, 'message': '', 'data': resp.data},
    );
  }

  /// GET /api/screenings/student-surveys/teacher/list/
  Future<StudentSurveyListResponse> getTeacherSurveys({bool asGuest = false}) async {
  final headers = await auth.buildHeaders(asGuest: asGuest);
    // [DEBUG]
    // ignore: avoid_print
    print('[DEBUG] getTeacherSurveys() asGuest=$asGuest');

    final resp = await apiClient.get<List<dynamic>>(
      '/api/screenings/student-surveys/teacher/list/',
      headers: headers,
      transform: (raw) => raw as List<dynamic>,
    );

    // [DEBUG]
    // ignore: avoid_print
    print('[DEBUG] getTeacherSurveys() count=${resp.data.length}');

    return StudentSurveyListResponse.fromJson(
      {'success': true, 'message': '', 'data': resp.data},
    );
  }
}
</file>

<file path="lib/features/screening/presentation/controllers/student_survey_controller.dart">
// ignore_for_file: use_build_context_synchronously
import 'package:flutter/material.dart';
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/api_exception.dart';
import 'package:sikap/core/network/auth_header_provider.dart';
import 'package:sikap/features/screening/data/repositories/screening_repository.dart';

class StudentSurveyController {
  final ScreeningRepository repo;
  final BuildContext context;

  StudentSurveyController({required this.repo, required this.context});

  static StudentSurveyController withDefaults(BuildContext context) {
    final api = ApiClient();
    final auth = AuthHeaderProvider(
      loadUserToken: () async => null, // TODO: hook real token loader
      loadGuestToken: () async => null, // TODO: hook real guest token loader
    );
    final repo = ScreeningRepository(apiClient: api, auth: auth);
    return StudentSurveyController(repo: repo, context: context);
  }

  Future<void> submit(Map<String, dynamic> data, {bool asGuest = true}) async {
    try {
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI submitStudentSurvey called, dataKeys=${data.keys.toList()}');

      final resp = await repo.submitStudentSurvey(data, asGuest: asGuest);
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Survey berhasil dikirim')),
      );
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI submitStudentSurvey success, responseKeys=${resp.data?.keys.toList()}');
    } on ApiException catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(e.message)),
      );
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI submitStudentSurvey ApiException: ${e.message}');
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Gagal mengirim survey: $e')),
      );
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI submitStudentSurvey ERROR: $e');
    }
  }

  Future<List<dynamic>> loadMySurveys({bool asGuest = false}) async {
    try {
      final resp = await repo.getMySurveys(asGuest: asGuest);
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI loadMySurveys loaded=${resp.data?.length ?? 0}');
      return resp.data ?? [];
    } on ApiException catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(e.message)),
      );
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI loadMySurveys ApiException: ${e.message}');
      return [];
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Gagal memuat riwayat: $e')),
      );
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI loadMySurveys ERROR: $e');
      return [];
    }
  }

  Future<List<dynamic>> loadTeacherSurveys({bool asGuest = false}) async {
    try {
      final resp = await repo.getTeacherSurveys(asGuest: asGuest);
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI loadTeacherSurveys loaded=${resp.data?.length ?? 0}');
      return resp.data ?? [];
    } on ApiException catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(e.message)),
      );
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI loadTeacherSurveys ApiException: ${e.message}');
      return [];
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Gagal memuat daftar: $e')),
      );
      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] UI loadTeacherSurveys ERROR: $e');
      return [];
    }
  }
}
</file>

<file path="lib/features/screening/presentation/pages/student_survey_my_history_page.dart">
// ignore_for_file: use_build_context_synchronously
import 'package:flutter/material.dart';
import '../controllers/student_survey_controller.dart';

class StudentSurveyMyHistoryPage extends StatefulWidget {
  const StudentSurveyMyHistoryPage({super.key});

  @override
  State<StudentSurveyMyHistoryPage> createState() => _StudentSurveyMyHistoryPageState();
}

class _StudentSurveyMyHistoryPageState extends State<StudentSurveyMyHistoryPage> {
  late final StudentSurveyController _controller;
  bool _loading = true;
  List<dynamic> _items = const [];

  @override
  void initState() {
    super.initState();
    _controller = StudentSurveyController.withDefaults(context);
    _load();
  }

  Future<void> _load() async {
    setState(() => _loading = true);
    final data = await _controller.loadMySurveys();
    setState(() {
      _items = data;
      _loading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Riwayat Survei Saya')),
      body: _loading
          ? const Center(child: CircularProgressIndicator())
          : RefreshIndicator(
              onRefresh: _load,
              child: ListView.builder(
                itemCount: _items.length,
                itemBuilder: (context, index) {
                  final it = _items[index];
                  return ListTile(
                    title: Text('${it['title'] ?? 'Survey'}'),
                    subtitle: Text('${it['created_at'] ?? ''}'),
                  );
                },
              ),
            ),
    );
  }
}
</file>

<file path="lib/features/screening/presentation/pages/student_survey_submit_page.dart">
// ignore_for_file: use_build_context_synchronously
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:sikap/core/network/api_exception.dart';
import '../controllers/student_survey_controller.dart';

class StudentSurveySubmitPage extends StatefulWidget {
  const StudentSurveySubmitPage({super.key});

  @override
  State<StudentSurveySubmitPage> createState() => _StudentSurveySubmitPageState();
}

class _StudentSurveySubmitPageState extends State<StudentSurveySubmitPage> {
  late final StudentSurveyController _controller;
  final _formKey = GlobalKey<FormState>();
  final _jsonCtrl = TextEditingController(text: '{"answers": []}');
  bool _submitting = false;

  @override
  void initState() {
    super.initState();
    _controller = StudentSurveyController.withDefaults(context);
  }

  Future<void> _submit() async {
    if (_submitting) return;
    setState(() => _submitting = true);
    try {
      final text = _jsonCtrl.text.trim();
      final parsed = jsonDecode(text);
      if (parsed is! Map<String, dynamic>) {
        throw ApiException(message: 'Harap masukkan JSON berbentuk object');
      }
      await _controller.submit(parsed, asGuest: true);
    } on FormatException {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Format JSON tidak valid')),
      );
    } on ApiException catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(e.message)),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Gagal: $e')),
      );
    } finally {
      setState(() => _submitting = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Kirim Survei Siswa')),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Form(
          key: _formKey,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              const Text('Masukkan payload JSON (tanpa data dummy, gunakan data asli UI)'),
              const SizedBox(height: 8),
              Expanded(
                child: TextFormField(
                  controller: _jsonCtrl,
                  maxLines: null,
                  expands: true,
                  decoration: const InputDecoration(
                    border: OutlineInputBorder(),
                    hintText: '{"answers": [{"question_id": 1, "value": 3}]}'
                  ),
                ),
              ),
              const SizedBox(height: 12),
              ElevatedButton.icon(
                onPressed: _submitting ? null : _submit,
                icon: _submitting
                    ? const SizedBox(
                        height: 16,
                        width: 16,
                        child: CircularProgressIndicator(strokeWidth: 2),
                      )
                    : const Icon(Icons.send),
                label: const Text('Kirim'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/screening/presentation/pages/student_survey_teacher_list_page.dart">
// ignore_for_file: use_build_context_synchronously
import 'package:flutter/material.dart';
import '../controllers/student_survey_controller.dart';

class StudentSurveyTeacherListPage extends StatefulWidget {
  const StudentSurveyTeacherListPage({super.key});

  @override
  State<StudentSurveyTeacherListPage> createState() => _StudentSurveyTeacherListPageState();
}

class _StudentSurveyTeacherListPageState extends State<StudentSurveyTeacherListPage> {
  late final StudentSurveyController _controller;
  bool _loading = true;
  List<dynamic> _items = const [];

  @override
  void initState() {
    super.initState();
    _controller = StudentSurveyController.withDefaults(context);
    _load();
  }

  Future<void> _load() async {
    setState(() => _loading = true);
    final data = await _controller.loadTeacherSurveys();
    setState(() {
      _items = data;
      _loading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Daftar Survei Siswa')),
      body: _loading
          ? const Center(child: CircularProgressIndicator())
          : RefreshIndicator(
              onRefresh: _load,
              child: ListView.builder(
                itemCount: _items.length,
                itemBuilder: (context, index) {
                  final it = _items[index];
                  return ListTile(
                    title: Text('${it['student_name'] ?? it['title'] ?? 'Survey'}'),
                    subtitle: Text('${it['created_at'] ?? ''}'),
                  );
                },
              ),
            ),
    );
  }
}
</file>

<file path="lib/features/wellbeing_resources/presentation/pages/artikel_bullying_detail_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';

class ArtikelBullyingDetailPage extends StatelessWidget {
  const ArtikelBullyingDetailPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFF5E8D6),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: const BoxConstraints(maxWidth: 820),
            child: SingleChildScrollView(
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20.0, vertical: 16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Top bar
                    Row(
                      children: [
                        IconButton(
                          onPressed: () => Navigator.of(context).pop(),
                          icon: const Icon(Icons.arrow_back, color: Color(0xFF7F55B1)),
                        ),
                        const Spacer(),
                        IconButton(
                          onPressed: () {
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(content: Text('Fitur bagikan akan segera hadir')),
                            );
                          },
                          icon: const Icon(Icons.share, color: Color(0xFF7F55B1)),
                        ),
                      ],
                    ),
                    const SizedBox(height: 8),

                    // Title
                    const Text(
                      'Bukan Salahmu: Memahami Apa Itu Bullying dan Mengapa Itu Terjadi',
                      style: TextStyle(
                        fontSize: 28,
                        fontWeight: FontWeight.w900,
                        color: Color(0xFF7F55B1),
                        height: 1.25,
                        fontFamily: 'serif',
                      ),
                    ),
                    const SizedBox(height: 12),

                    const Text(
                      '15 Agustus 2025',
                      style: TextStyle(
                        fontSize: 12,
                        color: Color(0xFF7A6C57),
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                    const SizedBox(height: 12),

                    // Illustration card
                    ClipRRect(
                      borderRadius: BorderRadius.circular(12),
                      child: Container(
                        width: double.infinity,
                        color: const Color(0xFFF3D9BF),
                        padding: const EdgeInsets.all(16),
                        child: AspectRatio(
                          aspectRatio: 16 / 9,
                          child: SvgPicture.asset(
                            'assets/images/lapor_bullying.svg',
                            fit: BoxFit.contain,
                            allowDrawingOutsideViewBox: true,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),

                    // Author row
                    Row(
                      children: [
                        const CircleAvatar(
                          radius: 22,
                          backgroundImage: AssetImage('assets/icons/sikap_icon.jpg'),
                        ),
                        const SizedBox(width: 12),
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: const [
                            Text(
                              'Gianpiero Lambiase',
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.w700,
                                color: Color(0xFF3A2E24),
                              ),
                            ),
                            Text(
                              'Psikolog Anak',
                              style: TextStyle(
                                fontSize: 12,
                                color: Color(0xFF8A7B6A),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),

                    // Article content
                    const Text(
                      'Bullying, atau perundungan, adalah tindakan agresif dan berulang yang dilakukan oleh seseorang atau sekelompok orang kepada orang lain. Perilaku ini bukan hanya sekadar iseng atau candaan, karena tujuannya adalah untuk menyakiti atau membuat seseorang merasa tidak nyaman. Penting untuk diingat: apa pun alasannya, bullying tidak pernah menjadi kesalahan korban.',
                      style: TextStyle(fontSize: 14, height: 1.6, color: Colors.black87),
                    ),
                    const SizedBox(height: 16),

                    const Text(
                      'Apa yang Termasuk Bullying?',
                      style: TextStyle(fontSize: 16, fontWeight: FontWeight.w800, color: Colors.black87),
                    ),
                    const SizedBox(height: 8),

                    _Bullet(text: 'Verbal: Mengejek, menyebarkan gosip, atau memanggil nama yang tidak pantas.'),
                    _Bullet(text: 'Fisik: Mendorong, memukul, menendang, atau merusak barang.'),
                    _Bullet(text: 'Sosial: Mengucilkan dari kelompok atau menyebarkan rumor.'),
                    _Bullet(text: 'Siber: Mengirim pesan yang mengancam, menyebarkan foto memalukan, atau mengolok-olok di media sosial.'),

                    const SizedBox(height: 16),
                    const Text(
                      'Mengapa Bullying Terjadi?',
                      style: TextStyle(fontSize: 16, fontWeight: FontWeight.w800, color: Colors.black87),
                    ),
                    const SizedBox(height: 8),
                    const Text(
                      'Bullying bisa terjadi karena banyak faktor, seperti kebutuhan pelaku untuk merasa berkuasa, tekanan dari teman sebaya, atau masalah pribadi yang tidak terselesaikan. Apapun penyebabnya, bullying tidak bisa dibenarkan.',
                      style: TextStyle(fontSize: 14, height: 1.6, color: Colors.black87),
                    ),

                    const SizedBox(height: 16),
                    const Text(
                      'Apa yang Bisa Kamu Lakukan?',
                      style: TextStyle(fontSize: 16, fontWeight: FontWeight.w800, color: Colors.black87),
                    ),
                    const SizedBox(height: 8),
                    _Bullet(text: 'Jika kamu menjadi korban: ceritakan pada orang dewasa yang dipercaya.'),
                    _Bullet(text: 'Jika kamu melihat bullying: bantu dengan cara aman atau laporkan.'),
                    _Bullet(text: 'Simpan bukti jika terjadi secara online, dan hindari membalas.'),

                    const SizedBox(height: 32),
                    const Center(
                      child: Text(
                        '© 2025 SIKAP. All rights reserved.',
                        style: TextStyle(fontSize: 12, color: Colors.black54),
                      ),
                    ),
                    const SizedBox(height: 16),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _Bullet extends StatelessWidget {
  const _Bullet({required this.text});

  final String text;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text('•  ', style: TextStyle(fontSize: 14, height: 1.6)),
          Expanded(
            child: Text(
              text,
              style: const TextStyle(fontSize: 14, height: 1.6, color: Colors.black87),
            ),
          ),
        ],
      ),
    );
  }
}
</file>

<file path="lib/features/wellbeing_resources/presentation/pages/hubungi_bantuan_page.dart">
import 'package:flutter/material.dart';
import '../../../../core/theme/app_theme.dart';

class HubungiBantuanPage extends StatelessWidget {
  const HubungiBantuanPage({super.key});

  void _showComingSoon(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Segera Hadir'),
        content: const Text('Fitur ini akan segera hadir!'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('OK'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFF7F55B1), Color(0xFFFFDBB6)],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20.0),
            child: SingleChildScrollView(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const SizedBox(height: 40),
                  // Title
                  Text('Hubungi Bantuan', style: AppTheme.headingLarge),
                  const SizedBox(height: 8),
                  Text('Kamu tidak sendiri', style: AppTheme.bodyLarge),
                  const SizedBox(height: 24),

                  const _SectionTitle('Kontak Konselor Sekolah'),
                  const SizedBox(height: 12),

                  _CounselorCard(
                    name: 'Gianpiero Lambiase',
                    role: 'Konselor SMP 5 Monte Carlo',
                    schedule: 'Jadwal: Senin 15.00–16.40\nKamis 15.00–16.40',
                    avatarAsset: 'assets/icons/sikap_icon.jpg',
                    onChatTap: () => _showComingSoon(context),
                  ),
                  const SizedBox(height: 16),
                  _CounselorCard(
                    name: 'Laura Mueller',
                    role: 'Konselor SMP 5 Monte Carlo',
                    schedule: 'Jadwal: Selasa 08.00–11.40\nJumat 15.00–16.40',
                    avatarAsset: 'assets/icons/sikap_icon.jpg',
                    onChatTap: () => _showComingSoon(context),
                  ),

                  const SizedBox(height: 24),
                  const _SectionTitle('Layanan Nasional'),
                  const SizedBox(height: 12),

                  _NationalServiceCard(
                    title: 'Sahabat Perempuan\ndan Anak (SAPA)',
                    onCallTap: () => _showComingSoon(context),
                  ),

                  const SizedBox(height: 40),
                  const Padding(
                    padding: EdgeInsets.only(bottom: 20),
                    child: Center(
                      child: Text(
                        '© 2025 SIKAP. All rights reserved.',
                        textAlign: TextAlign.center,
                        style: TextStyle(fontSize: 12, color: Colors.white70),
                      ),
                    ),
                  ),
                  const SizedBox(height: 100),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _SectionTitle extends StatelessWidget {
  const _SectionTitle(this.text);
  final String text;

  @override
  Widget build(BuildContext context) {
    return Text(
      text,
      style: const TextStyle(
        fontSize: 16,
        fontWeight: FontWeight.w800,
        color: Colors.white,
      ),
    );
  }
}

class _CounselorCard extends StatelessWidget {
  const _CounselorCard({
    required this.name,
    required this.role,
    required this.schedule,
    required this.avatarAsset,
    required this.onChatTap,
  });

  final String name;
  final String role;
  final String schedule;
  final String avatarAsset;
  final VoidCallback onChatTap;

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFFF5F5DC),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.12),
            blurRadius: 18,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      padding: const EdgeInsets.all(16),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          CircleAvatar(radius: 32, backgroundImage: AssetImage(avatarAsset)),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  name,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w800,
                    color: Color(0xFF7F55B1),
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  role,
                  style: const TextStyle(fontSize: 12, color: Color(0xFF7F55B1)),
                ),
                const SizedBox(height: 8),
                Text(
                  schedule,
                  style: const TextStyle(fontSize: 12, color: Colors.black87, height: 1.4),
                ),
                const SizedBox(height: 12),
                Align(
                  alignment: Alignment.centerLeft,
                  child: ElevatedButton.icon(
                    onPressed: onChatTap,
                    icon: const Icon(Icons.chat_bubble_outline, size: 18),
                    label: const Text('Chat dengan WhatsApp'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFFFFDBB6),
                      foregroundColor: const Color(0xFF7F55B1),
                      elevation: 0,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _NationalServiceCard extends StatelessWidget {
  const _NationalServiceCard({required this.title, required this.onCallTap});
  final String title;
  final VoidCallback onCallTap;

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.12),
            blurRadius: 18,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      padding: const EdgeInsets.all(16),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const CircleAvatar(
            radius: 28,
            backgroundColor: Color(0xFFFFE0CC),
            child: Icon(Icons.call, color: Color(0xFF7F55B1)),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w800,
                    color: Color(0xFF7F55B1),
                    height: 1.3,
                  ),
                ),
                const SizedBox(height: 12),
                ElevatedButton(
                  onPressed: onCallTap,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFFFFDBB6),
                    foregroundColor: const Color(0xFF7F55B1),
                    elevation: 0,
                  ),
                  child: const Text('Telepon 129'),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
</file>

<file path="lib/core/network/api_exception.dart">
// lib/core/network/api_exception.dart
// Compat: sediakan getter statusCode agar kode lama tetap jalan.

class ApiException implements Exception {
  final String message;
  final int? code;
  final Map<String, dynamic>? errors;
  ApiException({required this.message, this.code, this.errors});

  int? get statusCode => code; // compat

  @override
  String toString() => "ApiException($code): $message";
}

class NetworkException extends ApiException {
  NetworkException(String msg) : super(message: msg);
}

class TimeoutExceptionApi extends ApiException {
  TimeoutExceptionApi(String msg) : super(message: msg);
}
</file>

<file path="lib/core/network/api_response.dart">
// lib/core/network/api_response.dart (FINAL)
class ApiResponse<T> {
  final T data;
  final int statusCode;
  final Map<String, String> headers;

  const ApiResponse(
    this.data, {
    this.statusCode = 200,
    this.headers = const {},
  });
}
</file>

<file path="lib/core/network/query.dart">
import 'api_env.dart';

Uri buildUri(String base, Map<String, dynamic> params) {
  final filtered = Map<String, dynamic>.from(params)
    ..removeWhere((k, v) => v == null || (v is String && v.isEmpty));

  final baseUri = Uri.parse(ApiEnv.baseUrl);
  final clean = base.startsWith('/') ? base.substring(1) : base;
  final basePath = baseUri.path.endsWith('/')
      ? baseUri.path
      : (baseUri.path.isEmpty ? '/' : '${baseUri.path}/');

  return baseUri.replace(
    path: '$basePath$clean',
    queryParameters: filtered.map((k, v) => MapEntry(k, '$v')),
  );
}
</file>

<file path="lib/core/theme/usage_examples.dart">
// Contoh penggunaan Google Fonts di berbagai komponen
// File ini hanya untuk referensi, tidak digunakan dalam aplikasi

import 'package:flutter/material.dart';
import 'app_theme.dart';

class UsageExamples {
  // Contoh 1: Homepage Title
  static Widget homepageTitle() {
    return Text(
      'Tempat untuk Didengar',
      style: AppTheme.headingLarge, // Abril Fatface, 32px, bold, white
    );
  }

  // Contoh 2: Feature Button
  static Widget featureButton() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppTheme.creamBackground,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Lapor Bullying',
            style: AppTheme.buttonText, // Roboto, 18px, bold, orange
          ),
          const SizedBox(height: 4),
          Text(
            'Identitas kamu terjaga',
            style: AppTheme.subtitle, // Roboto, 14px, dark grey
          ),
        ],
      ),
    );
  }

  // Contoh 3: Form Input
  static Widget formInput() {
    return TextFormField(
      decoration: InputDecoration(
        labelText: 'Username',
        labelStyle: AppTheme.bodyMedium, // Roboto, 14px, light grey
      ),
      style: AppTheme.bodyLarge, // Roboto, 16px, white
    );
  }

  // Contoh 4: Settings Button
  static Widget settingsButton() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppTheme.creamBackground,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Row(
        children: [
          Icon(
            Icons.settings,
            color: AppTheme.primaryPurple,
          ),
          const SizedBox(width: 16),
          Text(
            'Pengaturan',
            style: AppTheme.buttonTextPurple, // Roboto, 18px, bold, purple
          ),
        ],
      ),
    );
  }

  // Contoh 5: Card dengan berbagai text styles
  static Widget infoCard() {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'Informasi Penting',
              style: AppTheme.headingMedium, // Abril Fatface, 24px, bold, white
            ),
            const SizedBox(height: 8),
            Text(
              'Ini adalah informasi penting yang perlu diketahui pengguna.',
              style: AppTheme.bodyLarge, // Roboto, 16px, white
            ),
            const SizedBox(height: 4),
            Text(
              'Detail tambahan bisa ditulis di sini.',
              style: AppTheme.bodyMedium, // Roboto, 14px, light grey
            ),
          ],
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/accounts/data/repositories/accounts_repository.dart">
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/auth_header_provider.dart';

import '../models/accounts_create_response.dart';
import '../models/accounts_detail_response.dart';
import '../models/accounts_list_response.dart';
import '../models/accounts_model.dart';

class AccountsRepository {
  final ApiClient apiClient;
  final AuthHeaderProvider auth;

  AccountsRepository({required this.apiClient, required this.auth});

  Future<AccountsCreateResponse> createAccount(
      Map<String, dynamic> data) async {
  final headers = await auth.buildHeaders();
    final resp = await apiClient.post<Map<String, dynamic>>(
        '/api/accounts/register/', data,
        headers: headers, transform: (raw) => raw as Map<String, dynamic>);
    return AccountsCreateResponse.fromJson(
        {'success': true, 'message': '', 'data': resp.data});
  }

  Future<AccountsDetailResponse> getAccountDetail(String id) async {
  final headers = await auth.buildHeaders();
    final resp = await apiClient.get<Map<String, dynamic>>('/api/accounts/$id/',
        headers: headers, transform: (raw) => raw as Map<String, dynamic>);
    return AccountsDetailResponse.fromJson(
        {'success': true, 'message': '', 'data': resp.data});
  }

  Future<AccountsListResponse> getAccountsList() async {
  final headers = await auth.buildHeaders();
    final resp = await apiClient.get<List<dynamic>>('/api/accounts/',
        headers: headers, transform: (raw) => raw as List<dynamic>);
    return AccountsListResponse.fromJson(
        {'success': true, 'message': '', 'data': resp.data});
  }

  Future<AccountsModel> updateAccount(
      String id, Map<String, dynamic> data) async {
  final headers = await auth.buildHeaders();
    final resp = await apiClient.patch<Map<String, dynamic>>(
        '/api/accounts/$id/', data,
        headers: headers, transform: (raw) => raw as Map<String, dynamic>);
    return AccountsModel.fromJson(resp.data);
  }

  Future<bool> deleteAccount(String id) async {
  final headers = await auth.buildHeaders();
    await apiClient.patch('/api/accounts/$id/delete/', {}, headers: headers);
    return true;
  }
}
</file>

<file path="lib/features/accounts/domain/enums/accounts_status.dart">
enum AccountsStatus {
  active,
  inactive,
  suspended,
  pending,
}

extension AccountsStatusExtension on AccountsStatus {
  String get value {
    switch (this) {
      case AccountsStatus.active:
        return 'active';
      case AccountsStatus.inactive:
        return 'inactive';
      case AccountsStatus.suspended:
        return 'suspended';
      case AccountsStatus.pending:
        return 'pending';
    }
  }

  static AccountsStatus fromString(String value) {
    switch (value) {
      case 'active':
        return AccountsStatus.active;
      case 'inactive':
        return AccountsStatus.inactive;
      case 'suspended':
        return AccountsStatus.suspended;
      case 'pending':
        return AccountsStatus.pending;
      default:
        return AccountsStatus.pending;
    }
  }
}
</file>

<file path="lib/features/accounts/presentation/pages/accounts_form_page.dart">
import 'package:flutter/material.dart';
import '../../../../core/theme/app_theme.dart';

class AccountsFormPage extends StatefulWidget {
  final String? accountId; // null for create, not null for edit

  const AccountsFormPage({
    super.key,
    this.accountId,
  });

  @override
  State<AccountsFormPage> createState() => _AccountsFormPageState();
}

class _AccountsFormPageState extends State<AccountsFormPage> {
  final _formKey = GlobalKey<FormState>();
  final _usernameController = TextEditingController();
  final _emailController = TextEditingController();
  final _fullNameController = TextEditingController();

  @override
  void dispose() {
    _usernameController.dispose();
    _emailController.dispose();
    _fullNameController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(
          widget.accountId == null ? 'Tambah Akun' : 'Edit Akun',
          style: AppTheme.headingMedium,
        ),
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Form(
          key: _formKey,
          child: Column(
            children: [
              TextFormField(
                controller: _usernameController,
                decoration: const InputDecoration(
                  labelText: 'Username',
                  border: OutlineInputBorder(),
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Username tidak boleh kosong';
                  }
                  return null;
                },
              ),
              const SizedBox(height: 16),
              TextFormField(
                controller: _emailController,
                decoration: const InputDecoration(
                  labelText: 'Email',
                  border: OutlineInputBorder(),
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Email tidak boleh kosong';
                  }
                  return null;
                },
              ),
              const SizedBox(height: 16),
              TextFormField(
                controller: _fullNameController,
                decoration: const InputDecoration(
                  labelText: 'Nama Lengkap',
                  border: OutlineInputBorder(),
                ),
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () {
                  if (_formKey.currentState!.validate()) {
                    // TODO: Implement save logic
                  }
                },
                child: Text(widget.accountId == null ? 'Simpan' : 'Update'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/accounts/utils/accounts_validator.dart">
class AccountsValidator {
  static String? validateUsername(String? username) {
    if (username == null || username.isEmpty) {
      return 'Username tidak boleh kosong';
    }
    if (username.length < 3) {
      return 'Username minimal 3 karakter';
    }
    if (username.length > 20) {
      return 'Username maksimal 20 karakter';
    }
    if (!RegExp(r'^[a-zA-Z0-9_]+$').hasMatch(username)) {
      return 'Username hanya boleh mengandung huruf, angka, dan underscore';
    }
    return null;
  }

  static String? validateEmail(String? email) {
    if (email == null || email.isEmpty) {
      return 'Email tidak boleh kosong';
    }
    if (!RegExp(r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$').hasMatch(email)) {
      return 'Format email tidak valid';
    }
    return null;
  }

  static String? validatePassword(String? password) {
    if (password == null || password.isEmpty) {
      return 'Password tidak boleh kosong';
    }
    if (password.length < 8) {
      return 'Password minimal 8 karakter';
    }
    return null;
  }

  static String? validateFullName(String? fullName) {
    if (fullName != null && fullName.isNotEmpty && fullName.length < 2) {
      return 'Nama lengkap minimal 2 karakter';
    }
    return null;
  }
}
</file>

<file path="lib/features/authentication/presentation/pages/teacher_login_page.dart">
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import '../../../home/presentation/pages/home_teacher_page.dart';
import 'login_page.dart';

class TeacherLoginPage extends StatefulWidget {
  const TeacherLoginPage({super.key});

  @override
  State<TeacherLoginPage> createState() => _TeacherLoginPageState();
}

class _TeacherLoginPageState extends State<TeacherLoginPage> {
  final TextEditingController _usernameController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();

  @override
  void dispose() {
    _usernameController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: SafeArea(
        child: SingleChildScrollView(
          child: Column(
            children: [
              // Upper white section with logo
              Container(
                width: double.infinity,
                color: Colors.white,
                padding: const EdgeInsets.symmetric(vertical: 40, horizontal: 24),
                child: Column(
                  children: [
                    // Logo
                    Container(
                      width: 180,
                      height: 180,
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        border: Border.all(
                          color: const Color(0xFFFFDBB6),
                          width: 4,
                        ),
                      ),
                      child: ClipOval(
                        child: Image.asset(
                          'assets/icons/sikap_icon.jpg',
                          fit: BoxFit.cover,
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    // SIKAP text
                    Text(
                      'SIKAP',
                      style: GoogleFonts.abrilFatface(
                        fontSize: 32,
                        fontWeight: FontWeight.bold,
                        color: const Color(0xFF4A4A7D),
                      ),
                    ),
                    const SizedBox(height: 8),
                    // Subtitle
                    Text(
                      'Sistem Informasi Kelola Asa dan Pelaporan',
                      textAlign: TextAlign.center,
                      style: GoogleFonts.roboto(
                        fontSize: 12,
                        color: const Color(0xFFE07B8A),
                        letterSpacing: 0.5,
                      ),
                    ),
                  ],
                ),
              ),
              // Lower blue section with form
              Container(
                width: double.infinity,
                decoration: const BoxDecoration(
                  color: Color(0xFF0066CC),
                ),
                child: Column(
                  children: [
                    const SizedBox(height: 32),
                    // Toggle ke Siswa dipindah ke atas
                    Center(
                      child: ElevatedButton(
                        onPressed: () {
                          Navigator.pushReplacement(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const LoginPage(),
                            ),
                          );
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFB678FF),
                          foregroundColor: Colors.white,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          elevation: 0,
                          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                        ),
                        child: Text(
                          'Login sebagai\nSiswa',
                          textAlign: TextAlign.center,
                          style: GoogleFonts.roboto(
                            fontSize: 16,
                            fontWeight: FontWeight.w700,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    // Selamat Datang text
                    Text(
                      'Selamat Datang',
                      style: GoogleFonts.abrilFatface(
                        fontSize: 32,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                    const SizedBox(height: 8),
                    // Keterangan role aktif
                    Text(
                      'Anda sedang login sebagai guru/kepala sekolah',
                      style: GoogleFonts.roboto(
                        fontSize: 14,
                        color: Colors.white70,
                        fontWeight: FontWeight.w400,
                      ),
                    ),
                    const SizedBox(height: 24),
                    // Form fields
                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          
                          // Username
                          Text(
                            'Username',
                            style: GoogleFonts.roboto(
                              fontSize: 16,
                              color: Colors.white,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 8),
                          TextField(
                            controller: _usernameController,
                            decoration: InputDecoration(
                              filled: true,
                              fillColor: Colors.white,
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                                borderSide: BorderSide.none,
                              ),
                              contentPadding: const EdgeInsets.symmetric(
                                horizontal: 16,
                                vertical: 16,
                              ),
                            ),
                            style: GoogleFonts.roboto(
                              fontSize: 16,
                              color: Colors.black87,
                            ),
                          ),
                          const SizedBox(height: 16),
                          // Password
                          Text(
                            'Password',
                            style: GoogleFonts.roboto(
                              fontSize: 16,
                              color: Colors.white,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 8),
                          TextField(
                            controller: _passwordController,
                            obscureText: true,
                            decoration: InputDecoration(
                              filled: true,
                              fillColor: Colors.white,
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                                borderSide: BorderSide.none,
                              ),
                              contentPadding: const EdgeInsets.symmetric(
                                horizontal: 16,
                                vertical: 16,
                              ),
                            ),
                            style: GoogleFonts.roboto(
                              fontSize: 16,
                              color: Colors.black87,
                            ),
                          ),
                          const SizedBox(height: 32),
                          // Login button
                          SizedBox(
                            width: double.infinity,
                            height: 54,
                            child: ElevatedButton(
                              onPressed: () {
                                // Navigate to HomeTeacherPage
                                Navigator.pushReplacement(
                                  context,
                                  MaterialPageRoute(
                                    builder: (context) => const HomeTeacherPage(),
                                  ),
                                );
                              },
                              style: ElevatedButton.styleFrom(
                                backgroundColor: const Color(0xFFFFDBB6),
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                elevation: 0,
                              ),
                              child: Text(
                                'Login',
                                style: GoogleFonts.roboto(
                                  fontSize: 18,
                                  fontWeight: FontWeight.bold,
                                  color: const Color(0xFF0066CC),
                                ),
                              ),
                            ),
                          ),
                          const SizedBox(height: 40),
                          // Copyright text
                          Center(
                            child: Text(
                              '© 2025 SIKAP.  All rights reserved.',
                              style: GoogleFonts.roboto(
                                fontSize: 12,
                                color: Colors.white70,
                              ),
                            ),
                          ),
                          const SizedBox(height: 24),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/bullying/data/models/bullying_create_response.dart">
class BullyingCreateResponse {
  final bool success;
  final String message;
  final Map<String, dynamic>? data;

  BullyingCreateResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory BullyingCreateResponse.fromJson(Map<String, dynamic> json) {
    return BullyingCreateResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/bullying/data/models/bullying_detail_response.dart">
class BullyingDetailResponse {
  final bool success;
  final String message;
  final Map<String, dynamic>? data;

  BullyingDetailResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory BullyingDetailResponse.fromJson(Map<String, dynamic> json) {
    return BullyingDetailResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/bullying/data/models/bullying_list_response.dart">
class BullyingListResponse {
  final bool success;
  final String message;
  final List<dynamic>? data;

  BullyingListResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory BullyingListResponse.fromJson(Map<String, dynamic> json) {
    return BullyingListResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/bullying/data/models/bullying_model.dart">
class BullyingModel {
  final String id;
  final String title;
  final String description;
  final String type;
  final String severity;
  final String status;
  final String reporterId;
  final String? targetId;
  final DateTime createdAt;
  final DateTime? updatedAt;

  BullyingModel({
    required this.id,
    required this.title,
    required this.description,
    required this.type,
    required this.severity,
    required this.status,
    required this.reporterId,
    this.targetId,
    required this.createdAt,
    this.updatedAt,
  });

  factory BullyingModel.fromJson(Map<String, dynamic> json) {
    return BullyingModel(
      id: json['id'] ?? '',
      title: json['title'] ?? '',
      description: json['description'] ?? '',
      type: json['type'] ?? '',
      severity: json['severity'] ?? '',
      status: json['status'] ?? '',
      reporterId: json['reporter_id'] ?? '',
      targetId: json['target_id'],
      createdAt: DateTime.parse(json['created_at'] ?? DateTime.now().toIso8601String()),
      updatedAt: json['updated_at'] != null ? DateTime.parse(json['updated_at']) : null,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'title': title,
      'description': description,
      'type': type,
      'severity': severity,
      'status': status,
      'reporter_id': reporterId,
      'target_id': targetId,
      'created_at': createdAt.toIso8601String(),
      'updated_at': updatedAt?.toIso8601String(),
    };
  }
}
</file>

<file path="lib/features/bullying/domain/entities/bullying_entity.dart">
class BullyingEntity {
  final String id;
  final String title;
  final String description;
  final String type;
  final String severity;
  final String status;
  final String reporterId;
  final String? targetId;
  final DateTime createdAt;
  final DateTime? updatedAt;

  BullyingEntity({
    required this.id,
    required this.title,
    required this.description,
    required this.type,
    required this.severity,
    required this.status,
    required this.reporterId,
    this.targetId,
    required this.createdAt,
    this.updatedAt,
  });
}
</file>

<file path="lib/features/bullying/domain/enums/bullying_severity.dart">
enum BullyingSeverity {
  low,
  medium,
  high,
  critical,
}

extension BullyingSeverityExtension on BullyingSeverity {
  String get value {
    switch (this) {
      case BullyingSeverity.low:
        return 'low';
      case BullyingSeverity.medium:
        return 'medium';
      case BullyingSeverity.high:
        return 'high';
      case BullyingSeverity.critical:
        return 'critical';
    }
  }

  String get displayName {
    switch (this) {
      case BullyingSeverity.low:
        return 'Rendah';
      case BullyingSeverity.medium:
        return 'Sedang';
      case BullyingSeverity.high:
        return 'Tinggi';
      case BullyingSeverity.critical:
        return 'Kritis';
    }
  }

  static BullyingSeverity fromString(String value) {
    switch (value) {
      case 'low':
        return BullyingSeverity.low;
      case 'medium':
        return BullyingSeverity.medium;
      case 'high':
        return BullyingSeverity.high;
      case 'critical':
        return BullyingSeverity.critical;
      default:
        return BullyingSeverity.medium;
    }
  }
}
</file>

<file path="lib/features/bullying/domain/enums/bullying_type.dart">
enum BullyingType {
  verbal,
  physical,
  cyber,
  social,
  sexual,
  other,
}

extension BullyingTypeExtension on BullyingType {
  String get value {
    switch (this) {
      case BullyingType.verbal:
        return 'verbal';
      case BullyingType.physical:
        return 'physical';
      case BullyingType.cyber:
        return 'cyber';
      case BullyingType.social:
        return 'social';
      case BullyingType.sexual:
        return 'sexual';
      case BullyingType.other:
        return 'other';
    }
  }

  String get displayName {
    switch (this) {
      case BullyingType.verbal:
        return 'Verbal';
      case BullyingType.physical:
        return 'Fisik';
      case BullyingType.cyber:
        return 'Cyber';
      case BullyingType.social:
        return 'Sosial';
      case BullyingType.sexual:
        return 'Seksual';
      case BullyingType.other:
        return 'Lainnya';
    }
  }

  static BullyingType fromString(String value) {
    switch (value) {
      case 'verbal':
        return BullyingType.verbal;
      case 'physical':
        return BullyingType.physical;
      case 'cyber':
        return BullyingType.cyber;
      case 'social':
        return BullyingType.social;
      case 'sexual':
        return BullyingType.sexual;
      case 'other':
        return BullyingType.other;
      default:
        return BullyingType.other;
    }
  }
}
</file>

<file path="lib/features/bullying/utils/bullying_validator.dart">
class BullyingValidator {
  static String? validateTitle(String? title) {
    if (title == null || title.isEmpty) {
      return 'Judul tidak boleh kosong';
    }
    if (title.length < 5) {
      return 'Judul minimal 5 karakter';
    }
    if (title.length > 100) {
      return 'Judul maksimal 100 karakter';
    }
    return null;
  }

  static String? validateDescription(String? description) {
    if (description == null || description.isEmpty) {
      return 'Deskripsi tidak boleh kosong';
    }
    if (description.length < 10) {
      return 'Deskripsi minimal 10 karakter';
    }
    if (description.length > 1000) {
      return 'Deskripsi maksimal 1000 karakter';
    }
    return null;
  }

  static String? validateType(String? type) {
    if (type == null || type.isEmpty) {
      return 'Jenis bullying harus dipilih';
    }
    return null;
  }

  static String? validateSeverity(String? severity) {
    if (severity == null || severity.isEmpty) {
      return 'Tingkat keparahan harus dipilih';
    }
    return null;
  }
}
</file>

<file path="lib/features/cases/presentation/pages/case_confirmation_page.dart">
import 'package:flutter/material.dart';

class CaseConfirmationPage extends StatefulWidget {
  const CaseConfirmationPage({super.key, required this.caseTitle, required this.action});

  final String caseTitle;
  final String action; // 'proses' or 'tolak'

  @override
  State<CaseConfirmationPage> createState() => _CaseConfirmationPageState();
}

class _CaseConfirmationPageState extends State<CaseConfirmationPage> {
  final TextEditingController _messageController = TextEditingController();

  @override
  void dispose() {
    _messageController.dispose();
    super.dispose();
  }

  Future<void> _confirm(String action) async {
    final verb = action == 'tolak' ? 'menolak' : 'memproses';
    final result = await showDialog<bool>(
      context: context,
      builder: (context) {
        return AlertDialog(
          title: const Text('Konfirmasi'),
          content: Text('Apakah anda yakin ingin $verb kasus ini?'),
          actions: [
            TextButton(onPressed: () => Navigator.pop(context, false), child: const Text('Batal')),
            ElevatedButton(onPressed: () => Navigator.pop(context, true), child: const Text('Ya')),
          ],
        );
      },
    );
    if (!mounted) return;
    if (result == true) {
      // Di sini nantinya bisa dipanggil API. Untuk sekarang, hanya kembali.
      Navigator.of(context).pop({
        'action': action,
        'message': _messageController.text,
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final bool isReject = widget.action == 'tolak';
    final String labelText = isReject ? 'Pesan penolakan' : 'Pesan pemrosesan';
    final String hintText = isReject
        ? 'Tulis alasan penolakan atau instruksi lanjutan...'
        : 'Tulis pesan pemrosesan atau langkah tindak lanjut...';
    return Scaffold(
      appBar: AppBar(
        title: const Text('Konfirmasi Kasus'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      body: Container(
        color: const Color(0xFF7F55B1),
        child: SafeArea(
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Container(
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(color: Colors.black.withValues(alpha: 0.12), blurRadius: 12, offset: const Offset(0, 4)),
                ],
              ),
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(widget.caseTitle, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w800)),
                  const SizedBox(height: 12),
                  Text(labelText),
                  const SizedBox(height: 8),
                  TextField(
                    controller: _messageController,
                    maxLines: 6,
                    style: const TextStyle(color: Colors.black),
                    decoration: InputDecoration(
                      hintText: hintText,
                      border: const OutlineInputBorder(),
                    ),
                  ),
                  const SizedBox(height: 16),
                  if (isReject)
                    SizedBox(
                      width: double.infinity,
                      child: OutlinedButton(
                        style: OutlinedButton.styleFrom(foregroundColor: Colors.red, side: const BorderSide(color: Colors.red)),
                        onPressed: () => _confirm('tolak'),
                        child: const Text('Tolak'),
                      ),
                    )
                  else
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(backgroundColor: Colors.green, foregroundColor: Colors.white),
                        onPressed: () => _confirm('proses'),
                        child: const Text('Proses'),
                      ),
                    ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/cases/presentation/pages/case_detail_page.dart">
import 'package:flutter/material.dart';
import 'case_confirmation_page.dart';

class CaseDetailPage extends StatelessWidget {
  const CaseDetailPage({
    super.key,
    required this.title,
    required this.status,
    required this.createdAt,
    required this.category,
    required this.description,
    required this.evidences,
    required this.anonymous,
    required this.confirmTruth,
  });

  final String title;
  final String status;
  final DateTime createdAt;
  final String category; // e.g., "Secara verbal"
  final String description;
  final List<String> evidences; // simple labels for now
  final bool anonymous;
  final bool confirmTruth;

  Color get statusColor {
    switch (status) {
      case 'Baru':
        return const Color(0xFF2196F3);
      case 'Diproses':
        return const Color(0xFFFF9800);
      case 'Selesai':
        return const Color(0xFF2E7D32);
      default:
        return Colors.grey;
    }
  }

  static String _formatDate(DateTime dt) {
    String two(int n) => n.toString().padLeft(2, '0');
    return '${dt.year}-${two(dt.month)}-${two(dt.day)} ${two(dt.hour)}:${two(dt.minute)}:${two(dt.second)}';
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Detail Kasus'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      body: Container(
        color: const Color(0xFF7F55B1),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              children: [
                Expanded(
                  child: SingleChildScrollView(
                    child: Container(
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(color: Colors.black.withValues(alpha: 0.12), blurRadius: 12, offset: const Offset(0, 4)),
                        ],
                      ),
                      padding: const EdgeInsets.all(16),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          // Status
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                            decoration: BoxDecoration(color: statusColor.withValues(alpha: 0.15), borderRadius: BorderRadius.circular(20)),
                            child: Text(status, style: TextStyle(color: statusColor, fontWeight: FontWeight.w700, fontSize: 12)),
                          ),
                          const SizedBox(height: 8),
                          // Title
                          Text(title, style: const TextStyle(fontSize: 20, fontWeight: FontWeight.w800, color: Colors.black87)),
                          const SizedBox(height: 12),
                          // Created at
                          Row(
                            children: [
                              const Icon(Icons.edit_calendar, size: 18, color: Colors.black45),
                              const SizedBox(width: 8),
                              Text(_formatDate(createdAt), style: const TextStyle(color: Colors.black45)),
                            ],
                          ),
                          const Divider(height: 32),
                          // Category (Step 1)
                          const Text('Kategori Bullying', style: TextStyle(fontWeight: FontWeight.w700, color: Colors.black87)),
                          const SizedBox(height: 8),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                            decoration: BoxDecoration(
                              color: const Color(0xFFFFE4B5),
                              borderRadius: BorderRadius.circular(8),
                              boxShadow: [
                                BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 2, offset: const Offset(0, 1)),
                              ],
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                const Icon(Icons.record_voice_over, color: Color(0xFF7F55B1)),
                                const SizedBox(width: 8),
                                Text(category, style: const TextStyle(color: Colors.black87)),
                              ],
                            ),
                          ),
                          const SizedBox(height: 16),
                          // Description (Step 2)
                          const Text('Penjelasan', style: TextStyle(fontWeight: FontWeight.w700, color: Colors.black87)),
                          const SizedBox(height: 8),
                          Text(description.isEmpty ? '-' : description),
                          const SizedBox(height: 16),
                          // Evidences (Step 3)
                          const Text('Bukti', style: TextStyle(fontWeight: FontWeight.w700, color: Colors.black87)),
                          const SizedBox(height: 8),
                          if (evidences.isEmpty)
                            const Text('-', style: TextStyle(color: Colors.black54))
                          else
                            Column(
                              children: evidences
                                  .map((e) => Padding(
                                        padding: const EdgeInsets.only(bottom: 8),
                                        child: Container(
                                          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 14),
                                          decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(12), boxShadow: [
                                            BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 4, offset: const Offset(0, 2)),
                                          ]),
                                          child: Row(
                                            children: [
                                              const Icon(Icons.insert_drive_file, color: Color(0xFF7F55B1)),
                                              const SizedBox(width: 8),
                                              Expanded(child: Text(e)),
                                            ],
                                          ),
                                        ),
                                      ))
                                  .toList(),
                            ),
                          const SizedBox(height: 8),
                        ],
                      ),
                    ),
                  ),
                ),
                Row(
                  children: [
                    Expanded(
                      child: OutlinedButton(
                        style: OutlinedButton.styleFrom(foregroundColor: Colors.white, side: const BorderSide(color: Colors.white)),
                        onPressed: () async {
                          final result = await Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => CaseConfirmationPage(caseTitle: title, action: 'tolak'),
                            ),
                          );
                          if (!context.mounted) return;
                          if (result != null) {
                            Navigator.of(context).pop(result);
                          }
                        },
                        child: const Text('Tolak'),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFFB678FF), foregroundColor: Colors.white),
                        onPressed: () async {
                          final result = await Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => CaseConfirmationPage(caseTitle: title, action: 'proses'),
                            ),
                          );
                          if (!context.mounted) return;
                          if (result != null) {
                            Navigator.of(context).pop(result);
                          }
                        },
                        child: const Text('Proses', style: TextStyle(color: Colors.white)),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/dashboard/presentation/dashboard_global.dart">
import 'package:flutter/material.dart';

class DashboardGlobalPage extends StatefulWidget {
  const DashboardGlobalPage({super.key});

  @override
  State<DashboardGlobalPage> createState() => _DashboardGlobalPageState();
}

class _DashboardGlobalPageState extends State<DashboardGlobalPage> {
  final List<_Report> _allReports = _mockReports();

  DateTimeRange? _dateRange;
  final Set<String> _statusFilter = {'Baru', 'Diproses', 'Selesai'};
  final Set<String> _categoryFilter = {'Fisik', 'Verbal', 'Cyber', 'Sosial', 'Lainnya'};
  String _anonymousFilter = 'Semua'; // 'Semua' | 'Ya' | 'Tidak'
  String _evidenceFilter = 'Semua'; // 'Semua' | 'Ya' | 'Tidak'
  String _granularity = 'Harian'; // 'Harian' | 'Mingguan'

  @override
  void initState() {
    super.initState();
    final now = DateTime.now();
    _dateRange = DateTimeRange(start: now.subtract(const Duration(days: 29)), end: now);
  }

  List<_Report> get _filtered {
    final range = _dateRange;
    return _allReports.where((r) {
      final inDate = range == null || (r.createdAt.isAfter(range.start.subtract(const Duration(days: 1))) && r.createdAt.isBefore(range.end.add(const Duration(days: 1))));
      final inStatus = _statusFilter.contains(r.status);
      final inCategory = _categoryFilter.contains(r.category);
      final inAnon = _anonymousFilter == 'Semua' || (_anonymousFilter == 'Ya' ? r.anonymous : !r.anonymous);
      final inEvidence = _evidenceFilter == 'Semua' || (_evidenceFilter == 'Ya' ? r.evidenceCount > 0 : r.evidenceCount == 0);
      return inDate && inStatus && inCategory && inAnon && inEvidence;
    }).toList();
  }

  // KPI calculations
  int get _total => _filtered.length;
  int get _baru => _filtered.where((r) => r.status == 'Baru').length;
  int get _diproses => _filtered.where((r) => r.status == 'Diproses').length;
  int get _selesai => _filtered.where((r) => r.status == 'Selesai').length;
  int get _backlog => _baru + _diproses;
  double get _rasioSelesai => _total == 0 ? 0 : _selesai / _total;
  double get _pctEvidence => _total == 0 ? 0 : _filtered.where((r) => r.evidenceCount > 0).length / _total;

  // Effectiveness
  Duration? get _avgResponseTime {
    final list = _filtered.where((r) => r.firstHandledAt != null).map((r) => r.firstHandledAt!.difference(r.createdAt)).toList();
    if (list.isEmpty) return null;
    final sumMs = list.fold<int>(0, (acc, d) => acc + d.inMilliseconds);
    return Duration(milliseconds: (sumMs / list.length).round());
  }

  Duration? get _avgResolutionTime {
    final list = _filtered.where((r) => r.resolvedAt != null).map((r) => r.resolvedAt!.difference(r.createdAt)).toList();
    if (list.isEmpty) return null;
    final sumMs = list.fold<int>(0, (acc, d) => acc + d.inMilliseconds);
    return Duration(milliseconds: (sumMs / list.length).round());
  }

  // Trend data and growth
  Map<String, List<_Point>> get _trendData {
    final range = _dateRange;
    if (range == null) {
      return {'Masuk': const [], 'Selesai': const []};
    }
    final spanDays = range.end.difference(range.start).inDays + 1;
    final bucketCount = _granularity == 'Harian' ? spanDays : (spanDays / 7).ceil();

    List<_Point> buildSeries(bool completed) {
      final List<_Point> points = [];
      for (int i = 0; i < bucketCount; i++) {
        DateTime start = _granularity == 'Harian' ? range.start.add(Duration(days: i)) : range.start.add(Duration(days: i * 7));
        DateTime end = _granularity == 'Harian' ? start : start.add(const Duration(days: 6));
        int count;
        if (!completed) {
          count = _filtered.where((r) => !r.createdAt.isBefore(start) && !r.createdAt.isAfter(end)).length;
        } else {
          count = _filtered.where((r) => r.resolvedAt != null && !r.resolvedAt!.isBefore(start) && !r.resolvedAt!.isAfter(end)).length;
        }
        points.add(_Point(x: i.toDouble(), y: count.toDouble()));
      }
      return points;
    }

    return {
      'Masuk': buildSeries(false),
      'Selesai': buildSeries(true),
    };
  }

  double get _growthVsPrev {
    final range = _dateRange;
    if (range == null) return 0;
    final length = range.end.difference(range.start).inDays + 1;
    final prevStart = range.start.subtract(Duration(days: length));
    final prevEnd = range.start.subtract(const Duration(days: 1));
    final curr = _allReports.where((r) => !r.createdAt.isBefore(range.start) && !r.createdAt.isAfter(range.end)).length;
    final prev = _allReports.where((r) => !r.createdAt.isBefore(prevStart) && !r.createdAt.isAfter(prevEnd)).length;
    if (prev == 0) return curr == 0 ? 0 : 1.0;
    return (curr - prev) / prev;
  }

  Map<String, int> get _categoryCounts {
    final map = <String, int>{'Fisik': 0, 'Verbal': 0, 'Cyber': 0, 'Sosial': 0, 'Lainnya': 0};
    for (final r in _filtered) {
      map[r.category] = (map[r.category] ?? 0) + 1;
    }
    return map;
  }

  @override
  Widget build(BuildContext context) {
    final trend = _trendData;
    return Scaffold(
      appBar: AppBar(
        title: const Text('Dasbor Bullying'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFF7F55B1), Color(0xFFFFDBB6)],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: SingleChildScrollView(
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _filtersBar(context),
                  const SizedBox(height: 16),
                  _kpiGrid(),
                  const SizedBox(height: 16),
                  _trendCard(trend),
                  const SizedBox(height: 16),
                  _distributionRow(),
                  const SizedBox(height: 16),
                  _effectivenessCard(),
                  const SizedBox(height: 8),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _filtersBar(BuildContext context) {
    String rangeLabel() {
      if (_dateRange == null) return 'Semua waktu';
      final s = _dateRange!.start;
      final e = _dateRange!.end;
      String two(int n) => n.toString().padLeft(2, '0');
      String d(DateTime dt) => '${dt.year}-${two(dt.month)}-${two(dt.day)}';
      return '${d(s)} s/d ${d(e)}';
    }

    return Row(
      children: [
        Expanded(child: _pillButton(icon: Icons.date_range, label: rangeLabel(), onTap: _pickDateRange)),
        const SizedBox(width: 12),
        Expanded(child: _pillButton(icon: Icons.filter_list, label: 'Filter', onTap: _openFiltersDialog)),
      ],
    );
  }

  Widget _kpiGrid() {
    final items = [
      _KpiItem(title: 'Total', value: '$_total'),
      _KpiItem(title: 'Baru', value: '$_baru'),
      _KpiItem(title: 'Diproses', value: '$_diproses'),
      _KpiItem(title: 'Selesai', value: '$_selesai'),
      _KpiItem(title: 'Backlog', value: '$_backlog'),
      _KpiItem(title: 'Rasio Selesai', value: '${(_rasioSelesai * 100).toStringAsFixed(0)}%'),
      _KpiItem(title: '% dgn Bukti', value: '${(_pctEvidence * 100).toStringAsFixed(0)}%'),
    ];
    return _card(
      child: GridView.count(
        crossAxisCount: 2,
        mainAxisSpacing: 12,
        crossAxisSpacing: 12,
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        children: items.map((i) => _kpiTile(i)).toList(),
      ),
    );
  }

  Widget _trendCard(Map<String, List<_Point>> trend) {
    final growth = _growthVsPrev;
    final growthText = '${(growth * 100).abs().toStringAsFixed(0)}%';
    final growthIcon = growth >= 0 ? Icons.arrow_upward : Icons.arrow_downward;
    final growthColor = growth >= 0 ? const Color(0xFF2E7D32) : const Color(0xFFB00020);
    return _card(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              const Text('Tren Waktu', style: TextStyle(fontWeight: FontWeight.w800)),
              const Spacer(),
              _segmented(
                options: const ['Harian', 'Mingguan'],
                value: _granularity,
                onChanged: (v) => setState(() => _granularity = v),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Row(
            children: [
              Icon(growthIcon, size: 16, color: growthColor),
              const SizedBox(width: 4),
              Text('Pertumbuhan vs periode sebelumnya: $growthText', style: TextStyle(color: growthColor)),
            ],
          ),
          const SizedBox(height: 12),
          SizedBox(
            height: 160,
            width: double.infinity,
            child: _LineChart(series: trend, lineColors: const [Color(0xFF2196F3), Color(0xFF2E7D32)]),
          ),
          const SizedBox(height: 4),
          Row(
            children: const [
              _LegendDot(color: Color(0xFF2196F3), label: 'Masuk'),
              SizedBox(width: 12),
              _LegendDot(color: Color(0xFF2E7D32), label: 'Selesai'),
            ],
          ),
        ],
      ),
    );
  }

  Widget _distributionRow() {
    final statusMap = {
      'Baru': _baru,
      'Diproses': _diproses,
      'Selesai': _selesai,
    };
    final categoryMap = _categoryCounts;
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(
          child: _card(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('Distribusi Status', style: TextStyle(fontWeight: FontWeight.w800)),
                const SizedBox(height: 12),
                SizedBox(height: 180, child: _DonutChart(data: statusMap, colors: const {
                  'Baru': Color(0xFF2196F3),
                  'Diproses': Color(0xFFFF9800),
                  'Selesai': Color(0xFF2E7D32),
                })),
              ],
            ),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: _card(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('Distribusi Kategori', style: TextStyle(fontWeight: FontWeight.w800)),
                const SizedBox(height: 12),
                ...categoryMap.entries.map((e) => _barRow(label: e.key, value: e.value, maxValue: categoryMap.values.isEmpty ? 1 : (categoryMap.values.reduce((a, b) => a > b ? a : b)))),
              ],
            ),
          ),
        ),
      ],
    );
  }

  Widget _effectivenessCard() {
    String fmt(Duration? d) {
      if (d == null) return '-';
      if (d.inHours < 48) return '${d.inHours} jam';
      return '${(d.inHours / 24).toStringAsFixed(1)} hari';
    }
    return _card(
      child: Row(
        children: [
          Expanded(child: _metricTile(title: 'Rata-rata respon awal', value: fmt(_avgResponseTime))),
          const SizedBox(width: 12),
          Expanded(child: _metricTile(title: 'Rata-rata penyelesaian', value: fmt(_avgResolutionTime))),
        ],
      ),
    );
  }

  // UI helpers
  Widget _pillButton({required IconData icon, required String label, required VoidCallback onTap}) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        height: 44,
        decoration: BoxDecoration(
          color: Colors.white.withValues(alpha: 0.9),
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 8, offset: const Offset(0, 2)),
          ],
        ),
        padding: const EdgeInsets.symmetric(horizontal: 16),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, color: const Color(0xFF7F55B1)),
            const SizedBox(width: 8),
            Flexible(child: Text(label, overflow: TextOverflow.ellipsis, style: const TextStyle(color: Colors.black87, fontWeight: FontWeight.w600))),
          ],
        ),
      ),
    );
  }

  Widget _card({required Widget child}) {
    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(color: Colors.black.withValues(alpha: 0.12), blurRadius: 12, offset: const Offset(0, 4)),
        ],
      ),
      padding: const EdgeInsets.all(16),
      child: child,
    );
  }

  Widget _kpiTile(_KpiItem item) {
    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFFF7F2FF),
        borderRadius: BorderRadius.circular(12),
      ),
      padding: const EdgeInsets.all(12),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(item.title, style: const TextStyle(fontSize: 12, color: Colors.black54, fontWeight: FontWeight.w600)),
          const SizedBox(height: 8),
          Text(item.value, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.w900, color: Color(0xFF7F55B1))),
        ],
      ),
    );
  }

  Widget _metricTile({required String title, required String value}) {
    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFFF5F5DC),
        borderRadius: BorderRadius.circular(12),
      ),
      padding: const EdgeInsets.all(12),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(title, style: const TextStyle(fontSize: 12, color: Colors.black54, fontWeight: FontWeight.w600)),
          const SizedBox(height: 8),
          Text(value, style: const TextStyle(fontSize: 20, fontWeight: FontWeight.w800, color: Colors.black87)),
        ],
      ),
    );
  }

  Widget _segmented({required List<String> options, required String value, required ValueChanged<String> onChanged}) {
    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFFEDE7F6),
        borderRadius: BorderRadius.circular(20),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: options.map((o) {
          final selected = o == value;
          return GestureDetector(
            onTap: () => onChanged(o),
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
              decoration: BoxDecoration(
                color: selected ? const Color(0xFF7F55B1) : Colors.transparent,
                borderRadius: BorderRadius.circular(20),
              ),
              child: Text(o, style: TextStyle(color: selected ? Colors.white : const Color(0xFF7F55B1), fontWeight: FontWeight.w700)),
            ),
          );
        }).toList(),
      ),
    );
  }

  Widget _barRow({required String label, required int value, required int maxValue}) {
    final ratio = maxValue == 0 ? 0.0 : value / maxValue;
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        children: [
          SizedBox(width: 72, child: Text(label, style: const TextStyle(fontSize: 12))),
          const SizedBox(width: 8),
          Expanded(
            child: Stack(
              children: [
                Container(height: 14, decoration: BoxDecoration(color: const Color(0xFFE0E0E0), borderRadius: BorderRadius.circular(8))),
                FractionallySizedBox(
                  widthFactor: ratio.clamp(0, 1),
                  child: Container(height: 14, decoration: BoxDecoration(color: const Color(0xFFB39DDB), borderRadius: BorderRadius.circular(8))),
                ),
              ],
            ),
          ),
          const SizedBox(width: 8),
          SizedBox(width: 28, child: Text('$value', textAlign: TextAlign.right, style: const TextStyle(fontSize: 12))),
        ],
      ),
    );
  }

  Future<void> _pickDateRange() async {
    final now = DateTime.now();
    final initial = _dateRange ?? DateTimeRange(start: now.subtract(const Duration(days: 29)), end: now);
    final picked = await showDateRangePicker(
      context: context,
      firstDate: DateTime(now.year - 5),
      lastDate: DateTime(now.year + 1),
      initialDateRange: initial,
      helpText: 'Pilih rentang tanggal',
      cancelText: 'Batal',
      confirmText: 'Pilih',
    );
    if (picked != null) {
      setState(() => _dateRange = picked);
    }
  }

  Future<void> _openFiltersDialog() async {
    final tempStatus = {..._statusFilter};
    final tempCategory = {..._categoryFilter};
    String anon = _anonymousFilter;
    String evid = _evidenceFilter;
    await showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          title: const Text('Filter'),
          content: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('Status', style: TextStyle(fontWeight: FontWeight.w700)),
                ...['Baru', 'Diproses', 'Selesai'].map((s) => CheckboxListTile(
                      value: tempStatus.contains(s),
                      onChanged: (v) {
                        if (v == true) {
                          tempStatus.add(s);
                        } else {
                          tempStatus.remove(s);
                        }
                        setState(() {});
                      },
                      title: Text(s),
                      contentPadding: EdgeInsets.zero,
                      controlAffinity: ListTileControlAffinity.leading,
                    )),
                const SizedBox(height: 8),
                const Text('Kategori', style: TextStyle(fontWeight: FontWeight.w700)),
                ...['Fisik', 'Verbal', 'Cyber', 'Sosial', 'Lainnya'].map((s) => CheckboxListTile(
                      value: tempCategory.contains(s),
                      onChanged: (v) {
                        if (v == true) {
                          tempCategory.add(s);
                        } else {
                          tempCategory.remove(s);
                        }
                        setState(() {});
                      },
                      title: Text(s),
                      contentPadding: EdgeInsets.zero,
                      controlAffinity: ListTileControlAffinity.leading,
                    )),
                const SizedBox(height: 8),
                const Text('Ada bukti', style: TextStyle(fontWeight: FontWeight.w700)),
                RadioGroup<String>(
                  groupValue: evid,
                  onChanged: (v) {
                    if (v != null) {
                      setState(() => evid = v);
                    }
                  },
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      ...['Semua', 'Ya', 'Tidak'].map((s) => RadioListTile<String>(
                            value: s,
                            title: Text(s),
                            contentPadding: EdgeInsets.zero,
                          )),
                    ],
                  ),
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () {
                setState(() {
                  _statusFilter
                    ..clear()
                    ..addAll({'Baru', 'Diproses', 'Selesai'});
                  _categoryFilter
                    ..clear()
                    ..addAll({'Fisik', 'Verbal', 'Cyber', 'Sosial', 'Lainnya'});
                  _anonymousFilter = 'Semua';
                  _evidenceFilter = 'Semua';
                });
                Navigator.pop(context);
              },
              child: const Text('Reset'),
            ),
            ElevatedButton(
              onPressed: () {
                setState(() {
                  _statusFilter
                    ..clear()
                    ..addAll(tempStatus);
                  _categoryFilter
                    ..clear()
                    ..addAll(tempCategory);
                  _anonymousFilter = anon;
                  _evidenceFilter = evid;
                });
                Navigator.pop(context);
              },
              child: const Text('Terapkan'),
            ),
          ],
        );
      },
    );
  }
}

class _KpiItem {
  _KpiItem({required this.title, required this.value});
  final String title;
  final String value;
}

class _LegendDot extends StatelessWidget {
  const _LegendDot({required this.color, required this.label});
  final Color color;
  final String label;

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Container(width: 10, height: 10, decoration: BoxDecoration(color: color, shape: BoxShape.circle)),
        const SizedBox(width: 6),
        Text(label, style: const TextStyle(fontSize: 12, color: Colors.black54)),
      ],
    );
  }
}

class _Point {
  const _Point({required this.x, required this.y});
  final double x;
  final double y;
}

class _LineChart extends StatelessWidget {
  const _LineChart({required this.series, required this.lineColors});
  final Map<String, List<_Point>> series;
  final List<Color> lineColors;

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      painter: _LineChartPainter(series: series, lineColors: lineColors),
    );
  }
}

class _LineChartPainter extends CustomPainter {
  _LineChartPainter({required this.series, required this.lineColors});
  final Map<String, List<_Point>> series;
  final List<Color> lineColors;

  @override
  void paint(Canvas canvas, Size size) {
    final padding = 16.0;
    final chartRect = Rect.fromLTWH(padding, padding, size.width - 2 * padding, size.height - 2 * padding);

    double maxY = 1;
    for (final s in series.values) {
      for (final p in s) {
        if (p.y > maxY) maxY = p.y;
      }
    }
    if (maxY == 0) maxY = 1;

    final axisPaint = Paint()..color = const Color(0xFFE0E0E0)..strokeWidth = 1;
    // axes
    canvas.drawLine(Offset(chartRect.left, chartRect.bottom), Offset(chartRect.right, chartRect.bottom), axisPaint);
    canvas.drawLine(Offset(chartRect.left, chartRect.top), Offset(chartRect.left, chartRect.bottom), axisPaint);

    int colorIdx = 0;
    for (final entry in series.entries) {
      final points = entry.value;
      if (points.isEmpty) continue;
      final path = Path();
      for (int i = 0; i < points.length; i++) {
        final p = points[i];
        final dx = points.length == 1 ? chartRect.left : chartRect.left + (p.x / (points.length - 1)) * chartRect.width;
        final dy = chartRect.bottom - (p.y / maxY) * chartRect.height;
        if (i == 0) {
          path.moveTo(dx, dy);
        } else {
          path.lineTo(dx, dy);
        }
      }
      final paint = Paint()
        ..color = lineColors[colorIdx % lineColors.length]
        ..style = PaintingStyle.stroke
        ..strokeWidth = 2;
      canvas.drawPath(path, paint);
      colorIdx += 1;
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}

class _DonutChart extends StatelessWidget {
  const _DonutChart({required this.data, required this.colors});
  final Map<String, int> data;
  final Map<String, Color> colors;

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      painter: _DonutPainter(data: data, colors: colors),
      child: Center(
        child: Text('${data.values.fold<int>(0, (a, b) => a + b)}', style: const TextStyle(fontWeight: FontWeight.w800)),
      ),
    );
  }
}

class _DonutPainter extends CustomPainter {
  _DonutPainter({required this.data, required this.colors});
  final Map<String, int> data;
  final Map<String, Color> colors;

  @override
  void paint(Canvas canvas, Size size) {
    final total = data.values.fold<int>(0, (a, b) => a + b);
    final rect = Offset.zero & size;
    final outer = Rect.fromCircle(center: rect.center, radius: size.shortestSide / 2 - 8);
    final startAngleBase = -3.14159 / 2;
    double start = startAngleBase;
    if (total == 0) {
      final paint = Paint()..color = const Color(0xFFE0E0E0)..style = PaintingStyle.stroke..strokeWidth = 14;
      canvas.drawArc(outer, 0, 6.28318, false, paint);
      return;
    }
    for (final entry in data.entries) {
      final sweep = (entry.value / total) * 6.28318;
      final paint = Paint()
        ..color = colors[entry.key] ?? Colors.grey
        ..style = PaintingStyle.stroke
        ..strokeWidth = 14
        ..strokeCap = StrokeCap.butt;
      canvas.drawArc(outer, start, sweep, false, paint);
      start += sweep;
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}

class _Report {
  _Report({
    required this.createdAt,
    required this.status,
    required this.category,
    required this.anonymous,
    required this.evidenceCount,
    this.firstHandledAt,
    this.resolvedAt,
  });
  final DateTime createdAt;
  final DateTime? firstHandledAt;
  final DateTime? resolvedAt;
  final String status; // 'Baru', 'Diproses', 'Selesai'
  final String category; // 'Fisik','Verbal','Cyber','Sosial','Lainnya'
  final bool anonymous;
  final int evidenceCount;
}

List<_Report> _mockReports() {
  final now = DateTime.now();
  DateTime d(int daysAgo, {int hour = 10}) => DateTime(now.year, now.month, now.day - daysAgo, hour);
  return [
    _Report(createdAt: d(1), status: 'Baru', category: 'Verbal', anonymous: false, evidenceCount: 2),
    _Report(createdAt: d(2), status: 'Diproses', category: 'Sosial', anonymous: true, evidenceCount: 0, firstHandledAt: d(2, hour: 15)),
    _Report(createdAt: d(3), status: 'Selesai', category: 'Cyber', anonymous: false, evidenceCount: 1, firstHandledAt: d(3, hour: 12), resolvedAt: d(5, hour: 9)),
    _Report(createdAt: d(4), status: 'Baru', category: 'Fisik', anonymous: false, evidenceCount: 0),
    _Report(createdAt: d(5), status: 'Selesai', category: 'Verbal', anonymous: true, evidenceCount: 3, firstHandledAt: d(5, hour: 14), resolvedAt: d(7, hour: 11)),
    _Report(createdAt: d(6), status: 'Diproses', category: 'Cyber', anonymous: false, evidenceCount: 1, firstHandledAt: d(6, hour: 16)),
    _Report(createdAt: d(8), status: 'Selesai', category: 'Sosial', anonymous: false, evidenceCount: 0, firstHandledAt: d(8, hour: 11), resolvedAt: d(10, hour: 10)),
    _Report(createdAt: d(11), status: 'Baru', category: 'Lainnya', anonymous: true, evidenceCount: 1),
    _Report(createdAt: d(13), status: 'Diproses', category: 'Fisik', anonymous: false, evidenceCount: 0, firstHandledAt: d(13, hour: 13)),
    _Report(createdAt: d(15), status: 'Selesai', category: 'Verbal', anonymous: false, evidenceCount: 2, firstHandledAt: d(15, hour: 12), resolvedAt: d(17, hour: 10)),
    _Report(createdAt: d(18), status: 'Selesai', category: 'Cyber', anonymous: true, evidenceCount: 1, firstHandledAt: d(18, hour: 16), resolvedAt: d(20, hour: 9)),
    _Report(createdAt: d(22), status: 'Baru', category: 'Sosial', anonymous: false, evidenceCount: 0),
    _Report(createdAt: d(24), status: 'Selesai', category: 'Fisik', anonymous: true, evidenceCount: 1, firstHandledAt: d(24, hour: 14), resolvedAt: d(28, hour: 10)),
  ];
}
</file>

<file path="lib/features/mood_check/presentation/pages/mood_check_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';
import 'mood_check_recording_page.dart';
import '../../../../core/theme/app_theme.dart';

class MoodCheckPage extends StatefulWidget {
  const MoodCheckPage({super.key});

  @override
  State<MoodCheckPage> createState() => _MoodCheckPageState();
}

class _MoodCheckPageState extends State<MoodCheckPage> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF7F55B1), // Purple at 76%
              Color(0xFFFFDBB6), // Light peach/orange at 100%
            ],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: Stack(
            children: [
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20.0),
                child: SingleChildScrollView(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const SizedBox(height: 60), // Space for back button
                      // Title
                      Text(
                        'Mood Check',
                        style: AppTheme.headingLarge,
                      ),
                      const SizedBox(height: 16),
                      // Subtitle
                      Text(
                        'Di sini, kamu bisa berbicara dengan jujur tentang perasaanmu.',
                        style: AppTheme.bodyLarge,
                      ),
                      const SizedBox(height: 40),
                      // SVG Illustration - Centered
                      Center(
                        child: SizedBox(
                          width: 250,
                          height: 250,
                          child: SvgPicture.asset(
                            'assets/images/mood_check_intro.svg',
                            fit: BoxFit.contain,
                            allowDrawingOutsideViewBox: true,
                          ),
                        ),
                      ),
                      const SizedBox(height: 40),
                      // Paragraph
                      const Text(
                        'Ini adalah ruang yang aman untuk kamu mengekspresikan diri.\n\nRekaman suaramu bersifat rahasia dan hanya digunakan oleh sistem kami untuk menganalisis emosi.',
                        style: TextStyle(
                          fontSize: 16,
                          color: Colors.white,
                          height: 1.5,
                        ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 40),
                      // Start Button
                      SizedBox(
                        width: double.infinity,
                        height: 56,
                        child: ElevatedButton(
                          onPressed: () {
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                builder: (context) => const MoodCheckRecordingPage(),
                              ),
                            );
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.white,
                            foregroundColor: const Color(0xFF7F55B1),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(28),
                            ),
                            elevation: 4,
                          ),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              SizedBox(
                                width: 20,
                                height: 20,
                                child: SvgPicture.asset(
                                  'assets/icons/speak-ai-fill.svg',
                                  fit: BoxFit.contain,
                                  allowDrawingOutsideViewBox: true,
                                ),
                              ),
                              const SizedBox(width: 8),
                              const Text(
                                'Mulai Berbicara',
                                style: TextStyle(
                                  fontSize: 18,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                      const SizedBox(height: 40),
                      // Bottom Section - Copyright
                      const Padding(
                        padding: EdgeInsets.only(bottom: 20),
                        child: Center(
                          child: Text(
                            '© 2025 SIKAP. All rights reserved.',
                            textAlign: TextAlign.center,
                            style: TextStyle(
                              fontSize: 12,
                              color: Colors.white70,
                            ),
                          ),
                        ),
                      ),
                      // Additional space to ensure scrolling
                      const SizedBox(height: 100),
                    ],
                  ),
                ),
              ),
              // Custom Back Button
              Positioned(
                top: 0,
                left: 0,
                child: SafeArea(
                  child: Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: Container(
                      decoration: BoxDecoration(
                        color: Colors.black.withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: IconButton(
                        icon: const Icon(
                          Icons.chevron_left,
                          color: Colors.white,
                          size: 28,
                        ),
                        onPressed: () {
                          Navigator.of(context).pop();
                        },
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

}
</file>

<file path="lib/features/mood_check/presentation/pages/mood_check_result_page.dart">
import 'package:flutter/material.dart';

class MoodCheckResultPage extends StatelessWidget {
  const MoodCheckResultPage({super.key, required this.result});

  final Map<String, dynamic> result;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFF7F55B1), Color(0xFFFFDBB6)],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: Stack(
            children: [
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20.0),
                child: SingleChildScrollView(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const SizedBox(height: 60),
                      const Text(
                        'Hasil Analisis Emosi',
                        style: TextStyle(
                          fontSize: 32,
                          fontWeight: FontWeight.w900,
                          color: Colors.white,
                          height: 1.2,
                          fontFamily: 'serif',
                        ),
                      ),
                      const SizedBox(height: 24),

                      // Score card
                      Container(
                        width: double.infinity,
                        decoration: BoxDecoration(
                          color: const Color(0xFF2E4BA6).withValues(alpha: 0.9),
                          borderRadius: BorderRadius.circular(16),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withValues(alpha: 0.18),
                              blurRadius: 18,
                              offset: const Offset(0, 8),
                            ),
                          ],
                        ),
                        padding: const EdgeInsets.all(16),
                        child: Row(
                          children: [
                            // Simple donut placeholder
                            SizedBox(
                              width: 88,
                              height: 88,
                              child: Stack(
                                alignment: Alignment.center,
                                children: [
                                  SizedBox(
                                    width: 88,
                                    height: 88,
                                    child: CircularProgressIndicator(
                                      value: 0.7,
                                      strokeWidth: 10,
                                      color: const Color(0xFFFFDBB6),
                                      backgroundColor: Colors.white.withValues(alpha: 0.15),
                                    ),
                                  ),
                                  Container(
                                    width: 56,
                                    height: 56,
                                    decoration: BoxDecoration(
                                      color: Colors.white.withValues(alpha: 0.1),
                                      shape: BoxShape.circle,
                                      border: Border.all(color: Colors.white.withValues(alpha: 0.2)),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            const SizedBox(width: 16),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Row(
                                    children: [
                                      const Icon(Icons.insights, color: Color(0xFFFFDBB6), size: 18),
                                      const SizedBox(width: 8),
                                      Text(
                                        _primaryLabel(result),
                                        style: const TextStyle(
                                          color: Colors.white,
                                          fontSize: 16,
                                          fontWeight: FontWeight.w800,
                                        ),
                                      ),
                                    ],
                                  ),
                                  const SizedBox(height: 8),
                                  ..._legendFromResult(result),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),

                      const SizedBox(height: 24),
                      const _SectionTitle('Hasil Analisis'),
                      const SizedBox(height: 12),

                      Text(
                        _summaryText(result),
                        style: const TextStyle(fontSize: 14, color: Colors.white, height: 1.6),
                      ),
                      const SizedBox(height: 16),
                      const Text(
                        'Hasil ini hanyalah wawasan teknis berdasarkan analisis suara, bukan diagnosis medis. Jika Anda merasa tertekan, kami sangat menganjurkan untuk berbicara dengan profesional kesehatan mental.',
                        style: TextStyle(fontSize: 13, color: Colors.white, height: 1.6, fontWeight: FontWeight.w700),
                      ),

                      const SizedBox(height: 24),
                      Center(
                        child: SizedBox(
                          width: 280,
                          child: ElevatedButton(
                            onPressed: () => Navigator.of(context).popUntil((route) => route.isFirst),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: Colors.white,
                              foregroundColor: const Color(0xFF7F55B1),
                              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                              elevation: 0,
                              padding: const EdgeInsets.symmetric(vertical: 14),
                            ),
                            child: const Text('Kembali ke Homepage'),
                          ),
                        ),
                      ),

                      const SizedBox(height: 40),
                      const Padding(
                        padding: EdgeInsets.only(bottom: 20),
                        child: Center(
                          child: Text(
                            '© 2025 SIKAP. All rights reserved.',
                            textAlign: TextAlign.center,
                            style: TextStyle(fontSize: 12, color: Colors.white70),
                          ),
                        ),
                      ),
                      const SizedBox(height: 100),
                    ],
                  ),
                ),
              ),

              // Back button
              Positioned(
                top: 0,
                left: 0,
                child: SafeArea(
                  child: Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: Container(
                      decoration: BoxDecoration(
                        color: Colors.black.withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: IconButton(
                        icon: const Icon(Icons.chevron_left, color: Colors.white, size: 28),
                        onPressed: () => Navigator.of(context).pop(),
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _Legend extends StatelessWidget {
  const _Legend({required this.color, required this.label});
  final Color color;
  final String label;

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Container(width: 12, height: 12, decoration: BoxDecoration(color: color, shape: BoxShape.circle)),
        const SizedBox(width: 8),
        Text(label, style: const TextStyle(color: Colors.white, fontSize: 12)),
      ],
    );
  }
}

class _SectionTitle extends StatelessWidget {
  const _SectionTitle(this.text);
  final String text;

  @override
  Widget build(BuildContext context) {
    return Text(
      text,
      style: const TextStyle(
        fontSize: 16,
        fontWeight: FontWeight.w800,
        color: Colors.white,
      ),
    );
  }
}

// Helpers to render dynamic result
String _primaryLabel(Map<String, dynamic> result) {
  // Try common shapes: {primary_emotion, scores: {sad:0.7,...}} or flat {emotion:'sadness', score:0.7}
  final primary = result['primary_emotion'] ?? result['emotion'];
  final score = result['score'] ?? (result['primary_score'] ?? _maxScore(result['scores']));
  if (primary != null && score != null) {
    final pct = ((score as num) * 100).toStringAsFixed(0);
    return '$pct% ${_title(primary.toString())}';
  }
  return 'Emosi Terdeteksi';
}

List<Widget> _legendFromResult(Map<String, dynamic> result) {
  final scores = result['scores'];
  if (scores is Map) {
    final entries = scores.entries
        .where((e) => e.value is num)
        .cast<MapEntry<dynamic, num>>()
        .toList()
      ..sort((a, b) => (b.value).compareTo(a.value));
    final colors = [Colors.white, const Color(0xFFBFD4FF), Colors.white70, Colors.white60];
    return [
      for (var i = 0; i < entries.length && i < 4; i++)
        _Legend(color: colors[i % colors.length], label: '${((entries[i].value) * 100).toStringAsFixed(0)}% ${_title(entries[i].key.toString())}')
    ];
  }
  return const [];
}

double? _maxScore(dynamic scores) {
  if (scores is Map) {
    final values = scores.values.whereType<num>();
    if (values.isNotEmpty) return values.reduce((a, b) => a > b ? a : b).toDouble();
  }
  return null;
}

String _title(String s) => s.isEmpty ? s : s[0].toUpperCase() + s.substring(1);

String _summaryText(Map<String, dynamic> result) {
  final primary = result['primary_emotion'] ?? result['emotion'];
  final scores = result['scores'];
  if (primary != null) {
    return 'Emosi dominan: ${_title(primary.toString())}.\nHasil ini adalah wawasan teknis berdasarkan analisis suara, bukan diagnosis medis.';
  }
  if (scores is Map) {
    final top = scores.entries
        .where((e) => e.value is num)
        .cast<MapEntry<dynamic, num>>()
        .toList()
      ..sort((a, b) => (b.value).compareTo(a.value));
    if (top.isNotEmpty) {
      final first = top.first;
      final pct = (first.value * 100).toStringAsFixed(0);
      return 'Emosi tertinggi: ${_title(first.key.toString())} ($pct%).\nHasil ini adalah wawasan teknis berdasarkan analisis suara, bukan diagnosis medis.';
    }
  }
  return 'Analisis berhasil. Detail lengkap ditampilkan di atas.';
}
</file>

<file path="lib/features/reflections/presentation/reflection_scenario.dart">
import 'package:flutter/material.dart';
import 'reflection_list.dart';

class ReflectionScenarioPage extends StatelessWidget {
  const ReflectionScenarioPage({super.key});

  @override
  Widget build(BuildContext context) {
    final Map<String, List<String>> data = {
      'SD': [
        'Kotak Pensil Disembunyikan & Ejekan',
        'Merasa Sedih Karena Gagal Gambar',
        'Melihat Teman Didorong di Lapangan',
      ],
      'SMP': [
        'Dikeluarkan dari Grup WA & Rumor',
        'Tekanan Cepat Menyelesaikan Tugas Kelompok',
        'Melihat Siswa Lain Memaksa Junior Membayar Jajan',
      ],
      'SMA': [
        'Perselisihan Posting Medsos & Cancel Culture',
        'Dilema Menjadi Saksi Kecurangan Ujian',
        'Menghadapi Guru yang Memberikan Komentar Merendahkan',
      ],
    };

    final Map<String, String> descriptions = {
      // SD
      'Kotak Pensil Disembunyikan & Ejekan':
          'Di sini, kamu akan belajar mengenai tindakan berani yang aman. Selain itu, kamu juga akan mengidentifikasi bullying sederhana. Kamu akan tahu cara tepat meminta bantuan orang dewasa.',
      'Merasa Sedih Karena Gagal Gambar':
          'Di sini, kamu akan belajar mengenai cara mengelola perasaan frustrasi. Selain itu, kamu juga akan mencari bantuan saat kesulitan belajar. Kamu akan fokus pada proses usaha, bukan hanya hasil akhir.',
      'Melihat Teman Didorong di Lapangan':
          'Di sini, kamu akan belajar mengenai cara aman menjadi upstander. Selain itu, kamu juga akan mengutamakan keselamatan saat menolong. Kamu akan memahami bahwa melapor adalah tindakan keberanian.',
      // SMP
      'Dikeluarkan dari Grup WA & Rumor':
          'Di sini, kamu akan belajar mengenai mengendalikan emosi saat krisis daring. Selain itu, kamu juga akan memilih strategi pelaporan yang efektif. Kamu akan melindungi diri dari cyberbullying yang meluas.',
      'Tekanan Cepat Menyelesaikan Tugas Kelompok':
          'Di sini, kamu akan belajar mengenai komunikasi asertif. Selain itu, kamu juga akan menyusun perencanaan kerja yang realistis. Kamu akan menyelesaikan konflik akademik dengan kepala dingin.',
      'Melihat Siswa Lain Memaksa Junior Membayar Jajan':
          'Di sini, kamu akan belajar mengenai pengambilan keputusan etis. Selain itu, kamu juga akan menyelamatkan korban tanpa konfrontasi. Kamu akan mempertahankan nilai keadilan di sekolah.',
      // SMA
      'Perselisihan Posting Medsos & Cancel Culture':
          'Di sini, kamu akan belajar mengenai berpikir kritis saat krisis daring. Selain itu, kamu juga akan melindungi diri dari tekanan groupthink. Kamu akan menerapkan strategi manajemen krisis media sosial.',
      'Dilema Menjadi Saksi Kecurangan Ujian':
          'Di sini, kamu akan belajar mengenai pentingnya integritas akademik. Selain itu, kamu juga akan memilih saluran pelaporan anonim yang tepat. Kamu akan mengelola tekanan sosial setelah mengambil sikap jujur.',
      'Menghadapi Guru yang Memberikan Komentar Merendahkan':
          'Di sini, kamu akan belajar mengenai cara berkomunikasi secara asertif dengan figur otoritas. Selain itu, kamu juga akan mencari dukungan profesional di sekolah. Kamu akan memisahkan komentar destruktif dari nilai dirimu.',
    };

    final Map<String, String> questions = {
      // SD
      'Kotak Pensil Disembunyikan & Ejekan': 'Apa yang kamu pelajari tentang menjadi "pahlawan" yang baik hari ini?',
      'Merasa Sedih Karena Gagal Gambar': 'Apa yang kamu lakukan saat sedih/kesal agar bisa semangat lagi?',
      'Melihat Teman Didorong di Lapangan': 'Apa yang kamu lakukan saat kamu melihat teman butuh bantuan tetapi kamu merasa takut?',
      // SMP
      'Dikeluarkan dari Grup WA & Rumor': 'Apa yang kamu pelajari tentang menghadapi masalah di media sosial tanpa mengorbankan dirimu sendiri?',
      'Tekanan Cepat Menyelesaikan Tugas Kelompok': 'Apa yang kamu pelajari tentang pentingnya perencanaan dan berbicara jujur dalam kelompok?',
      'Melihat Siswa Lain Memaksa Junior Membayar Jajan': 'Apa yang membuatmu berani bertindak, meskipun ada risiko bahaya?',
      // SMA
      'Perselisihan Posting Medsos & Cancel Culture': 'Apa yang kamu pelajari tentang pentingnya berpikir kritis dan mengelola emosi dalam menghadapi tekanan sosial daring?',
      'Dilema Menjadi Saksi Kecurangan Ujian': 'Mengapa nilai kejujuran lebih penting daripada popularitas sosial di sekolah?',
      'Menghadapi Guru yang Memberikan Komentar Merendahkan': 'Apa yang kamu pelajari tentang pentingnya memisahkan kritik yang merusak (destruktif) dengan nilai dirimu sendiri?',
    };

    return Scaffold(
      appBar: AppBar(
        title: const Text('Refleksi Skenario'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      body: Container(
        color: const Color(0xFF7F55B1),
        child: SafeArea(
          child: ListView(
            padding: const EdgeInsets.all(16),
            children: [
              ...data.entries.map((entry) => _Section(
                    title: entry.key,
                    items: entry.value,
                    descriptions: descriptions,
                    questions: questions,
                  )),
            ],
          ),
        ),
      ),
    );
  }
}

class _Section extends StatelessWidget {
  const _Section({required this.title, required this.items, required this.descriptions, required this.questions});

  final String title;
  final List<String> items;
  final Map<String, String> descriptions;
  final Map<String, String> questions;

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(title, style: const TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.w800)),
        const SizedBox(height: 12),
        ...items.map((s) => _ScenarioTile(title: s, description: descriptions[s] ?? '-', question: questions[s] ?? '-')),
        const SizedBox(height: 20),
      ],
    );
  }
}

class _ScenarioTile extends StatelessWidget {
  const _ScenarioTile({required this.title, required this.description, required this.question});
  final String title;
  final String description;
  final String question;

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(color: Colors.black.withValues(alpha: 0.12), blurRadius: 12, offset: const Offset(0, 4)),
        ],
      ),
      child: ListTile(
        title: Text(title, style: const TextStyle(fontWeight: FontWeight.w700)),
        trailing: const Icon(Icons.chevron_right),
        onTap: () {
          Navigator.of(context).push(
            MaterialPageRoute(
              builder: (_) => ReflectionListPage(
                scenarioTitle: title,
                scenarioDescription: description,
                question: question,
              ),
            ),
          );
        },
      ),
    );
  }
}

class ReflectionScenarioDetailPage extends StatelessWidget {
  const ReflectionScenarioDetailPage({super.key, required this.title, required this.description});

  final String title;
  final String description;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Detail Skenario'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      body: Container(
        color: const Color(0xFF7F55B1),
        child: SafeArea(
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Container(
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(color: Colors.black.withValues(alpha: 0.12), blurRadius: 12, offset: const Offset(0, 4)),
                ],
              ),
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(title, style: const TextStyle(fontSize: 20, fontWeight: FontWeight.w800)),
                  const SizedBox(height: 12),
                  Text(description),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/wellbeing_resources/data/models/wellbeing_resources_create_response.dart">
class WellbeingResourcesCreateResponse {
  final bool success;
  final String message;
  final Map<String, dynamic>? data;

  WellbeingResourcesCreateResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory WellbeingResourcesCreateResponse.fromJson(Map<String, dynamic> json) {
    return WellbeingResourcesCreateResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/wellbeing_resources/data/models/wellbeing_resources_detail_response.dart">
class WellbeingResourcesDetailResponse {
  final bool success;
  final String message;
  final Map<String, dynamic>? data;

  WellbeingResourcesDetailResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory WellbeingResourcesDetailResponse.fromJson(Map<String, dynamic> json) {
    return WellbeingResourcesDetailResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/wellbeing_resources/data/models/wellbeing_resources_list_response.dart">
class WellbeingResourcesListResponse {
  final bool success;
  final String message;
  final List<dynamic>? data;

  WellbeingResourcesListResponse({
    required this.success,
    required this.message,
    this.data,
  });

  factory WellbeingResourcesListResponse.fromJson(Map<String, dynamic> json) {
    return WellbeingResourcesListResponse(
      success: json['success'] ?? false,
      message: json['message'] ?? '',
      data: json['data'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'success': success,
      'message': message,
      'data': data,
    };
  }
}
</file>

<file path="lib/features/wellbeing_resources/data/models/wellbeing_resources_model.dart">
class WellbeingResourcesModel {
  final String id;
  final String title;
  final String description;
  final String type;
  final String category;
  final String content;
  final String? imageUrl;
  final String? videoUrl;
  final String? audioUrl;
  final String? documentUrl;
  final List<String> tags;
  final String status;
  final String authorId;
  final DateTime createdAt;
  final DateTime? updatedAt;
  final int viewsCount;
  final int likesCount;

  WellbeingResourcesModel({
    required this.id,
    required this.title,
    required this.description,
    required this.type,
    required this.category,
    required this.content,
    this.imageUrl,
    this.videoUrl,
    this.audioUrl,
    this.documentUrl,
    required this.tags,
    required this.status,
    required this.authorId,
    required this.createdAt,
    this.updatedAt,
    required this.viewsCount,
    required this.likesCount,
  });

  factory WellbeingResourcesModel.fromJson(Map<String, dynamic> json) {
    return WellbeingResourcesModel(
      id: json['id'] ?? '',
      title: json['title'] ?? '',
      description: json['description'] ?? '',
      type: json['type'] ?? '',
      category: json['category'] ?? '',
      content: json['content'] ?? '',
      imageUrl: json['image_url'],
      videoUrl: json['video_url'],
      audioUrl: json['audio_url'],
      documentUrl: json['document_url'],
      tags: List<String>.from(json['tags'] ?? []),
      status: json['status'] ?? '',
      authorId: json['author_id'] ?? '',
      createdAt: DateTime.parse(json['created_at'] ?? DateTime.now().toIso8601String()),
      updatedAt: json['updated_at'] != null ? DateTime.parse(json['updated_at']) : null,
      viewsCount: json['views_count'] ?? 0,
      likesCount: json['likes_count'] ?? 0,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'title': title,
      'description': description,
      'type': type,
      'category': category,
      'content': content,
      'image_url': imageUrl,
      'video_url': videoUrl,
      'audio_url': audioUrl,
      'document_url': documentUrl,
      'tags': tags,
      'status': status,
      'author_id': authorId,
      'created_at': createdAt.toIso8601String(),
      'updated_at': updatedAt?.toIso8601String(),
      'views_count': viewsCount,
      'likes_count': likesCount,
    };
  }
}
</file>

<file path="lib/features/wellbeing_resources/domain/entities/wellbeing_resources_entity.dart">
class WellbeingResourcesEntity {
  final String id;
  final String title;
  final String description;
  final String type;
  final String category;
  final String content;
  final String? imageUrl;
  final String? videoUrl;
  final String? audioUrl;
  final String? documentUrl;
  final List<String> tags;
  final String status;
  final String authorId;
  final DateTime createdAt;
  final DateTime? updatedAt;
  final int viewsCount;
  final int likesCount;

  WellbeingResourcesEntity({
    required this.id,
    required this.title,
    required this.description,
    required this.type,
    required this.category,
    required this.content,
    this.imageUrl,
    this.videoUrl,
    this.audioUrl,
    this.documentUrl,
    required this.tags,
    required this.status,
    required this.authorId,
    required this.createdAt,
    this.updatedAt,
    required this.viewsCount,
    required this.likesCount,
  });
}
</file>

<file path="lib/features/wellbeing_resources/domain/enums/resource_category.dart">
enum ResourceCategory {
  mentalHealth,
  stressManagement,
  mindfulness,
  selfCare,
  relationships,
  productivity,
  sleep,
  nutrition,
  exercise,
  therapy,
  other,
}

extension ResourceCategoryExtension on ResourceCategory {
  String get value {
    switch (this) {
      case ResourceCategory.mentalHealth:
        return 'mental_health';
      case ResourceCategory.stressManagement:
        return 'stress_management';
      case ResourceCategory.mindfulness:
        return 'mindfulness';
      case ResourceCategory.selfCare:
        return 'self_care';
      case ResourceCategory.relationships:
        return 'relationships';
      case ResourceCategory.productivity:
        return 'productivity';
      case ResourceCategory.sleep:
        return 'sleep';
      case ResourceCategory.nutrition:
        return 'nutrition';
      case ResourceCategory.exercise:
        return 'exercise';
      case ResourceCategory.therapy:
        return 'therapy';
      case ResourceCategory.other:
        return 'other';
    }
  }

  String get displayName {
    switch (this) {
      case ResourceCategory.mentalHealth:
        return 'Kesehatan Mental';
      case ResourceCategory.stressManagement:
        return 'Manajemen Stres';
      case ResourceCategory.mindfulness:
        return 'Mindfulness';
      case ResourceCategory.selfCare:
        return 'Perawatan Diri';
      case ResourceCategory.relationships:
        return 'Hubungan';
      case ResourceCategory.productivity:
        return 'Produktivitas';
      case ResourceCategory.sleep:
        return 'Tidur';
      case ResourceCategory.nutrition:
        return 'Nutrisi';
      case ResourceCategory.exercise:
        return 'Olahraga';
      case ResourceCategory.therapy:
        return 'Terapi';
      case ResourceCategory.other:
        return 'Lainnya';
    }
  }

  static ResourceCategory fromString(String value) {
    switch (value) {
      case 'mental_health':
        return ResourceCategory.mentalHealth;
      case 'stress_management':
        return ResourceCategory.stressManagement;
      case 'mindfulness':
        return ResourceCategory.mindfulness;
      case 'self_care':
        return ResourceCategory.selfCare;
      case 'relationships':
        return ResourceCategory.relationships;
      case 'productivity':
        return ResourceCategory.productivity;
      case 'sleep':
        return ResourceCategory.sleep;
      case 'nutrition':
        return ResourceCategory.nutrition;
      case 'exercise':
        return ResourceCategory.exercise;
      case 'therapy':
        return ResourceCategory.therapy;
      case 'other':
        return ResourceCategory.other;
      default:
        return ResourceCategory.other;
    }
  }
}
</file>

<file path="lib/features/wellbeing_resources/domain/enums/resource_type.dart">
enum ResourceType {
  article,
  video,
  audio,
  document,
  infographic,
  exercise,
  meditation,
  other,
}

extension ResourceTypeExtension on ResourceType {
  String get value {
    switch (this) {
      case ResourceType.article:
        return 'article';
      case ResourceType.video:
        return 'video';
      case ResourceType.audio:
        return 'audio';
      case ResourceType.document:
        return 'document';
      case ResourceType.infographic:
        return 'infographic';
      case ResourceType.exercise:
        return 'exercise';
      case ResourceType.meditation:
        return 'meditation';
      case ResourceType.other:
        return 'other';
    }
  }

  String get displayName {
    switch (this) {
      case ResourceType.article:
        return 'Artikel';
      case ResourceType.video:
        return 'Video';
      case ResourceType.audio:
        return 'Audio';
      case ResourceType.document:
        return 'Dokumen';
      case ResourceType.infographic:
        return 'Infografis';
      case ResourceType.exercise:
        return 'Latihan';
      case ResourceType.meditation:
        return 'Meditasi';
      case ResourceType.other:
        return 'Lainnya';
    }
  }

  static ResourceType fromString(String value) {
    switch (value) {
      case 'article':
        return ResourceType.article;
      case 'video':
        return ResourceType.video;
      case 'audio':
        return ResourceType.audio;
      case 'document':
        return ResourceType.document;
      case 'infographic':
        return ResourceType.infographic;
      case 'exercise':
        return ResourceType.exercise;
      case 'meditation':
        return ResourceType.meditation;
      case 'other':
        return ResourceType.other;
      default:
        return ResourceType.other;
    }
  }
}
</file>

<file path="lib/main.dart">
import 'package:flutter/material.dart';
import 'features/authentication/authentication.dart';
import 'core/theme/app_theme.dart';
import 'core/auth/ensure_guest_auth.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(MainApp());
}

class MainApp extends StatelessWidget {
  const MainApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'SIKAP',
      theme: AppTheme.lightTheme,
      home: const LoginPage(),
      debugShowCheckedModeBanner: false,
    );
  }
}
</file>

<file path="test/widget_test.dart">
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';

import 'package:sikap/main.dart';

void main() {
  testWidgets('App smoke test', (WidgetTester tester) async {
    // Build our app and trigger a frame.
    await tester.pumpWidget(const MainApp());

    // Verify that the app builds without errors
    expect(find.byType(MaterialApp), findsOneWidget);
  });

  testWidgets('App has correct theme', (WidgetTester tester) async {
    await tester.pumpWidget(const MainApp());

    final materialApp = tester.widget<MaterialApp>(find.byType(MaterialApp));
    
    // Verify app title
    expect(materialApp.title, 'SIKAP');
    
    // Verify debug banner is off
    expect(materialApp.debugShowCheckedModeBanner, false);
  });
}
</file>

<file path="lib/core/network/api_client.dart">
// lib/core/network/api_client.dart
// FIX: default JSON headers + dukung endpoint tanpa envelope (expectEnvelope=false).
// Tambah logging ringan biar gampang trace.

import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:sikap/core/network/api_exception.dart';
import 'package:sikap/core/network/api_env.dart';

class ApiResponse<T> {
  final T data;
  final int? status;
  final Map<String, String>? headers;
  ApiResponse(this.data, {this.status, this.headers});
}

class ApiClient {
  final http.Client _client = http.Client();

  Uri _u(String endpoint) => Uri.parse("${ApiEnv.baseUrl}$endpoint");

  Map<String, String> _jsonDefaults([Map<String, String>? extra]) {
    final base = <String, String>{
      'Accept': 'application/json',
      'Content-Type': 'application/json',
    };
    if (extra != null && extra.isNotEmpty) base.addAll(extra);
    return base;
  }

  void _logReq(String method, Uri url, Map<String, String> headers, Object? body) {
    // ignore: avoid_print
    print("[HTTP $method] $url\n  headers=$headers\n  body=${body is String ? body : jsonEncode(body)}");
  }

  ApiResponse<T> _handle<T>(
    http.Response resp, {
    T Function(dynamic)? transform,
    bool expectEnvelope = true,
  }) {
    final contentType = resp.headers['content-type'] ?? '';

    dynamic decoded;
    try {
      decoded = resp.bodyBytes.isEmpty ? null : jsonDecode(resp.body);
    } catch (_) {
      decoded = null;
    }

    if (resp.statusCode < 200 || resp.statusCode >= 300) {
      // Guard: HTML error page (e.g., 404/500 from proxy)
      if (contentType.contains('text/html')) {
        throw ApiException(
          message: "HTTP ${resp.statusCode} (HTML error page)",
          code: resp.statusCode,
        );
      }
      String msg = resp.reasonPhrase ?? "HTTP ${resp.statusCode}";
      Map<String, dynamic>? errs;
      if (decoded is Map) {
        if (decoded['message'] is String) msg = decoded['message'];
        if (decoded['detail'] is String) msg = decoded['detail'];
        if (decoded['errors'] is Map) errs = Map<String, dynamic>.from(decoded['errors']);
      }
      throw ApiException(message: msg, code: resp.statusCode, errors: errs);
    }

    if (!expectEnvelope) {
      final data = (transform != null) ? transform(decoded) : decoded as T;
      return ApiResponse<T>(data, status: resp.statusCode, headers: resp.headers);
    }

    if (decoded is! Map || decoded['success'] != true) {
      throw ApiException(message: "Envelope tidak valid / success != true");
    }
    final raw = decoded['data'];
    final data = (transform != null) ? transform(raw) : raw as T;
    return ApiResponse<T>(data, status: resp.statusCode, headers: resp.headers);
  }

  Future<ApiResponse<T>> get<T>(
    String endpoint, {
    Map<String, String>? headers,
    T Function(dynamic json)? transform,
    bool expectEnvelope = true,
  }) async {
    final uri = _u(endpoint);
    final h = _jsonDefaults(headers);
    _logReq('GET', uri, h, null);
    final r = await _client.get(uri, headers: h);
    return _handle<T>(r, transform: transform, expectEnvelope: expectEnvelope);
  }

  Future<ApiResponse<T>> post<T>(
    String endpoint,
    dynamic body, {
    Map<String, String>? headers,
    T Function(dynamic json)? transform,
    bool expectEnvelope = true,
  }) async {
    final uri = _u(endpoint);
    final h = _jsonDefaults(headers);
    final b = jsonEncode(body);
    _logReq('POST', uri, h, b);
    final r = await _client.post(uri, headers: h, body: b);
    return _handle<T>(r, transform: transform, expectEnvelope: expectEnvelope);
  }

  Future<ApiResponse<T>> patch<T>(
    String endpoint,
    dynamic body, {
    Map<String, String>? headers,
    T Function(dynamic json)? transform,
    bool expectEnvelope = true,
  }) async {
    final uri = _u(endpoint);
    final h = _jsonDefaults(headers);
    final b = jsonEncode(body);
    _logReq('PATCH', uri, h, b);
    final r = await _client.patch(uri, headers: h, body: b);
    return _handle<T>(r, transform: transform, expectEnvelope: expectEnvelope);
  }

  Future<ApiResponse<T>> delete<T>(
    String endpoint, {
    Map<String, String>? headers,
    T Function(dynamic json)? transform,
    bool expectEnvelope = true,
  }) async {
    final uri = _u(endpoint);
    final h = _jsonDefaults(headers);
    _logReq('DELETE', uri, h, null);
    final r = await _client.delete(uri, headers: h);
    return _handle<T>(r, transform: transform, expectEnvelope: expectEnvelope);
  }
}
</file>

<file path="lib/core/network/auth_header_provider.dart">
// lib/core/network/auth_header_provider.dart
typedef AsyncStr = Future<String?> Function();
typedef AsyncInt = Future<int?> Function();

class AuthHeaderProvider {
  final AsyncStr? loadUserToken;
  final AsyncStr? loadGuestToken; // compat future token
  final AsyncInt? loadGuestId;
  final AsyncStr? loadDeviceId;

  AuthHeaderProvider({
    this.loadUserToken,
    this.loadGuestToken,
    this.loadGuestId,
    this.loadDeviceId,
  });

  Future<Map<String, String>> buildHeaders({bool asGuest = false}) async {
    final headers = <String, String>{
      "Accept": "application/json",
      "Content-Type": "application/json",
    };

    if (asGuest) {
      final gid = await (loadGuestId?.call());
      final dev = await (loadDeviceId?.call());
      if (gid != null) {
        headers["X-Guest-Id"] = gid.toString();
      }
      if (dev != null && dev.isNotEmpty) {
        headers["X-Device-Id"] = dev;
      }
      // compat: kalau suatu saat token tersedia
      final t = await (loadGuestToken?.call());
      if (t != null && t.isNotEmpty) {
        headers["X-Guest-Token"] = t;
      }
      return headers;
    }

    final bearer = await (loadUserToken?.call());
    if (bearer != null && bearer.isNotEmpty) {
      headers["Authorization"] = "Bearer $bearer";
    }
    return headers;
  }
}
</file>

<file path="lib/core/network/multipart_client.dart">
// lib/core/network/multipart_client.dart
import 'dart:async';
import 'dart:convert';
import 'dart:io';

import 'package:http/http.dart' as http;
import 'package:http_parser/http_parser.dart';
import 'package:mime/mime.dart';

import 'api_env.dart';
import 'api_exception.dart';
import 'api_response.dart';
import 'logging.dart';

class MultipartClient {
  final Uri _base = Uri.parse(ApiEnv.baseUrl);

  MultipartClient();

  /// Normalisasi penyusunan URL agar tidak double-slash.
  Uri _build(String endpoint) {
    final clean = endpoint.startsWith('/') ? endpoint.substring(1) : endpoint;
    final basePath = _base.path.endsWith('/')
        ? _base.path
        : (_base.path.isEmpty ? '/' : '${_base.path}/');
    return _base.replace(path: '$basePath$clean');
  }

  /// Upload **1 file** (nama field default: 'file').
  Future<ApiResponse<dynamic>> postFile({
    required String endpoint,                 // e.g. '/api/venting/analyze/'
    required http.MultipartFile file,         // file tunggal
    Map<String, String>? headers,
    String fieldName = 'file',                // sesuaikan dg BE
    Map<String, String>? fields,              // extra form fields jika perlu
  }) async {
    final uri = _build(endpoint);
    final requestId = DateTime.now().microsecondsSinceEpoch.toString();
    final sw = Stopwatch()..start();

    final req = http.MultipartRequest('POST', uri);

    // Default headers untuk multipart: **jangan** set Content-Type di sini,
    // biarkan MultipartRequest yang set boundary-nya.
    final merged = <String, String>{
      'Accept': 'application/json',
      ...?headers,
    };
    req.headers.addAll(merged);

    if (fields != null && fields.isNotEmpty) {
      req.fields.addAll(fields);
    }

    // Pastikan nama field sesuai param 'fieldName'
    req.files.add(http.MultipartFile(
      fieldName,
      file.finalize(),
      file.length,
      filename: file.filename,
      contentType: file.contentType,
    ));

    logHttp(
      phase: 'REQ',
      requestId: requestId,
      method: 'POST-MULTIPART',
      uri: uri,
      headers: merged,
      body: 'multipart(1 file, field="$fieldName")',
    );

    try {
      final streamed = await req.send().timeout(ApiEnv.readTimeout);
      final resp = await http.Response.fromStream(streamed);
      sw.stop();

      logHttp(
        phase: 'RES',
        requestId: requestId,
        method: 'POST-MULTIPART',
        uri: uri,
        status: resp.statusCode,
        duration: sw.elapsed,
      );

      final json = jsonDecode(resp.body);
      if (resp.statusCode >= 200 &&
          resp.statusCode < 300 &&
          json is Map &&
          json['success'] == true) {
        return ApiResponse(json['data']);
      }
      throw ApiException(
        message:
            json is Map ? (json['message'] ?? 'Upload gagal') : 'Upload gagal',
        code: resp.statusCode,
        errors:
            json is Map ? (json['errors'] as Map<String, dynamic>?) : null,
      );
    } on SocketException {
      sw.stop();
      logHttp(
        phase: 'ERR',
        requestId: requestId,
        method: 'POST-MULTIPART',
        uri: uri,
        error: 'No internet',
        duration: sw.elapsed,
      );
      throw NetworkException('Tidak ada koneksi internet');
    } on TimeoutException catch (e) {
      sw.stop();
      logHttp(
        phase: 'ERR',
        requestId: requestId,
        method: 'POST-MULTIPART',
        uri: uri,
        error: e,
        duration: sw.elapsed,
      );
      throw TimeoutExceptionApi('Waktu koneksi habis');
    } on FormatException {
      sw.stop();
      logHttp(
        phase: 'ERR',
        requestId: requestId,
        method: 'POST-MULTIPART',
        uri: uri,
        error: 'Bad JSON',
        duration: sw.elapsed,
      );
      throw ApiException(message: 'Format respons tidak valid');
    }
  }

  /// Upload **banyak file** (nama field default: 'files[]').
  Future<ApiResponse<dynamic>> postFiles({
    required String endpoint,                  // e.g. '/api/bullying/report/123/attachments/'
    required List<http.MultipartFile> files,   // list file
    Map<String, String>? headers,
    String fieldName = 'files[]',              // sesuaikan dg BE
    Map<String, String>? fields,
  }) async {
    final uri = _build(endpoint);
    final requestId = DateTime.now().microsecondsSinceEpoch.toString();
    final sw = Stopwatch()..start();

    final req = http.MultipartRequest('POST', uri);

    final merged = <String, String>{
      'Accept': 'application/json',
      ...?headers,
    };
    req.headers.addAll(merged);

    if (fields != null && fields.isNotEmpty) {
      req.fields.addAll(fields);
    }

    for (final f in files) {
      req.files.add(http.MultipartFile(
        fieldName,
        f.finalize(),
        f.length,
        filename: f.filename,
        contentType: f.contentType,
      ));
    }

    logHttp(
      phase: 'REQ',
      requestId: requestId,
      method: 'POST-MULTIPART',
      uri: uri,
      headers: merged,
      body: 'multipart(${files.length} files, field="$fieldName")',
    );

    try {
      final streamed = await req.send().timeout(ApiEnv.readTimeout);
      final resp = await http.Response.fromStream(streamed);
      sw.stop();

      logHttp(
        phase: 'RES',
        requestId: requestId,
        method: 'POST-MULTIPART',
        uri: uri,
        status: resp.statusCode,
        duration: sw.elapsed,
      );

      final json = jsonDecode(resp.body);
      if (resp.statusCode >= 200 &&
          resp.statusCode < 300 &&
          json is Map &&
          json['success'] == true) {
        return ApiResponse(json['data']);
      }
      throw ApiException(
        message:
            json is Map ? (json['message'] ?? 'Upload gagal') : 'Upload gagal',
        code: resp.statusCode,
        errors:
            json is Map ? (json['errors'] as Map<String, dynamic>?) : null,
      );
    } on SocketException {
      sw.stop();
      logHttp(
        phase: 'ERR',
        requestId: requestId,
        method: 'POST-MULTIPART',
        uri: uri,
        error: 'No internet',
        duration: sw.elapsed,
      );
      throw NetworkException('Tidak ada koneksi internet');
    } on TimeoutException catch (e) {
      sw.stop();
      logHttp(
        phase: 'ERR',
        requestId: requestId,
        method: 'POST-MULTIPART',
        uri: uri,
        error: e,
        duration: sw.elapsed,
      );
      throw TimeoutExceptionApi('Waktu koneksi habis');
    } on FormatException {
      sw.stop();
      logHttp(
        phase: 'ERR',
        requestId: requestId,
        method: 'POST-MULTIPART',
        uri: uri,
        error: 'Bad JSON',
        duration: sw.elapsed,
      );
      throw ApiException(message: 'Format respons tidak valid');
    }
  }

  // ===== Helpers untuk bikin MultipartFile =====

  /// Dari bytes → satu file (nama field bebas; default gunakan di postFile/postFiles)
  static http.MultipartFile fromBytesSingle(
    String fieldName,
    List<int> bytes, {
    required String filename,
  }) {
    final mime = lookupMimeType(filename) ?? 'application/octet-stream';
    return http.MultipartFile.fromBytes(
      fieldName,
      bytes,
      filename: filename,
      contentType: MediaType.parse(mime),
    );
  }

  /// Dari path (Android/iOS) → satu file.
  static Future<http.MultipartFile> fromPathSingle(
    String fieldName,
    String path, {
    String? filename,
  }) async {
    final mime = lookupMimeType(path) ?? 'application/octet-stream';
    return http.MultipartFile.fromPath(
      fieldName,
      path,
      filename: filename,
      contentType: MediaType.parse(mime),
    );
  }

  /// Dari bytes → **untuk koleksi** file (nama field akan di-set saat add ke request).
  static http.MultipartFile fromBytes(
    String name,
    List<int> bytes, {
    required String filename,
  }) {
    final mime = lookupMimeType(filename) ?? 'application/octet-stream';
    return http.MultipartFile.fromBytes(
      name,
      bytes,
      filename: filename,
      contentType: MediaType.parse(mime),
    );
  }

  /// Dari path → **untuk koleksi** file.
  static Future<http.MultipartFile> fromPath(
    String name,
    String path, {
    String? filename,
  }) async {
    final mime = lookupMimeType(path) ?? 'application/octet-stream';
    return http.MultipartFile.fromPath(
      name,
      path,
      filename: filename,
      contentType: MediaType.parse(mime),
    );
  }
}
</file>

<file path="lib/core/theme/app_theme.dart">
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class AppTheme {
  // Color Palette
  static const Color primaryPurple = Color(0xFF7F55B1);
  static const Color lightPeach = Color(0xFFFFDBB6);
  static const Color creamBackground = Color(0xFFF5F5DC);
  static const Color orangeAccent = Color(0xFFE65100);
  static const Color darkGrey = Color(0xFF424242);
  static const Color lightGrey = Color(0xFF757575);

  // Text Styles
  static TextStyle get headingLarge => GoogleFonts.abrilFatface(
        fontSize: 32,
        color: Colors.white,
        height: 1.2,
      );

  static TextStyle get headingMedium => GoogleFonts.abrilFatface(
        fontSize: 24,
        fontWeight: FontWeight.bold,
        color: Colors.white,
        height: 1.3,
      );

  static TextStyle get bodyLarge => GoogleFonts.roboto(
        fontSize: 16,
        color: Colors.white,
        height: 1.4,
      );

  static TextStyle get bodyMedium => GoogleFonts.roboto(
        fontSize: 14,
        color: lightGrey,
        height: 1.4,
      );

  static TextStyle get buttonText => GoogleFonts.roboto(
        fontSize: 18,
        fontWeight: FontWeight.bold,
        color: orangeAccent,
      );

  static TextStyle get buttonTextPurple => GoogleFonts.roboto(
        fontSize: 18,
        fontWeight: FontWeight.bold,
        color: primaryPurple,
      );

  static TextStyle get subtitle => GoogleFonts.roboto(
        fontSize: 14,
        color: darkGrey,
        height: 1.4,
      );

  // App Theme
  static ThemeData get lightTheme {
    return ThemeData(
      useMaterial3: true,
      colorScheme: ColorScheme.fromSeed(
        seedColor: primaryPurple,
        brightness: Brightness.light,
      ),
      textTheme: TextTheme(
        headlineLarge: headingLarge,
        headlineMedium: headingMedium,
        bodyLarge: bodyLarge,
        bodyMedium: bodyMedium,
        labelLarge: buttonText,
      ),
      appBarTheme: AppBarTheme(
        backgroundColor: Colors.transparent,
        elevation: 0,
        titleTextStyle: GoogleFonts.roboto(
          fontSize: 20,
          fontWeight: FontWeight.bold,
          color: Colors.white,
        ),
        iconTheme: const IconThemeData(color: Colors.white),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: primaryPurple,
          foregroundColor: Colors.white,
          textStyle: GoogleFonts.roboto(
            fontSize: 16,
            fontWeight: FontWeight.bold,
          ),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: primaryPurple, width: 2),
        ),
        labelStyle: GoogleFonts.roboto(
          color: lightGrey,
        ),
        hintStyle: GoogleFonts.roboto(
          color: lightGrey.withValues(alpha: 0.7),
        ),
      ),
      cardTheme: CardThemeData(
        color: creamBackground,
        elevation: 4,
        shadowColor: Colors.black.withValues(alpha: 0.1),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/accounts/presentation/pages/accounts_detail_page.dart">
import 'package:flutter/material.dart';

class AccountsDetailPage extends StatefulWidget {
  final String accountId;

  const AccountsDetailPage({
    super.key,
    required this.accountId,
  });

  @override
  State<AccountsDetailPage> createState() => _AccountsDetailPageState();
}

class _AccountsDetailPageState extends State<AccountsDetailPage> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Detail Akun'),
      ),
      body: const Center(
        child: Text('Accounts Detail Page'),
      ),
    );
  }
}
</file>

<file path="lib/features/accounts/presentation/pages/accounts_request_status_page.dart">
import 'package:flutter/material.dart';

class AccountsRequestStatusPage extends StatefulWidget {
  final String requestId;

  const AccountsRequestStatusPage({
    super.key,
    required this.requestId,
  });

  @override
  State<AccountsRequestStatusPage> createState() => _AccountsRequestStatusPageState();
}

class _AccountsRequestStatusPageState extends State<AccountsRequestStatusPage> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Status Permintaan Akun'),
      ),
      body: const Center(
        child: Text('Accounts Request Status Page'),
      ),
    );
  }
}
</file>

<file path="lib/features/authentication/presentation/pages/login_page.dart">
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:uuid/uuid.dart';

import 'package:sikap/core/auth/session_service.dart';
import 'package:sikap/core/auth/ensure_guest_auth.dart';      // <— penting
import 'package:sikap/core/network/api_exception.dart';

import '../../../home/presentation/pages/home_page.dart';
import 'teacher_login_page.dart';

class LoginPage extends StatefulWidget {
  const LoginPage({super.key});

  @override
  State<LoginPage> createState() => _LoginPageState();
}

class _LoginPageState extends State<LoginPage> {
  final _form = GlobalKey<FormState>();
  final TextEditingController _kodeSekolahController = TextEditingController();
  String? _selectedKelas;
  bool _loading = false;

  final List<String> _kelasList = const ['10', '11', '12'];

  @override
  void dispose() {
    _kodeSekolahController.dispose();
    super.dispose();
  }

  String? _required(String? v) =>
      (v == null || v.trim().isEmpty) ? 'Wajib diisi' : null;

  Future<void> _submit() async {
    if (!_form.currentState!.validate()) return;
    setState(() => _loading = true);

    final session = SessionService();
    try {
      // deviceId stabil: ambil existing; kalau kosong generate
      final prof = await session.loadProfile();
      final deviceId =
          (prof.deviceId ?? '').isNotEmpty ? prof.deviceId! : const Uuid().v4();

      // Simpan profil dari form
      await session.saveProfile(
        schoolCode: _kodeSekolahController.text.trim(), // contoh "SMATS"
        grade: _selectedKelas!.trim(),                  // "10" | "11" | "12"
        deviceId: deviceId,
      );

      // Quick-login → simpan guest_id/token di SessionService
      await ensureGuestAuthenticated();

      if (!mounted) return;
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (_) => const HomePage()),
      );
    } on ApiException catch (e) {
      final hint = e.errors == null
          ? e.message
          : e.errors!.entries.map((kv) => "${kv.key}: ${kv.value}").join("\n");
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(hint), backgroundColor: Colors.red),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(e.toString()), backgroundColor: Colors.red),
        );
      }
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: SafeArea(
        child: SingleChildScrollView(
          child: Column(
            children: [
              // Upper white section with logo
              Container(
                width: double.infinity,
                color: Colors.white,
                padding: const EdgeInsets.symmetric(vertical: 40, horizontal: 24),
                child: Column(
                  children: [
                    // Logo
                    Container(
                      width: 180,
                      height: 180,
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        border: Border.all(
                          color: const Color(0xFFFFDBB6),
                          width: 4,
                        ),
                      ),
                      child: ClipOval(
                        child: Image.asset(
                          'assets/icons/sikap_icon.jpg',
                          fit: BoxFit.cover,
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    Text(
                      'SIKAP',
                      style: GoogleFonts.abrilFatface(
                        fontSize: 32,
                        fontWeight: FontWeight.bold,
                        color: const Color(0xFF4A4A7D),
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'Sistem Informasi Kelola Asa dan Pelaporan',
                      textAlign: TextAlign.center,
                      style: GoogleFonts.roboto(
                        fontSize: 12,
                        color: const Color(0xFFE07B8A),
                        letterSpacing: 0.5,
                      ),
                    ),
                  ],
                ),
              ),

              // Lower blue section with form
              Container(
                width: double.infinity,
                decoration: const BoxDecoration(color: Color(0xFF0066CC)),
                child: Column(
                  children: [
                    const SizedBox(height: 32),
                    // Tombol login guru/kepsek
                    Center(
                      child: ElevatedButton(
                        onPressed: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const TeacherLoginPage(),
                            ),
                          );
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFB678FF),
                          foregroundColor: Colors.white,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          elevation: 0,
                          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                        ),
                        child: Text(
                          'Login sebagai\nGuru/Kepala Sekolah',
                          textAlign: TextAlign.center,
                          style: GoogleFonts.roboto(
                            fontSize: 16,
                            fontWeight: FontWeight.w700,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    Text(
                      'Selamat Datang',
                      style: GoogleFonts.abrilFatface(
                        fontSize: 32,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'Anda sedang login sebagai siswa',
                      style: GoogleFonts.roboto(
                        fontSize: 14,
                        color: Colors.white70,
                        fontWeight: FontWeight.w400,
                      ),
                    ),
                    const SizedBox(height: 24),

                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 24),
                      child: Form(
                        key: _form,
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            // Kode Sekolah
                            Text(
                              'Kode Sekolah',
                              style: GoogleFonts.roboto(
                                fontSize: 16,
                                color: Colors.white,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            const SizedBox(height: 8),
                            TextFormField(
                              controller: _kodeSekolahController,
                              validator: _required,
                              decoration: InputDecoration(
                                filled: true,
                                fillColor: Colors.white,
                                border: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(12),
                                  borderSide: BorderSide.none,
                                ),
                                contentPadding: const EdgeInsets.symmetric(
                                  horizontal: 16,
                                  vertical: 16,
                                ),
                                hintText: "mis. SMATS",
                              ),
                              style: GoogleFonts.roboto(
                                fontSize: 16,
                                color: Colors.black87,
                              ),
                            ),
                            const SizedBox(height: 24),

                            // Kelas
                            Text(
                              'Kelas',
                              style: GoogleFonts.roboto(
                                fontSize: 16,
                                color: Colors.white,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            const SizedBox(height: 8),
                            Container(
                              decoration: BoxDecoration(
                                color: Colors.white,
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: DropdownButtonFormField<String>(
                                value: _selectedKelas,
                                validator: (v) => v == null ? 'Wajib diisi' : null,
                                decoration: InputDecoration(
                                  filled: true,
                                  fillColor: Colors.white,
                                  border: OutlineInputBorder(
                                    borderRadius: BorderRadius.circular(12),
                                    borderSide: BorderSide.none,
                                  ),
                                  contentPadding: const EdgeInsets.symmetric(
                                    horizontal: 16,
                                    vertical: 16,
                                  ),
                                ),
                                hint: Text(
                                  'Pilih Kelas',
                                  style: GoogleFonts.roboto(
                                    fontSize: 16,
                                    color: Colors.black54,
                                  ),
                                ),
                                icon: const Icon(Icons.arrow_drop_down, size: 30),
                                dropdownColor: Colors.white,
                                style: GoogleFonts.roboto(
                                  fontSize: 16,
                                  color: Colors.black87,
                                ),
                                items: _kelasList
                                    .map((kelas) => DropdownMenuItem<String>(
                                          value: kelas,
                                          child: Text('Kelas $kelas'),
                                        ))
                                    .toList(),
                                onChanged: (val) => setState(() => _selectedKelas = val),
                              ),
                            ),
                            const SizedBox(height: 32),

                            // Tombol Login
                            SizedBox(
                              width: double.infinity,
                              height: 54,
                              child: ElevatedButton(
                                onPressed: _loading ? null : _submit,
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: const Color(0xFFFFDBB6),
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  elevation: 0,
                                ),
                                child: _loading
                                    ? const CircularProgressIndicator(color: Color(0xFF0066CC))
                                    : Text(
                                        'Login',
                                        style: GoogleFonts.roboto(
                                          fontSize: 18,
                                          fontWeight: FontWeight.bold,
                                          color: const Color(0xFF0066CC),
                                        ),
                                      ),
                              ),
                            ),
                            const SizedBox(height: 40),

                            Center(
                              child: Text(
                                '© 2025 SIKAP.  All rights reserved.',
                                style: GoogleFonts.roboto(
                                  fontSize: 12,
                                  color: Colors.white70,
                                ),
                              ),
                            ),
                            const SizedBox(height: 24),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/bullying/presentation/pages/bullying_request_status_page.dart">
import 'package:flutter/material.dart';

class BullyingRequestStatusPage extends StatefulWidget {
  final String requestId;

  const BullyingRequestStatusPage({
    super.key,
    required this.requestId,
  });

  @override
  State<BullyingRequestStatusPage> createState() => _BullyingRequestStatusPageState();
}

class _BullyingRequestStatusPageState extends State<BullyingRequestStatusPage> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Status Laporan Bullying'),
      ),
      body: const Center(
        child: Text('Bullying Request Status Page'),
      ),
    );
  }
}
</file>

<file path="lib/features/home/presentation/widgets/feature_button_placeholder.dart">
import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';
import '../../../../core/theme/app_theme.dart';

class FeatureButtonPlaceholder extends StatelessWidget {
  final String title;
  final String subtitle;
  final IconData icon;
  final VoidCallback onTap;
  final bool isSettings;
  final String? svgAsset;
  final Color? backgroundColor;
  final Color? textColor;
  final Color? iconColor;
  final bool filled;

  const FeatureButtonPlaceholder({
    super.key,
    required this.title,
    required this.subtitle,
    required this.icon,
    required this.onTap,
    this.isSettings = false,
    this.svgAsset,
    this.backgroundColor,
    this.textColor,
    this.iconColor,
    this.filled = false,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: backgroundColor ?? AppTheme.creamBackground,
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.1),
              blurRadius: 8,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Row(
          children: [
            // Icon/SVG container
            filled
                ? SizedBox(
                    width: 60,
                    height: 60,
                    child: Center(
                      child: svgAsset != null
                          ? SvgPicture.asset(
                              svgAsset!,
                              width: 36,
                              height: 36,
                              fit: BoxFit.contain,
                              colorFilter: iconColor != null
                                  ? ColorFilter.mode(iconColor!, BlendMode.srcIn)
                                  : null,
                            )
                          : Icon(
                              icon,
                              size: 24,
                              color: iconColor ?? (isSettings ? AppTheme.primaryPurple : Colors.grey[600]),
                            ),
                    ),
                  )
                : Container(
                    width: 60,
                    height: 60,
                    decoration: BoxDecoration(
                      color: Colors.grey.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(30),
                      border: Border.all(
                        color: Colors.grey.withValues(alpha: 0.3),
                        width: 2,
                        style: BorderStyle.solid,
                      ),
                    ),
                    child: Center(
                      child: svgAsset != null
                          ? SvgPicture.asset(
                              svgAsset!,
                              width: 36,
                              height: 36,
                              fit: BoxFit.contain,
                            )
                          : Icon(
                              icon,
                              size: 24,
                              color: isSettings ? AppTheme.primaryPurple : Colors.grey[600],
                            ),
                    ),
                  ),
            const SizedBox(width: 16),
            // Text content
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: (isSettings ? AppTheme.buttonTextPurple : AppTheme.buttonText).copyWith(
                      color: textColor ?? (isSettings ? AppTheme.primaryPurple : AppTheme.orangeAccent),
                    ),
                  ),
                  if (!isSettings) ...[
                    const SizedBox(height: 4),
                    Text(
                      subtitle,
                      style: AppTheme.subtitle,
                    ),
                  ],
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/wellbeing_resources/presentation/pages/artikel_info_page.dart">
import 'package:flutter/material.dart';
import 'artikel_bullying_detail_page.dart';

class ArtikelInfoPage extends StatefulWidget {
  const ArtikelInfoPage({super.key});

  @override
  State<ArtikelInfoPage> createState() => _ArtikelInfoPageState();
}

class _ArtikelInfoPageState extends State<ArtikelInfoPage> {
  String selectedCategory = 'Kesehatan Mental dan Kesejahteraan';

  final List<String> categories = [
    'Kesehatan Mental dan Kesejahteraan',
    'Memahami Bullying',
    'Mendapatkan Bantuan',
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFF7F55B1),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20.0, vertical: 16),
          child: Center(
            child: ConstrainedBox(
              constraints: const BoxConstraints(maxWidth: 820),
              child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header Section
              Row(
                children: [
                  IconButton(
                    onPressed: () => Navigator.of(context).pop(),
                    icon: const Icon(Icons.arrow_back, color: Colors.white),
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text(
                          'Artikel & Info',
                          style: TextStyle(
                            fontSize: 28,
                            fontWeight: FontWeight.w800,
                            color: Colors.white,
                            fontFamily: 'serif',
                          ),
                        ),
                        const SizedBox(height: 4),
                        const Text(
                          'Akses beragam konten tentang kesehatan mental.',
                          style: TextStyle(
                            fontSize: 14,
                            color: Colors.white,
                            fontWeight: FontWeight.w400,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 24),
              
              // Category Section
              Row(
                children: [
                  const Text(
                    'Kategori:',
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                      color: Colors.white,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: SizedBox(
                      height: 40,
                      child: ListView.builder(
                        scrollDirection: Axis.horizontal,
                        itemCount: categories.length,
                        itemBuilder: (context, index) {
                          final category = categories[index];
                          final isSelected = selectedCategory == category;
                          
                          return Padding(
                            padding: const EdgeInsets.only(right: 8),
                            child: GestureDetector(
                              onTap: () {
                                setState(() {
                                  selectedCategory = category;
                                });
                              },
                              child: Container(
                                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                                decoration: BoxDecoration(
                                  color: isSelected 
                                    ? const Color(0xFFF5F5DC) // Light beige when selected
                                    : const Color(0xFFE6D7FF), // Light purple when not selected
                                  borderRadius: BorderRadius.circular(20),
                                  border: Border.all(
                                    color: isSelected 
                                      ? const Color(0xFF7F55B1)
                                      : const Color(0xFF7F55B1).withValues(alpha: 0.7),
                                    width: 1,
                                  ),
                                ),
                                child: Text(
                                  category,
                                  style: TextStyle(
                                    fontSize: 12,
                                    fontWeight: FontWeight.w600,
                                    color: const Color(0xFF7F55B1),
                                  ),
                                ),
                              ),
                            ),
                          );
                        },
                      ),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 24),
              
              // Article Cards Section
              Expanded(
                child: ListView(
                  children: [
                    _buildArticleCard(
                      title: 'Bukan Salahmu: Memahami Apa Itu Bullying dan Mengapa Itu Terjadi',
                      category: 'Memahami Bullying',
                      date: 'Diposting pada 6 Agustus 2025',
                      illustration: _buildBullyingIllustration(),
                      onTap: () {
                        Navigator.push(
                          context,
                          MaterialPageRoute(
                            builder: (context) => const ArtikelBullyingDetailPage(),
                          ),
                        );
                      },
                    ),
                    const SizedBox(height: 16),                    
                    _buildArticleCard(
                      title: '10 Cara Mengendalikan Stres Saat Sekolah Terasa Berat',
                      category: 'Kesehatan Mental dan Kesejahteraan',
                      date: 'Diposting pada 15 Agustus 2025',
                      illustration: _buildStressIllustration(),
                    ),                    
                    const SizedBox(height: 16),
                    _buildArticleCard(
                      title: 'Kapan dan Bagaimana Mencari Bantuan Profesional',
                      category: 'Mendapatkan Bantuan',
                      date: 'Diposting pada 20 Juli 2025',
                      illustration: _buildHelpIllustration(),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
        ),
        ),
        ),
    );
  }

  Widget _buildArticleCard({
    required String title,
    required String category,
    required String date,
    required Widget illustration,
    VoidCallback? onTap,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
      width: double.infinity,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.18),
            blurRadius: 18,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(20),
        child: Column(
        children: [
          // Illustration Section
          Container(
            height: 120,
            decoration: const BoxDecoration(
              color: Color(0xFFF5F5DC), // Light beige
              // Top radius handled by ClipRRect
            ),
            child: Center(child: illustration),
          ),
          // Content Section
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: const BoxDecoration(
              color: Color(0xFFE6D7FF), // Light purple
              // Bottom radius handled by ClipRRect
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Category Tag
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: const Color(0xFF7F55B1),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Text(
                    category,
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 12,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
                const SizedBox(height: 12),
                // Title
                Text(
                  title,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w800,
                    color: Colors.black87,
                    height: 1.3,
                  ),
                ),
                const SizedBox(height: 8),
                // Date
                Text(
                  date,
                  style: const TextStyle(
                    fontSize: 12,
                    color: Colors.black54,
                    fontWeight: FontWeight.w400,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
      ),
    ),
    );
  }

  Widget _buildStressIllustration() {
    return Container(
      width: 80,
      height: 80,
      decoration: BoxDecoration(
        color: Colors.red.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
      ),
      child: const Icon(
        Icons.psychology,
        size: 40,
        color: Colors.red,
      ),
    );
  }

  Widget _buildBullyingIllustration() {
    return Container(
      width: 80,
      height: 80,
      decoration: BoxDecoration(
        color: Colors.orange.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
      ),
      child: const Icon(
        Icons.warning,
        size: 40,
        color: Colors.orange,
      ),
    );
  }

  Widget _buildHelpIllustration() {
    return Container(
      width: 80,
      height: 80,
      decoration: BoxDecoration(
        color: Colors.green.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
      ),
      child: const Icon(
        Icons.support_agent,
        size: 40,
        color: Colors.green,
      ),
    );
  }
}
</file>

<file path="lib/features/wellbeing_resources/presentation/pages/wellbeing_resources_request_status_page.dart">
import 'package:flutter/material.dart';

class WellbeingResourcesRequestStatusPage extends StatefulWidget {
  final String requestId;

  const WellbeingResourcesRequestStatusPage({
    super.key,
    required this.requestId,
  });

  @override
  State<WellbeingResourcesRequestStatusPage> createState() => _WellbeingResourcesRequestStatusPageState();
}

class _WellbeingResourcesRequestStatusPageState extends State<WellbeingResourcesRequestStatusPage> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Status Sumber Daya'),
      ),
      body: const Center(
        child: Text('Wellbeing Resources Request Status Page'),
      ),
    );
  }
}
</file>

<file path="lib/core/network/api_env.dart">
/// lib/core/network/api_env.dart
class ApiEnv {
  // Baca ENV dari --dart-define (production | staging | development)
  static const String _env =
      String.fromEnvironment('ENV', defaultValue: 'production');

  // NOTE: tanpa trailing slash agar tidak jadi double // saat join endpoint
  static const Map<String, String> _baseUrls = {
    'production': 'https://sikap-backend-production.up.railway.app',
    'staging': 'https://sikap-backend-dev.up.railway.app',
    'development': 'http://127.0.0.1:8000',
  };

  static String get baseUrl => _baseUrls[_env] ?? _baseUrls['production']!;

  static const Duration connectTimeout = Duration(seconds: 12);
  static const Duration readTimeout = Duration(seconds: 20);

  static void printActiveEnv() {
    // ignore: avoid_print
    print("Active API Environment: $_env → $baseUrl");
  }
}
</file>

<file path="lib/features/bullying/data/repositories/bullying_repository.dart">
// lib/features/bullying/data/repositories/bullying_repository.dart
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/auth_header_provider.dart';

import '../models/bullying_create_response.dart';
import '../models/bullying_detail_response.dart';
import '../models/bullying_list_response.dart';
import '../models/bullying_model.dart';

class BullyingRepository {
  final ApiClient apiClient;
  final AuthHeaderProvider auth;

  BullyingRepository({required this.apiClient, required this.auth});

  // =========================
  // G U E S T   E N D P O I N T S
  // =========================

  /// GET /api/bullying/incident-types/
  /// Guest-allowed. Kembalikan list map sederhana (id, type_name, dst).
  Future<List<Map<String, dynamic>>> getIncidentTypes({bool asGuest = true}) async {
    final headers = await auth.buildHeaders(asGuest: asGuest);
    final resp = await apiClient.get<List<dynamic>>(
      '/api/bullying/incident-types/',
      headers: headers,
      transform: (raw) => raw as List<dynamic>,
    );
    return resp.data.map((e) => Map<String, dynamic>.from(e as Map)).toList();
  }

  /// POST /api/bullying/report/
  /// HARUS menyertakan: guest_id, incident_type_id (INT), description(>=10), location(>=2), severity, confirm_truth
  Future<BullyingCreateResponse> createBullyingReport(
    Map<String, dynamic> data, {
    bool asGuest = true,
  }) async {
    final headers = await auth.buildHeaders(asGuest: asGuest);
    final resp = await apiClient.post<Map<String, dynamic>>(
      '/api/bullying/report/',
      data,
      headers: headers,
      transform: (raw) => raw as Map<String, dynamic>,
    );
    return BullyingCreateResponse.fromJson(
      {'success': true, 'message': '', 'data': resp.data},
    );
  }

  /// GET /api/bullying/report/history/{guest_id}/
  /// Ini cara paling aman untuk “my reports” pada guest flow.
  Future<BullyingListResponse> getGuestHistory({
    required int guestId,
    bool asGuest = true,
  }) async {
    final headers = await auth.buildHeaders(asGuest: asGuest);
    final resp = await apiClient.get<List<dynamic>>(
      '/api/bullying/report/history/$guestId/',
      headers: headers,
      transform: (raw) => raw as List<dynamic>,
    );
    return BullyingListResponse.fromJson(
      {'success': true, 'message': '', 'data': resp.data},
    );
  }

  /// GET /api/bullying/report/{id}/
  /// Detail laporan guest (header harus X-Guest-Token).
  Future<BullyingDetailResponse> getBullyingDetail(
    String id, {
    bool asGuest = true,
  }) async {
    final headers = await auth.buildHeaders(asGuest: asGuest);
    final resp = await apiClient.get<Map<String, dynamic>>(
      '/api/bullying/report/$id/',
      headers: headers,
      transform: (raw) => raw as Map<String, dynamic>,
    );
    return BullyingDetailResponse.fromJson(
      {'success': true, 'message': '', 'data': resp.data},
    );
  }

  // =========================
  // S T A F F   E N D P O I N T S
  // =========================

  /// GET /api/bullying/cases/?status=&incident_type=&created_at__gte=&created_at__lte=
  /// STAFF-ONLY (Authorization: Bearer ...). asGuest default = false.
  Future<BullyingListResponse> getBullyingCases({
    String? status,
    String? incidentType,
    String? createdAtGte,
    String? createdAtLte,
    bool asGuest = false, // <- staff by default
  }) async {
    final params = <String>[];
    if (status != null) params.add('status=$status');
    if (incidentType != null) params.add('incident_type=$incidentType');
    if (createdAtGte != null) params.add('created_at__gte=$createdAtGte');
    if (createdAtLte != null) params.add('created_at__lte=$createdAtLte');
    final q = params.isNotEmpty ? '?${params.join('&')}' : '';

    final headers = await auth.buildHeaders(asGuest: asGuest);
    final resp = await apiClient.get<List<dynamic>>(
      '/api/bullying/cases/$q',
      headers: headers,
      transform: (raw) => raw as List<dynamic>,
    );
    return BullyingListResponse.fromJson(
      {'success': true, 'message': '', 'data': resp.data},
    );
  }

  /// PATCH /api/bullying/report/{id}/
  /// STAFF-ONLY untuk edit konten laporan (jika diizinkan). Pakai Bearer.
  Future<BullyingModel> updateBullyingReport(
    String id,
    Map<String, dynamic> data, {
    bool asGuest = false, // staff
  }) async {
    final headers = await auth.buildHeaders(asGuest: asGuest);
    final resp = await apiClient.patch<Map<String, dynamic>>(
      '/api/bullying/report/$id/',
      data,
      headers: headers,
      transform: (raw) => raw as Map<String, dynamic>,
    );
    return BullyingModel.fromJson(resp.data);
  }

  /// “Soft delete”/aksi lain yang di-backend di-protect (staff).
  Future<bool> deleteBullyingReport(
    String id, {
    bool asGuest = false, // staff
  }) async {
    final headers = await auth.buildHeaders(asGuest: asGuest);
    await apiClient.patch(
      '/api/bullying/report/$id/delete/',
      {},
      headers: headers,
    );
    return true;
  }

  // =========================
  // (Opsional) Tetap sediakan "my" untuk kasus token-derived di BE.
  // Catatan: hanya bekerja jika backend benar-benar mendukung "my"
  // berbasis guest token. Kalau ragu, pakai getGuestHistory().
  // =========================
  Future<BullyingListResponse> getMyBullyingReports({bool asGuest = true}) async {
    final headers = await auth.buildHeaders(asGuest: asGuest);
    final resp = await apiClient.get<List<dynamic>>(
      '/api/bullying/report/my/',
      headers: headers,
      transform: (raw) => raw as List<dynamic>,
    );
    return BullyingListResponse.fromJson(
      {'success': true, 'message': '', 'data': resp.data},
    );
  }
}
</file>

<file path="lib/features/bullying/presentation/pages/bullying_reports_list_page.dart">
import 'package:flutter/material.dart';
import 'package:sikap/features/bullying/presentation/pages/bullying_detail_page.dart';
import 'package:sikap/features/bullying/presentation/pages/bullying_report_wizard_page.dart';
import 'package:sikap/features/bullying/data/repositories/bullying_repository.dart';
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/auth_header_provider.dart';

class BullyingReportsListPage extends StatefulWidget {
  const BullyingReportsListPage({super.key});

  @override
  State<BullyingReportsListPage> createState() =>
      _BullyingReportsListPageState();
}

class _BullyingReportsListPageState extends State<BullyingReportsListPage> {
  late final BullyingRepository repo;
  bool _isLoading = true;
  List<_ReportItem> _all = [];

  String _filter = 'Semua';
  String _sort = 'Terbaru';

  @override
  void initState() {
    super.initState();
    repo = BullyingRepository(
        apiClient: ApiClient(),
        auth: AuthHeaderProvider(
            loadUserToken: () async => null, loadGuestToken: () async => null));
    _loadReports();
  }

  Future<void> _loadReports() async {
    try {
      print("[DEBUG] Loading bullying reports");
      final result = await repo.getMyBullyingReports(asGuest: true);
      print("[DEBUG] Loaded reports: ${result.data}");
      if (result.success && result.data != null) {
        setState(() {
          _all = result.data!
              .map((item) => _ReportItem.fromJson(item as Map<String, dynamic>))
              .toList();
          _isLoading = false;
        });
      } else {
        setState(() => _isLoading = false);
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(SnackBar(
              content: Text('Failed to load reports: ${result.message}')));
        }
      }
    } catch (e) {
      print("[DEBUG] Error loading reports: $e");
      setState(() => _isLoading = false);
      if (mounted) {
        ScaffoldMessenger.of(context)
            .showSnackBar(SnackBar(content: Text('Error loading reports: $e')));
      }
    }
  }

  List<_ReportItem> get _filteredSorted {
    List<_ReportItem> list =
        _all.where((c) => _filter == 'Semua' || c.status == _filter).toList();
    list.sort((a, b) => _sort == 'Terbaru'
        ? b.createdAt.compareTo(a.createdAt)
        : a.createdAt.compareTo(b.createdAt));
    return list;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Laporan Bullying'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () {
          Navigator.push(
            context,
            MaterialPageRoute(
                builder: (context) => const BullyingReportWizardPage()),
          );
        },
        backgroundColor: const Color(0xFFC89EFF),
        foregroundColor: Colors.white,
        label: const Text('Buat Laporan'),
        icon: const Icon(Icons.add),
      ),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFF7F55B1), Color(0xFFFFDBB6)],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: _isLoading
              ? const Center(child: CircularProgressIndicator())
              : Padding(
                  padding: const EdgeInsets.symmetric(
                      horizontal: 16.0, vertical: 12),
                  child: Column(
                    children: [
                      Row(
                        children: [
                          Expanded(
                              child: _buildPillButton(
                                  icon: Icons.filter_list,
                                  label: 'Filter',
                                  onTap: _showFilterDialog)),
                          const SizedBox(width: 12),
                          Expanded(
                              child: _buildPillButton(
                                  icon: Icons.sort,
                                  label: 'Urutkan',
                                  onTap: _showSortDialog)),
                        ],
                      ),
                      const SizedBox(height: 16),
                      Expanded(
                        child: ListView.builder(
                          itemCount: _filteredSorted.length,
                          itemBuilder: (context, index) {
                            final item = _filteredSorted[index];
                            return _ReportCard(item: item);
                          },
                        ),
                      ),
                    ],
                  ),
                ),
        ),
      ),
    );
  }

  Widget _buildPillButton(
      {required IconData icon,
      required String label,
      required VoidCallback onTap}) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        height: 44,
        decoration: BoxDecoration(
          color: Colors.white.withValues(alpha: 0.8),
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
                color: Colors.black.withValues(alpha: 0.08),
                blurRadius: 8,
                offset: const Offset(0, 2)),
          ],
        ),
        padding: const EdgeInsets.symmetric(horizontal: 16),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, color: const Color(0xFF7F55B1)),
            const SizedBox(width: 8),
            Text(label,
                style: const TextStyle(
                    color: Colors.black87, fontWeight: FontWeight.w600)),
          ],
        ),
      ),
    );
  }

  void _showFilterDialog() {
    showDialog(
      context: context,
      builder: (context) {
        return SimpleDialog(
          title: const Text('Filter status'),
          children: [
            RadioGroup<String>(
              groupValue: _filter,
              onChanged: (val) {
                if (val == null) return;
                setState(() => _filter = val);
                Navigator.pop(context);
              },
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  ...['Semua', 'Baru', 'Diproses', 'Selesai', 'Ditolak'].map(
                    (s) => RadioListTile<String>(
                      title: Text(s),
                      value: s,
                    ),
                  ),
                ],
              ),
            ),
          ],
        );
      },
    );
  }

  void _showSortDialog() {
    showDialog(
      context: context,
      builder: (context) {
        return SimpleDialog(
          title: const Text('Urutkan'),
          children: [
            RadioGroup<String>(
              groupValue: _sort,
              onChanged: (val) {
                if (val == null) return;
                setState(() => _sort = val);
                Navigator.pop(context);
              },
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  ...['Terbaru', 'Terlama'].map(
                    (s) => RadioListTile<String>(
                      title: Text(s),
                      value: s,
                    ),
                  ),
                ],
              ),
            ),
          ],
        );
      },
    );
  }
}

class _ReportItem {
  _ReportItem({
    required this.id,
    required this.status,
    required this.title,
    required this.createdAt,
    required this.category,
    required this.description,
    required this.evidences,
    required this.anonymous,
    required this.confirmTruth,
    this.teacherComment,
    this.teacherCommentDate,
  });

  final String id;
  final String status;
  final String title;
  final DateTime createdAt;
  final String category;
  final String description;
  final List<String> evidences;
  final bool anonymous;
  final bool confirmTruth;
  final String? teacherComment;
  final DateTime? teacherCommentDate;

  factory _ReportItem.fromJson(Map<String, dynamic> json) {
    return _ReportItem(
      id: json['id']?.toString() ?? '',
      status: json['status'] ?? '',
      title: json['title'] ?? '',
      createdAt: DateTime.tryParse(json['created_at'] ?? '') ?? DateTime.now(),
      category: json['incident_type'] ?? '',
      description: json['description'] ?? '',
      evidences: List<String>.from(json['evidences'] ?? []),
      anonymous: json['anonymous'] ?? false,
      confirmTruth: json['confirm_truth'] ?? false,
      teacherComment: json['teacher_comment'],
      teacherCommentDate: json['teacher_comment_date'] != null
          ? DateTime.tryParse(json['teacher_comment_date'])
          : null,
    );
  }
}

class _ReportCard extends StatelessWidget {
  const _ReportCard({required this.item});
  final _ReportItem item;

  Color get statusColor {
    switch (item.status) {
      case 'Baru':
        return const Color(0xFF2196F3);
      case 'Diproses':
        return const Color(0xFFFF9800);
      case 'Selesai':
        return const Color(0xFF2E7D32);
      case 'Ditolak':
        return const Color(0xFFD32F2F);
      default:
        return Colors.grey;
    }
  }

  static String _formatDate(DateTime dt) {
    String two(int n) => n.toString().padLeft(2, '0');
    return '${dt.year}-${two(dt.month)}-${two(dt.day)} ${two(dt.hour)}:${two(dt.minute)}:${two(dt.second)}';
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () {
        Navigator.of(context).push(
          MaterialPageRoute(
            builder: (context) => BullyingDetailPage(id: item.id),
          ),
        );
      },
      child: Container(
        margin: const EdgeInsets.only(bottom: 12),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
                color: Colors.black.withValues(alpha: 0.1),
                blurRadius: 12,
                offset: const Offset(0, 4)),
          ],
        ),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Container(
                padding:
                    const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                decoration: BoxDecoration(
                    color: statusColor.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(20)),
                child: Text(item.status,
                    style: TextStyle(
                        color: statusColor,
                        fontWeight: FontWeight.w700,
                        fontSize: 12)),
              ),
              const SizedBox(height: 8),
              Text(item.title,
                  style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w800,
                      color: Colors.black87)),
              const SizedBox(height: 8),
              Row(
                children: [
                  const Icon(Icons.edit_calendar,
                      size: 18, color: Colors.black45),
                  const SizedBox(width: 8),
                  Text(_formatDate(item.createdAt),
                      style: const TextStyle(color: Colors.black45)),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/home/presentation/pages/home_teacher_page.dart">
import 'package:flutter/material.dart';
import '../../../../core/theme/app_theme.dart';
import '../widgets/feature_button_placeholder.dart';
import '../../../cases/presentation/pages/case_list_page.dart';
import '../../../reflections/presentation/reflection_scenario.dart';
import '../../../dashboard/presentation/dashboard_global.dart';
import '../../../authentication/presentation/pages/login_page.dart';

class HomeTeacherPage extends StatefulWidget {
  const HomeTeacherPage({super.key});

  @override
  State<HomeTeacherPage> createState() => _HomeTeacherPageState();
}

class _HomeTeacherPageState extends State<HomeTeacherPage> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFFFE7CE),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF7F55B1), // Purple at 76%
              Color(0xFFFFE7CE), // Soft cream at 100%
            ],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20.0),
            child: SingleChildScrollView(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const SizedBox(height: 40),
                  // Title
                  Text(
                    'Selamat Datang\ndi Dasbor Guru',
                    style: AppTheme.headingLarge,
                  ),
                  const SizedBox(height: 16),
                  // Subtitle
                  Text(
                    'Kelola kasus dan refleksi siswa dari satu tempat.',
                    style: AppTheme.bodyLarge,
                  ),
                  const SizedBox(height: 24),
                  // Buttons Section
                  Column(
                    children: [
                      // Dashboard Bullying Button - placeholder style
                      FeatureButtonPlaceholder(
                        title: 'Dasbor Bullying',
                        subtitle: 'Insight laporan bullying sekolah',
                        icon: Icons.analytics,
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const DashboardGlobalPage(),
                            ),
                          );
                        },
                      ),
                      const SizedBox(height: 16),
                      // Lihat Kasus Button - gunakan placeholder style
                      FeatureButtonPlaceholder(
                        title: 'Lihat Kasus',
                        subtitle: 'Tinjau dan kelola laporan siswa',
                        icon: Icons.folder_open,
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const CasesListPage(),
                            ),
                          );
                        },
                      ),
                      const SizedBox(height: 16),
                      // Lihat Refleksi Siswa Button - placeholder style
                      FeatureButtonPlaceholder(
                        title: 'Lihat Refleksi Siswa',
                        subtitle: 'Pantau refleksi dan kemajuan emosi',
                        icon: Icons.insights,
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const ReflectionScenarioPage(),
                            ),
                          );
                        },
                      ),
                      const SizedBox(height: 16),
                      // Logout Button
                      FeatureButtonPlaceholder(
                        title: 'Log Out',
                        subtitle: '',
                        icon: Icons.logout,
                        isSettings: true,
                        backgroundColor: const Color(0xFFB678FF),
                        textColor: Colors.white,
                        iconColor: Colors.white,
                        filled: true,
                        onTap: () {
                          Navigator.pushAndRemoveUntil(
                            context,
                            MaterialPageRoute(builder: (context) => const LoginPage()),
                            (route) => false,
                          );
                        },
                      ),
                      const SizedBox(height: 16),
                    ],
                  ),
                  const SizedBox(height: 20),
                  // Bottom Section - Copyright
                  const Padding(
                    padding: EdgeInsets.only(bottom: 20),
                    child: Center(
                      child: Text(
                        '© 2025 SIKAP. All rights reserved.',
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.white70,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/mood_check/presentation/pages/mood_check_recording_page.dart">
import 'package:flutter/material.dart';
import 'dart:io';
import 'package:flutter_svg/flutter_svg.dart';
import 'package:sikap/core/network/auth_header_provider.dart';
import 'package:sikap/core/network/multipart_client.dart';
import 'package:sikap/features/venting/data/repositories/venting_repository.dart';
import 'mood_check_result_page.dart';
import 'package:record/record.dart';
import 'package:path_provider/path_provider.dart';

class MoodCheckRecordingPage extends StatefulWidget {
  const MoodCheckRecordingPage({super.key});

  @override
  State<MoodCheckRecordingPage> createState() => _MoodCheckRecordingPageState();
}

class _MoodCheckRecordingPageState extends State<MoodCheckRecordingPage> {
  bool _uploading = false;
  late final VentingRepository _repo;
  late final AudioRecorder _recorder;

  @override
  void initState() {
    super.initState();
    final multipart = MultipartClient();
    final auth = AuthHeaderProvider(
      loadUserToken: () async => null,
      loadGuestToken: () async => null,
    );
    _repo = VentingRepository(multipartClient: multipart, auth: auth);
    _recorder = AudioRecorder();
    _startRecording();
  }
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF7F55B1), // Purple at 76%
              Color(0xFFFFDBB6), // Light peach/orange at 100%
            ],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: Stack(
            children: [
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20.0),
                child: SingleChildScrollView(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const SizedBox(height: 60), // Space for back button
                      const SizedBox(height: 80),
                      // Recording Status Text
                      const Text(
                        'Rekaman suara sedang berlangsung.',
                        style: TextStyle(
                          fontSize: 18,
                          color: Colors.white,
                          fontWeight: FontWeight.bold,
                        ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 16),
                      // Instruction Text
                      const Text(
                        'Tekan ikon di bawah untuk menghentikan rekaman.',
                        style: TextStyle(
                          fontSize: 16,
                          color: Colors.white,
                        ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 60),
                      // Recording Button - Centered
                      Center(
                        child: Container(
                          width: 120,
                          height: 120,
                          decoration: const BoxDecoration(
                            color: Colors.white,
                            shape: BoxShape.circle,
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black26,
                                blurRadius: 10,
                                offset: Offset(0, 4),
                              ),
                            ],
                          ),
                          child: Material(
                            color: Colors.transparent,
                            child: InkWell(
                              borderRadius: BorderRadius.circular(60),
                              onTap: _uploading ? null : _showStopRecordingDialog,
                              child: Center(
                                child: SizedBox(
                                  width: 40,
                                  height: 40,
                                  child: SvgPicture.asset(
                                    'assets/icons/speak-ai-fill.svg',
                                    fit: BoxFit.contain,
                                    allowDrawingOutsideViewBox: true,
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(height: 80),
                      // Bottom Section - Copyright
                      const Padding(
                        padding: EdgeInsets.only(bottom: 20),
                        child: Center(
                          child: Text(
                            '© 2025 SIKAP. All rights reserved.',
                            textAlign: TextAlign.center,
                            style: TextStyle(
                              fontSize: 12,
                              color: Colors.white70,
                            ),
                          ),
                        ),
                      ),
                      // Additional space to ensure scrolling
                      const SizedBox(height: 100),
                    ],
                  ),
                ),
              ),
              // Custom Back Button
              Positioned(
                top: 0,
                left: 0,
                child: SafeArea(
                  child: Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: Container(
                      decoration: BoxDecoration(
                        color: Colors.black.withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: IconButton(
                        icon: const Icon(
                          Icons.chevron_left,
                          color: Colors.white,
                          size: 28,
                        ),
                        onPressed: () {
                          Navigator.of(context).pop();
                        },
                      ),
                    ),
                  ),
                ),
              ),
              if (_uploading)
                Container(
                  color: Colors.black.withValues(alpha: 0.4),
                  child: const Center(
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        CircularProgressIndicator(color: Colors.white),
                        SizedBox(height: 12),
                        Text('Mengunggah dan menganalisis...', style: TextStyle(color: Colors.white)),
                      ],
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }

  void _showStopRecordingDialog() {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: const Text('Hentikan Rekaman'),
          content: const Text('Apakah kamu yakin ingin menghentikan rekaman?'),
          actions: [
            TextButton(
              onPressed: () {
                Navigator.of(context).pop();
              },
              child: const Text('Batal'),
            ),
            TextButton(
              onPressed: () {
                Navigator.of(context).pop();
                _stopAndAnalyze();
              },
              child: const Text('Hentikan'),
            ),
          ],
        );
      },
    );
  }

  Future<void> _stopAndAnalyze() async {
    if (_uploading) return;
    setState(() => _uploading = true);
    try {
      final path = await _stopRecording();
      if (path == null || path.isEmpty) {
        throw Exception('Gagal mendapatkan file rekaman');
      }
      final audioFile = File(path);

      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] Start analyze upload: ${audioFile.path}');

      final result = await _repo.analyzeAudio(audioFile, asGuest: true);

      // [DEBUG]
      // ignore: avoid_print
      print('[DEBUG] Analyze result received: keys=${result.keys.toList()}');

      if (!mounted) return;
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(
          builder: (context) => MoodCheckResultPage(result: result),
        ),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Gagal menganalisis: $e')),
      );
    } finally {
      if (mounted) setState(() => _uploading = false);
    }
  }

  Future<void> _startRecording() async {
    try {
      final hasPerm = await _recorder.hasPermission();
      if (!hasPerm) {
        // ignore: avoid_print
        print('[DEBUG] Microphone permission denied');
        return;
      }
  final dir = await getTemporaryDirectory();
  final filename = 'venting_${DateTime.now().millisecondsSinceEpoch}.m4a';
  final path = '${dir.path}/$filename';
  await _recorder.start(const RecordConfig(encoder: AudioEncoder.aacLc), path: path);
      // ignore: avoid_print
      print('[DEBUG] Recording started');
    } catch (e) {
      // ignore: avoid_print
      print('[DEBUG] Failed to start recording: $e');
    }
  }

  Future<String?> _stopRecording() async {
    try {
  final path = await _recorder.stop();
      // ignore: avoid_print
      print('[DEBUG] Recording stopped: $path');
      return path;
    } catch (e) {
      // ignore: avoid_print
      print('[DEBUG] Failed to stop recording: $e');
      return null;
    }
  }
}
</file>

<file path="lib/features/venting/data/repositories/venting_repository.dart">
// lib/features/venting/data/repositories/venting_repository.dart
import 'dart:typed_data';
import 'package:flutter/foundation.dart' show kIsWeb;

import 'package:sikap/core/network/auth_header_provider.dart';
import 'package:sikap/core/network/multipart_client.dart';

class VentingRepository {
  final MultipartClient multipartClient;
  final AuthHeaderProvider auth;

  VentingRepository({
    required this.multipartClient,
    required this.auth,
  });

  /// === WEB: kirim dari bytes + filename (hasil FilePicker/XFile) ===
  Future<Map<String, dynamic>> analyzeAudioFromBytes(
    Uint8List bytes, {
    required String filename,
    bool asGuest = true,
  }) async {
  final headers = await auth.buildHeaders(asGuest: asGuest);
    final mp = MultipartClient.fromBytesSingle('file', bytes, filename: filename);

    final resp = await multipartClient.postFile(
      endpoint: '/api/venting/analyze/',
      file: mp,
      fieldName: 'file',
      headers: headers,
    );

    return Map<String, dynamic>.from(resp.data as Map);
  }

  /// === MOBILE/DESKTOP: kirim dari path file lokal ===
  Future<Map<String, dynamic>> analyzeAudioFromPath(
    String path, {
    String? filename,
    bool asGuest = true,
  }) async {
    if (kIsWeb) {
      throw UnsupportedError('Gunakan analyzeAudioFromBytes() di Web');
    }

  final headers = await auth.buildHeaders(asGuest: asGuest);
    final mp = await MultipartClient.fromPathSingle('file', path, filename: filename);

    final resp = await multipartClient.postFile(
      endpoint: '/api/venting/analyze/',
      file: mp,
      fieldName: 'file',
      headers: headers,
    );

    return Map<String, dynamic>.from(resp.data as Map);
  }

  /// === KOMPATIBILITAS: method lama yang UI kamu panggil ===
  /// - WEB: terima PlatformFile (punya .bytes/.name) atau langsung Uint8List.
  /// - MOBILE/DESKTOP: terima objek yang punya .path (XFile/File) atau String path.
  Future<Map<String, dynamic>> analyzeAudio(
    dynamic audio, {
    bool asGuest = true,
  }) async {
    if (kIsWeb) {
      // Coba: PlatformFile (file_picker) -> .bytes & .name
      try {
        final dyn = audio as dynamic;
        final Uint8List? bytes = dyn.bytes as Uint8List?;
        final String? name = dyn.name as String?;
        if (bytes != null) {
          return analyzeAudioFromBytes(bytes, filename: name ?? 'audio.wav', asGuest: asGuest);
        }
      } catch (_) {
        // fallback di bawah
      }

      // Coba: langsung Uint8List
      if (audio is Uint8List) {
        return analyzeAudioFromBytes(audio, filename: 'audio.wav', asGuest: asGuest);
      }

      throw UnsupportedError(
        'Di Web, berikan PlatformFile (punya .bytes/.name) atau Uint8List.',
      );
    } else {
      // Coba: objek yang punya .path (XFile/File)
      try {
        final dyn = audio as dynamic;
        final String? path = dyn.path as String?;
        final String? name = dyn.name as String?;
        if (path != null && path.isNotEmpty) {
          return analyzeAudioFromPath(path, filename: name, asGuest: asGuest);
        }
      } catch (_) {
        // fallback di bawah
      }

      // Coba: langsung path string
      if (audio is String && audio.isNotEmpty) {
        return analyzeAudioFromPath(audio, asGuest: asGuest);
      }

      throw UnsupportedError(
        'Di mobile/desktop, berikan objek dengan .path (XFile/File) atau String path.',
      );
    }
  }
}
</file>

<file path="lib/features/wellbeing_resources/data/repositories/wellbeing_resources_repository.dart">
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/auth_header_provider.dart';

import '../models/wellbeing_resources_create_response.dart';
import '../models/wellbeing_resources_detail_response.dart';
import '../models/wellbeing_resources_list_response.dart';

class WellbeingResourcesRepository {
  final ApiClient apiClient;
  final AuthHeaderProvider auth;

  WellbeingResourcesRepository({required this.apiClient, required this.auth});

  Future<WellbeingResourcesListResponse> getResourcesList(
      {String? category,
      String? type,
      String? ordering,
      bool asGuest = false}) async {
    final params = <String>[];
    if (category != null && category.isNotEmpty) {
      params.add('category=$category');
    }
    if (type != null && type.isNotEmpty) params.add('type=$type');
    if (ordering != null && ordering.isNotEmpty) {
      params.add('ordering=$ordering');
    }
    final q = params.isNotEmpty ? '?${params.join('&')}' : '';

  final headers = await auth.buildHeaders(asGuest: asGuest);

    final resp = await apiClient.get<List<dynamic>>(
        '/api/wellbeing/resources/$q',
        headers: headers,
        transform: (raw) => raw as List<dynamic>);
    return WellbeingResourcesListResponse(
        success: true, message: '', data: resp.data);
  }

  Future<WellbeingResourcesDetailResponse> getResourceDetail(String id,
      {bool asGuest = false}) async {
  final headers = await auth.buildHeaders(asGuest: asGuest);
    final resp = await apiClient.get<Map<String, dynamic>>(
        '/api/wellbeing/resources/$id/',
        headers: headers,
        transform: (raw) => raw as Map<String, dynamic>);
    return WellbeingResourcesDetailResponse(
        success: true, message: '', data: resp.data);
  }

  Future<WellbeingResourcesCreateResponse> createResource(
      Map<String, dynamic> data) async {
  final headers = await auth.buildHeaders();
    final resp = await apiClient.post<Map<String, dynamic>>(
        '/api/wellbeing/resources/', data,
        headers: headers, transform: (raw) => raw as Map<String, dynamic>);
    return WellbeingResourcesCreateResponse.fromJson(
        {'success': true, 'message': '', 'data': resp.data});
  }

  Future<WellbeingResourcesDetailResponse> updateResource(
      String id, Map<String, dynamic> data) async {
  final headers = await auth.buildHeaders();
    final resp = await apiClient.patch<Map<String, dynamic>>(
        '/api/wellbeing/resources/$id/', data,
        headers: headers, transform: (raw) => raw as Map<String, dynamic>);
    return WellbeingResourcesDetailResponse.fromJson(
        {'success': true, 'message': '', 'data': resp.data});
  }

  Future<bool> deleteResource(String id) async {
  final headers = await auth.buildHeaders();
    // ApiClient doesn't have delete implemented; use patch to mark deleted or implement delete call later.
    // For now attempt to call endpoint via post to a delete action if backend supports it.
    await apiClient.patch('/api/wellbeing/resources/$id/delete/', {},
        headers: headers);
    return true;
  }

  Future<bool> likeResource(String id) async {
  final headers = await auth.buildHeaders();
    await apiClient.post('/api/wellbeing/resources/$id/like/', {},
        headers: headers);
    return true;
  }

  Future<bool> unlikeResource(String id) async {
  final headers = await auth.buildHeaders();
    await apiClient.post('/api/wellbeing/resources/$id/unlike/', {},
        headers: headers);
    return true;
  }

  Future<bool> viewResource(String id, {bool asGuest = false}) async {
  final headers = await auth.buildHeaders(asGuest: asGuest);
    await apiClient.post('/api/wellbeing/resources/$id/view/', {},
        headers: headers);
    return true;
  }
}
</file>

<file path="lib/features/wellbeing_resources/presentation/pages/pojok_tenang_page.dart">
import 'package:flutter/material.dart';
import 'artikel_info_page.dart';
import 'hubungi_bantuan_page.dart';
import 'package:flutter_svg/flutter_svg.dart';
import 'package:sikap/features/mood_check/presentation/pages/mood_check_page.dart';
import '../../../../core/theme/app_theme.dart';

class PojokTenangPage extends StatefulWidget {
  const PojokTenangPage({super.key});

  @override
  State<PojokTenangPage> createState() => _PojokTenangPageState();
}

class _PojokTenangPageState extends State<PojokTenangPage> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFFFE7CE),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF7F55B1), // Purple at 76%
              Color(0xFFFFE7CE), // Soft cream at 100%
            ],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: Stack(
            children: [
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20.0),
                child: SingleChildScrollView(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const SizedBox(height: 60), // Space for back button
                  // Title
                  Text(
                    'Pojok Tenang',
                    style: AppTheme.headingLarge,
                  ),
                  const SizedBox(height: 16),
                  // Subtitle
                  Text(
                    'Temukan Ketenangan. Temukan Kekuatan.',
                    style: AppTheme.bodyLarge,
                  ),
                  const SizedBox(height: 40),
                  // Buttons Section
                  Column(
                    children: [
                      // Hubungi Bantuan Button - Full SVG
                      GestureDetector(
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const HubungiBantuanPage(),
                            ),
                          );
                        },
                        child: SizedBox(
                          width: double.infinity,
                          child: AspectRatio(
                            aspectRatio: 365 / 83,
                            child: SvgPicture.asset(
                              'assets/images/hubungi_bantuan_button.svg',
                              fit: BoxFit.contain,
                              allowDrawingOutsideViewBox: true,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      // Mood Check Button - Full SVG
                      GestureDetector(
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const MoodCheckPage(),
                            ),
                          );
                        },
                        child: SizedBox(
                          width: double.infinity,
                          child: AspectRatio(
                            aspectRatio: 365 / 83,
                            child: SvgPicture.asset(
                              'assets/images/mood_check_button.svg',
                              fit: BoxFit.contain,
                              allowDrawingOutsideViewBox: true,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      // Artikel Info Button - Full SVG
                      GestureDetector(
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const ArtikelInfoPage(),
                            ),
                          );
                        },
                        child: SizedBox(
                          width: double.infinity,
                          child: AspectRatio(
                            aspectRatio: 365 / 83,
                            child: SvgPicture.asset(
                              'assets/images/artikel_info_button.svg',
                              fit: BoxFit.contain,
                              allowDrawingOutsideViewBox: true,
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 40),
                  // Bottom Section - Copyright
                  const Padding(
                    padding: EdgeInsets.only(bottom: 20),
                    child: Center(
                      child: Text(
                        '© 2025 SIKAP. All rights reserved.',
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.white70,
                        ),
                      ),
                    ),
                  ),
                  // Additional space to ensure scrolling
                  const SizedBox(height: 100),
                ],
              ),
            ),
          ),
              // Custom Back Button
              Positioned(
                top: 0,
                left: 0,
                child: SafeArea(
                  child: Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: Container(
                      decoration: BoxDecoration(
                        color: Colors.black.withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: IconButton(
                        icon: const Icon(
                          Icons.chevron_left,
                          color: Colors.white,
                          size: 28,
                        ),
                        onPressed: () {
                          Navigator.of(context).pop();
                        },
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/wellbeing_resources/presentation/pages/wellbeing_resources_detail_page.dart">
import 'package:flutter/material.dart';
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/auth_header_provider.dart';
import 'package:sikap/features/wellbeing_resources/data/repositories/wellbeing_resources_repository.dart';
import 'package:sikap/features/wellbeing_resources/data/models/wellbeing_resources_model.dart';
import 'package:sikap/core/network/api_exception.dart';

class WellbeingResourcesDetailPage extends StatefulWidget {
  final String resourceId;

  const WellbeingResourcesDetailPage({
    super.key,
    required this.resourceId,
  });

  @override
  State<WellbeingResourcesDetailPage> createState() =>
      _WellbeingResourcesDetailPageState();
}

class _WellbeingResourcesDetailPageState
    extends State<WellbeingResourcesDetailPage> {
  bool _loading = true;
  String? _error;
  WellbeingResourcesModel? _resource;

  late final WellbeingResourcesRepository _repo;

  @override
  void initState() {
    super.initState();
    final api = ApiClient();
    final auth = AuthHeaderProvider(
        loadUserToken: () async => null, loadGuestToken: () async => null);
    _repo = WellbeingResourcesRepository(apiClient: api, auth: auth);
    _load();
  }

  Future<void> _load() async {
    setState(() {
      _loading = true;
      _error = null;
    });
    try {
      final resp =
          await _repo.getResourceDetail(widget.resourceId, asGuest: true);
      final data = resp.data;
      if (data == null) throw ApiException(message: 'Data resource kosong');
      setState(() {
        _resource =
            WellbeingResourcesModel.fromJson(Map<String, dynamic>.from(data));
      });
    } on ApiException catch (e) {
      setState(() {
        _error = e.message;
      });
      ScaffoldMessenger.of(context)
          .showSnackBar(SnackBar(content: Text(e.message)));
    } catch (e) {
      setState(() {
        _error = 'Terjadi kesalahan';
      });
      ScaffoldMessenger.of(context)
          .showSnackBar(SnackBar(content: Text(e.toString())));
    } finally {
      setState(() {
        _loading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Detail Sumber Daya'),
      ),
      body: Center(
        child: _loading
            ? const CircularProgressIndicator()
            : _error != null
                ? Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(_error!),
                      const SizedBox(height: 12),
                      ElevatedButton(
                        onPressed: _load,
                        child: const Text('Coba lagi'),
                      )
                    ],
                  )
                : _resource == null
                    ? const Text('Tidak ada data')
                    : Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: SingleChildScrollView(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(_resource!.title,
                                  style:
                                      Theme.of(context).textTheme.titleLarge),
                              const SizedBox(height: 8),
                              Text('By: ${_resource!.authorId}'),
                              const SizedBox(height: 12),
                              Text(_resource!.description),
                              const SizedBox(height: 16),
                              Text('Category: ${_resource!.category}'),
                              const SizedBox(height: 8),
                              Text('Type: ${_resource!.type}'),
                              const SizedBox(height: 8),
                              Text(
                                  'Views: ${_resource!.viewsCount} • Likes: ${_resource!.likesCount}'),
                            ],
                          ),
                        ),
                      ),
      ),
    );
  }
}
</file>

<file path="pubspec.yaml">
name: sikap
description: "A new Flutter project."
publish_to: 'none'
version: 0.1.0

environment:
  sdk: ^3.6.2

dependencies:
  flutter:
    sdk: flutter
  google_fonts: ^6.1.0
  flutter_svg: ^2.0.9
  http: ^1.2.0
  record: ^5.1.1
  path_provider: ^2.1.4
  mime: ^1.0.5
  http_parser: ^4.0.2
  file_picker: ^8.1.2
  flutter_secure_storage: ^9.2.2
  flutter_secure_storage_web: ^1.2.1

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^5.0.0

flutter:
  uses-material-design: true
  assets:
    - assets/images/
    - assets/icons/
    - assets/others/
    - assets/data/
    - assets/images/scenario_illustration/
</file>

<file path="lib/features/wellbeing_resources/presentation/pages/wellbeing_resources_form_page.dart">
import 'package:flutter/material.dart';

class WellbeingResourcesFormPage extends StatefulWidget {
  final String? resourceId; // null for create, not null for edit

  const WellbeingResourcesFormPage({
    super.key,
    this.resourceId,
  });

  @override
  State<WellbeingResourcesFormPage> createState() => _WellbeingResourcesFormPageState();
}

class _WellbeingResourcesFormPageState extends State<WellbeingResourcesFormPage> {
  final _formKey = GlobalKey<FormState>();
  final _titleController = TextEditingController();
  final _descriptionController = TextEditingController();
  final _contentController = TextEditingController();
  final _tagsController = TextEditingController();
  String _selectedType = 'article';
  String _selectedCategory = 'mental_health';

  @override
  void dispose() {
    _titleController.dispose();
    _descriptionController.dispose();
    _contentController.dispose();
    _tagsController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(widget.resourceId == null ? 'Tambah Sumber Daya' : 'Edit Sumber Daya'),
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Form(
          key: _formKey,
          child: SingleChildScrollView(
            child: Column(
              children: [
                TextFormField(
                  controller: _titleController,
                  decoration: const InputDecoration(
                    labelText: 'Judul',
                    border: OutlineInputBorder(),
                  ),
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return 'Judul tidak boleh kosong';
                    }
                    return null;
                  },
                ),
                const SizedBox(height: 16),
                TextFormField(
                  controller: _descriptionController,
                  decoration: const InputDecoration(
                    labelText: 'Deskripsi',
                    border: OutlineInputBorder(),
                  ),
                  maxLines: 2,
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return 'Deskripsi tidak boleh kosong';
                    }
                    return null;
                  },
                ),
                const SizedBox(height: 16),
                DropdownButtonFormField<String>(
                  initialValue: _selectedType,
                  decoration: const InputDecoration(
                    labelText: 'Jenis Sumber Daya',
                    border: OutlineInputBorder(),
                  ),
                  items: const [
                    DropdownMenuItem(value: 'article', child: Text('Artikel')),
                    DropdownMenuItem(value: 'video', child: Text('Video')),
                    DropdownMenuItem(value: 'audio', child: Text('Audio')),
                    DropdownMenuItem(value: 'document', child: Text('Dokumen')),
                    DropdownMenuItem(value: 'infographic', child: Text('Infografis')),
                    DropdownMenuItem(value: 'exercise', child: Text('Latihan')),
                    DropdownMenuItem(value: 'meditation', child: Text('Meditasi')),
                    DropdownMenuItem(value: 'other', child: Text('Lainnya')),
                  ],
                  onChanged: (value) {
                    setState(() {
                      _selectedType = value!;
                    });
                  },
                ),
                const SizedBox(height: 16),
                DropdownButtonFormField<String>(
                  initialValue: _selectedCategory,
                  decoration: const InputDecoration(
                    labelText: 'Kategori',
                    border: OutlineInputBorder(),
                  ),
                  items: const [
                    DropdownMenuItem(value: 'mental_health', child: Text('Kesehatan Mental')),
                    DropdownMenuItem(value: 'stress_management', child: Text('Manajemen Stres')),
                    DropdownMenuItem(value: 'mindfulness', child: Text('Mindfulness')),
                    DropdownMenuItem(value: 'self_care', child: Text('Perawatan Diri')),
                    DropdownMenuItem(value: 'relationships', child: Text('Hubungan')),
                    DropdownMenuItem(value: 'productivity', child: Text('Produktivitas')),
                    DropdownMenuItem(value: 'sleep', child: Text('Tidur')),
                    DropdownMenuItem(value: 'nutrition', child: Text('Nutrisi')),
                    DropdownMenuItem(value: 'exercise', child: Text('Olahraga')),
                    DropdownMenuItem(value: 'therapy', child: Text('Terapi')),
                    DropdownMenuItem(value: 'other', child: Text('Lainnya')),
                  ],
                  onChanged: (value) {
                    setState(() {
                      _selectedCategory = value!;
                    });
                  },
                ),
                const SizedBox(height: 16),
                TextFormField(
                  controller: _contentController,
                  decoration: const InputDecoration(
                    labelText: 'Konten',
                    border: OutlineInputBorder(),
                  ),
                  maxLines: 6,
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return 'Konten tidak boleh kosong';
                    }
                    return null;
                  },
                ),
                const SizedBox(height: 16),
                TextFormField(
                  controller: _tagsController,
                  decoration: const InputDecoration(
                    labelText: 'Tag (pisahkan dengan koma)',
                    border: OutlineInputBorder(),
                  ),
                ),
                const SizedBox(height: 24),
                ElevatedButton(
                  onPressed: () {
                    if (_formKey.currentState!.validate()) {
                      // TODO: Implement save logic
                    }
                  },
                  child: Text(widget.resourceId == null ? 'Simpan' : 'Update'),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/bullying/presentation/pages/bullying_detail_page.dart">
import 'package:flutter/material.dart';
import 'package:sikap/features/bullying/data/repositories/bullying_repository.dart';
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/auth_header_provider.dart';

class BullyingDetailPage extends StatefulWidget {
  const BullyingDetailPage({super.key, required this.id});

  final String id;

  @override
  State<BullyingDetailPage> createState() => _BullyingDetailPageState();
}

class _BullyingDetailPageState extends State<BullyingDetailPage> {
  late final BullyingRepository repo;
  bool _isLoading = true;
  Map<String, dynamic>? _data;
  String? _error;

  @override
  void initState() {
    super.initState();
    repo = BullyingRepository(
        apiClient: ApiClient(),
        auth: AuthHeaderProvider(
            loadUserToken: () async => null, loadGuestToken: () async => null));
    _loadDetail();
  }

  Future<void> _loadDetail() async {
    try {
      print("[DEBUG] Loading bullying detail for id: ${widget.id}");
      final result = await repo.getBullyingDetail(widget.id, asGuest: true);
      print("[DEBUG] Loaded detail: ${result.data}");
      if (result.success && result.data != null) {
        setState(() {
          _data = result.data;
          _isLoading = false;
        });
      } else {
        setState(() {
          _error = result.message;
          _isLoading = false;
        });
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(SnackBar(
              content: Text('Failed to load detail: ${result.message}')));
        }
      }
    } catch (e) {
      print("[DEBUG] Error loading detail: $e");
      setState(() {
        _error = e.toString();
        _isLoading = false;
      });
      if (mounted) {
        ScaffoldMessenger.of(context)
            .showSnackBar(SnackBar(content: Text('Error loading detail: $e')));
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return Scaffold(
        appBar: AppBar(
          title: const Text('Detail Laporan Bullying'),
          backgroundColor: const Color(0xFF7F55B1),
          foregroundColor: Colors.white,
        ),
        body: const Center(child: CircularProgressIndicator()),
      );
    }

    if (_error != null || _data == null) {
      return Scaffold(
        appBar: AppBar(
          title: const Text('Detail Laporan Bullying'),
          backgroundColor: const Color(0xFF7F55B1),
          foregroundColor: Colors.white,
        ),
        body: Center(child: Text('Error: $_error')),
      );
    }

    final title = _data!['title'] ?? '';
    final status = _data!['status'] ?? '';
    final createdAt =
        DateTime.tryParse(_data!['created_at'] ?? '') ?? DateTime.now();
    final category = _data!['incident_type'] ?? '';
    final description = _data!['description'] ?? '';
    final evidences = List<String>.from(_data!['evidences'] ?? []);
    final teacherComment = _data!['teacher_comment'];
    final teacherCommentDate = _data!['teacher_comment_date'] != null
        ? DateTime.tryParse(_data!['teacher_comment_date'])
        : null;

    return Scaffold(
      appBar: AppBar(
        title: const Text('Detail Laporan Bullying'),
        backgroundColor: const Color(0xFF7F55B1),
        foregroundColor: Colors.white,
      ),
      body: Container(
        color: const Color(0xFF7F55B1),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              children: [
                Expanded(
                  child: SingleChildScrollView(
                    child: Container(
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(
                              color: Colors.black.withValues(alpha: 0.12),
                              blurRadius: 12,
                              offset: const Offset(0, 4)),
                        ],
                      ),
                      padding: const EdgeInsets.all(16),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          // Status
                          Container(
                            padding: const EdgeInsets.symmetric(
                                horizontal: 10, vertical: 6),
                            decoration: BoxDecoration(
                                color: _getStatusColor(status)
                                    .withValues(alpha: 0.15),
                                borderRadius: BorderRadius.circular(20)),
                            child: Text(status,
                                style: TextStyle(
                                    color: _getStatusColor(status),
                                    fontWeight: FontWeight.w700,
                                    fontSize: 12)),
                          ),
                          const SizedBox(height: 8),
                          // Title
                          Text(title,
                              style: const TextStyle(
                                  fontSize: 20,
                                  fontWeight: FontWeight.w800,
                                  color: Colors.black87)),
                          const SizedBox(height: 12),
                          // Created at
                          Row(
                            children: [
                              const Icon(Icons.edit_calendar,
                                  size: 18, color: Colors.black45),
                              const SizedBox(width: 8),
                              Text(_formatDate(createdAt),
                                  style:
                                      const TextStyle(color: Colors.black45)),
                            ],
                          ),
                          const Divider(height: 32),
                          // Category
                          const Text('Kategori Bullying',
                              style: TextStyle(
                                  fontWeight: FontWeight.w700,
                                  color: Colors.black87)),
                          const SizedBox(height: 8),
                          Container(
                            padding: const EdgeInsets.symmetric(
                                horizontal: 12, vertical: 8),
                            decoration: BoxDecoration(
                              color: const Color(0xFFFFE4B5),
                              borderRadius: BorderRadius.circular(8),
                              boxShadow: [
                                BoxShadow(
                                    color: Colors.black.withValues(alpha: 0.05),
                                    blurRadius: 2,
                                    offset: const Offset(0, 1)),
                              ],
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                const Icon(Icons.record_voice_over,
                                    color: Color(0xFF7F55B1)),
                                const SizedBox(width: 8),
                                Text(category,
                                    style:
                                        const TextStyle(color: Colors.black87)),
                              ],
                            ),
                          ),
                          const SizedBox(height: 16),
                          // Description
                          const Text('Penjelasan',
                              style: TextStyle(
                                  fontWeight: FontWeight.w700,
                                  color: Colors.black87)),
                          const SizedBox(height: 8),
                          Text(description.isEmpty ? '-' : description),
                          const SizedBox(height: 16),
                          // Evidences
                          const Text('Bukti',
                              style: TextStyle(
                                  fontWeight: FontWeight.w700,
                                  color: Colors.black87)),
                          const SizedBox(height: 8),
                          if (evidences.isEmpty)
                            const Text('-',
                                style: TextStyle(color: Colors.black54))
                          else
                            Column(
                              children: evidences
                                  .map((e) => Padding(
                                        padding:
                                            const EdgeInsets.only(bottom: 8),
                                        child: Container(
                                          padding: const EdgeInsets.symmetric(
                                              horizontal: 12, vertical: 14),
                                          decoration: BoxDecoration(
                                              color: Colors.white,
                                              borderRadius:
                                                  BorderRadius.circular(12),
                                              boxShadow: [
                                                BoxShadow(
                                                    color: Colors.black
                                                        .withValues(
                                                            alpha: 0.05),
                                                    blurRadius: 4,
                                                    offset: const Offset(0, 2)),
                                              ]),
                                          child: Row(
                                            children: [
                                              const Icon(
                                                  Icons.insert_drive_file,
                                                  color: Color(0xFF7F55B1)),
                                              const SizedBox(width: 8),
                                              Expanded(child: Text(e)),
                                            ],
                                          ),
                                        ),
                                      ))
                                  .toList(),
                            ),
                          const SizedBox(height: 8),
                          // Teacher Comment (optional)
                          if (teacherComment != null) ...[
                            const Divider(height: 32),
                            const Text('Komentar Guru',
                                style: TextStyle(
                                    fontWeight: FontWeight.w700,
                                    color: Colors.black87)),
                            const SizedBox(height: 8),
                            Row(
                              children: [
                                const Icon(Icons.edit_calendar,
                                    size: 18, color: Colors.black45),
                                const SizedBox(width: 8),
                                Text(
                                  teacherCommentDate != null
                                      ? _formatDate(teacherCommentDate)
                                      : '-',
                                  style: const TextStyle(color: Colors.black45),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8),
                            Container(
                              width: double.infinity,
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: const Color(0xFFE6D7FF),
                                borderRadius: BorderRadius.circular(12),
                                boxShadow: [
                                  BoxShadow(
                                      color:
                                          Colors.black.withValues(alpha: 0.05),
                                      blurRadius: 4,
                                      offset: const Offset(0, 2)),
                                ],
                              ),
                              child: Text(
                                teacherComment!,
                                style: const TextStyle(color: Colors.black87),
                              ),
                            ),
                            const SizedBox(height: 8),
                          ],
                        ],
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Color _getStatusColor(String status) {
    switch (status) {
      case 'Baru':
        return const Color(0xFF2196F3);
      case 'Diproses':
        return const Color(0xFFFF9800);
      case 'Selesai':
        return const Color(0xFF2E7D32);
      case 'Ditolak':
        return const Color(0xFFD32F2F);
      default:
        return Colors.grey;
    }
  }

  String _formatDate(DateTime dt) {
    String two(int n) => n.toString().padLeft(2, '0');
    return '${dt.year}-${two(dt.month)}-${two(dt.day)} ${two(dt.hour)}:${two(dt.minute)}:${two(dt.second)}';
  }
}
</file>

<file path="lib/features/home/presentation/pages/home_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';
import 'package:sikap/features/bullying/presentation/pages/bullying_reports_list_page.dart';
import 'package:sikap/features/wellbeing_resources/presentation/pages/pojok_tenang_page.dart';
import 'package:sikap/features/scenarios/presentation/pages/scenario_catalog_page.dart';
import 'package:sikap/features/authentication/presentation/pages/login_page.dart';
import '../widgets/feature_button_placeholder.dart';
import '../../../../core/theme/app_theme.dart';

class HomePage extends StatefulWidget {
  const HomePage({super.key});

  @override
  State<HomePage> createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFFFE7CE),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF7F55B1), // Purple at 76%
              Color(0xFFFFE7CE), // Soft cream at 100%
            ],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20.0),
            child: SingleChildScrollView(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const SizedBox(height: 40),
                  // Title
                  Text(
                    'Tempat untuk Didengar',
                    style: AppTheme.headingLarge,
                  ),
                  const SizedBox(height: 16),
                  // Subtitle
                  Text(
                    'Aksi kecilmu dapat berdampak besar bagi dirimu sendiri maupun orang lain.',
                    style: AppTheme.bodyLarge,
                  ),
                  const SizedBox(height: 24),
                  // Buttons Section
                  Column(
                    children: [
                      // Lapor Bullying Button - Full SVG
                      GestureDetector(
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const BullyingReportsListPage(),
                            ),
                          );
                        },
                        child: SizedBox(
                          width: double.infinity,
                          child: AspectRatio(
                            aspectRatio: 365 / 83,
                            child: SvgPicture.asset(
                              'assets/images/lapor_bullying.svg',
                              fit: BoxFit.contain,
                              allowDrawingOutsideViewBox: true,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      // Pojok Tenang Button - Full SVG
                      GestureDetector(
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const PojokTenangPage(),
                            ),
                          );
                        },
                        child: SizedBox(
                          width: double.infinity,
                          child: AspectRatio(
                            aspectRatio: 365 / 83,
                            child: SvgPicture.asset(
                              'assets/images/pojok_tenang_button.svg',
                              fit: BoxFit.contain,
                              allowDrawingOutsideViewBox: true,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      // Jejak Intervensi Button - Full SVG
                      GestureDetector(
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const ScenarioCatalogPage(),
                            ),
                          );
                        },
                        child: SizedBox(
                          width: double.infinity,
                          child: AspectRatio(
                            aspectRatio: 365 / 83,
                            child: SvgPicture.asset(
                              'assets/images/jejak_intervensi_button.svg',
                              fit: BoxFit.contain,
                              allowDrawingOutsideViewBox: true,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      // Log Out Button
                      FeatureButtonPlaceholder(
                        title: 'Log Out',
                        subtitle: '', // Empty for logout
                        icon: Icons.logout,
                        isSettings: true,
                        backgroundColor: const Color(0xFFB678FF),
                        textColor: Colors.white,
                        iconColor: Colors.white,
                        filled: true,
                        onTap: () {
                          // Navigate back to LoginPage and clear navigation stack
                          Navigator.pushAndRemoveUntil(
                            context,
                            MaterialPageRoute(builder: (context) => const LoginPage()),
                            (route) => false,
                          );
                        },
                      ),
                    ],
                  ),
                  const SizedBox(height: 20),
                  // Bottom Section - Copyright
                  const Padding(
                    padding: EdgeInsets.only(bottom: 20),
                    child: Center(
                      child: Text(
                        '© 2025 SIKAP. All rights reserved.',
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.white70,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

}
</file>

<file path="lib/features/bullying/presentation/pages/bullying_form_page.dart">
import 'package:flutter/material.dart';
import 'package:sikap/features/bullying/data/repositories/bullying_repository.dart';
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/auth_header_provider.dart';
import 'package:sikap/core/auth/session_service.dart';
import 'package:sikap/core/auth/ensure_guest_auth.dart';      // <— penting
import 'package:sikap/core/network/api_exception.dart';

class BullyingFormPage extends StatefulWidget {
  final String? bullyingId; // null for create, not null for edit
  const BullyingFormPage({super.key, this.bullyingId});

  @override
  State<BullyingFormPage> createState() => _BullyingFormPageState();
}

class _BullyingFormPageState extends State<BullyingFormPage> {
  final _formKey = GlobalKey<FormState>();
  final _titleController = TextEditingController();
  final _descriptionController = TextEditingController();
  final _locationController = TextEditingController();

  final _session = SessionService();
  final _api = ApiClient();

  late final AuthHeaderProvider _auth;
  late final BullyingRepository _repo;

  // UI state
  String _selectedSeverity = 'medium';
  bool _isLoading = false;

  // Data incident types dari server: [{id, name, slug}]
  List<Map<String, dynamic>> _incidentTypes = [];
  int? _incidentTypeId;

  @override
  void initState() {
    super.initState();
    _auth = AuthHeaderProvider(
      loadUserToken: () async => null, // guest-only flow
      loadGuestToken: () async => await _session.loadGuestToken(),
    );
    _repo = BullyingRepository(apiClient: _api, auth: _auth);

    WidgetsBinding.instance.addPostFrameCallback((_) => _bootstrap());
  }

  Future<void> _bootstrap() async {
    try {
      // Pastikan sesi tamu ada (akan quick-login bila perlu).
      await ensureGuestAuthenticated();

      // Muat incident types
      await _loadIncidentTypes();
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Inisialisasi gagal: $e'), backgroundColor: Colors.red),
      );
    }
  }

  Future<void> _loadIncidentTypes() async {
    try {
      final headers = await _auth.buildHeaders(asGuest: true);
      final resp = await _api.get<dynamic>(
        "/api/bullying/incident-types/",
        headers: headers,
        transform: (raw) {
          if (raw is List) return raw;
          if (raw is Map && raw['results'] is List) return raw['results'];
          throw const FormatException("Unexpected incident-types shape");
        },
      );

      final list = (resp.data as List)
          .map((e) => Map<String, dynamic>.from(e as Map))
          .map((e) {
            final dynamicId = e['incident_type_id'] ?? e['id'];
            final dynamicName = e['type_name'] ?? e['name'] ?? e['type'] ?? 'Unknown';
            final id = (dynamicId is num) ? dynamicId.toInt() : int.tryParse('$dynamicId');
            final name = '$dynamicName';
            return {
              'id': id,
              'name': name,
              'slug': name.toLowerCase().trim(),
            };
          })
          .where((m) => m['id'] != null)
          .toList();

      int? pickedId;
      if (list.isNotEmpty) {
        pickedId = list.first['id'] as int;
      }

      if (!mounted) return;
      setState(() {
        _incidentTypes = list;
        _incidentTypeId = pickedId;
      });
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Gagal memuat jenis insiden. Coba lagi."),
          backgroundColor: Colors.orange,
        ),
      );
    }
  }

  Future<void> _submitForm() async {
    if (!_formKey.currentState!.validate()) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Form tidak valid. Lengkapi semua field wajib."),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    if (_incidentTypeId == null) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Jenis insiden belum siap. Coba lagi sebentar..."),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    // Pastikan token ada sebelum mengirim
    final token = await _session.loadGuestToken();
    final gid = await _session.loadGuestId();
    if ((token == null || token.isEmpty) && gid == null) {
      // coba quick-login sekali lagi
      try {
        await ensureGuestAuthenticated();
      } catch (_) {}
    }

    final data = {
      "title": _titleController.text.trim(),
      "description": _descriptionController.text.trim(),  // ≥ 10
      "location": _locationController.text.trim(),        // ≥ 2
      "incident_type_id": _incidentTypeId,                // INT
      "severity": _selectedSeverity,                      // low|medium|high|critical
      "confirm_truth": true,
      // jangan kirim guest_id — BE derive dari sesi guest
    };

    setState(() => _isLoading = true);
    try {
      final res = await _repo.createBullyingReport(data, asGuest: true);
      // ignore: avoid_print
      print("[DEBUG] createBullyingReport OK: ${res.data}");
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Laporan berhasil dikirim 🎉"),
          backgroundColor: Colors.green,
        ),
      );
      Navigator.pop(context);
    } on ApiException catch (e) {
      // Retry hanya jika 401
      if (e.code == 401) {
        try {
          await ensureGuestAuthenticated();
          final res2 = await _repo.createBullyingReport(data, asGuest: true);
          // ignore: avoid_print
          print("[DEBUG] createBullyingReport retry OK: ${res2.data}");
          if (!mounted) return;
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text("Laporan berhasil dikirim 🎉"),
              backgroundColor: Colors.green,
            ),
          );
          Navigator.pop(context);
          return;
        } catch (_) {
          // fallthrough ke snackbar di bawah
        }
      }
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text("Gagal mengirim laporan (${e.code ?? 'ERR'}): ${e.message}"),
          backgroundColor: Colors.red,
        ),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text("Gagal mengirim laporan: $e"),
          backgroundColor: Colors.red,
        ),
      );
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  void dispose() {
    _titleController.dispose();
    _descriptionController.dispose();
    _locationController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final canSubmit = !_isLoading && _incidentTypeId != null;

    return Scaffold(
      appBar: AppBar(
        title: Text(widget.bullyingId == null ? 'Laporkan Bullying' : 'Edit Laporan'),
      ),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter, end: Alignment.bottomCenter,
            colors: [Color(0xFF7F55B1), Color(0xFFFFDBB6)],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16.0),
            child: Form(
              key: _formKey,
              child: Column(
                children: [
                  TextFormField(
                    controller: _titleController,
                    decoration: const InputDecoration(
                      labelText: 'Judul Laporan', border: OutlineInputBorder(),
                    ),
                    validator: (v) =>
                      (v == null || v.trim().isEmpty) ? 'Judul tidak boleh kosong' : null,
                  ),
                  const SizedBox(height: 16),
                  TextFormField(
                    controller: _descriptionController,
                    decoration: const InputDecoration(
                      labelText: 'Deskripsi', border: OutlineInputBorder(),
                    ),
                    maxLines: 4,
                    validator: (v) {
                      if (v == null || v.trim().isEmpty) return 'Deskripsi tidak boleh kosong';
                      if (v.trim().length < 10) return 'Deskripsi minimal 10 karakter';
                      return null;
                    },
                  ),
                  const SizedBox(height: 16),
                  TextFormField(
                    controller: _locationController,
                    decoration: const InputDecoration(
                      labelText: 'Lokasi Kejadian', border: OutlineInputBorder(),
                    ),
                    validator: (v) =>
                      (v == null || v.trim().length < 2) ? 'Lokasi minimal 2 karakter' : null,
                  ),
                  const SizedBox(height: 16),

                  // Dropdown "Jenis Bullying"
                  DropdownButtonFormField<int>(
                    value: _incidentTypeId,
                    decoration: const InputDecoration(
                      labelText: 'Jenis Bullying', border: OutlineInputBorder(),
                    ),
                    items: _incidentTypes.map((m) {
                      return DropdownMenuItem<int>(
                        value: m['id'] as int,
                        child: Text(m['name'] as String),
                      );
                    }).toList(),
                    onChanged: (value) => setState(() => _incidentTypeId = value),
                    validator: (_) => _incidentTypeId == null ? 'Pilih jenis bullying' : null,
                  ),
                  const SizedBox(height: 16),

                  // Severity
                  DropdownButtonFormField<String>(
                    value: _selectedSeverity,
                    decoration: const InputDecoration(
                      labelText: 'Tingkat Keparahan', border: OutlineInputBorder(),
                    ),
                    items: const [
                      DropdownMenuItem(value: 'low', child: Text('Rendah')),
                      DropdownMenuItem(value: 'medium', child: Text('Sedang')),
                      DropdownMenuItem(value: 'high', child: Text('Tinggi')),
                      DropdownMenuItem(value: 'critical', child: Text('Kritis')),
                    ],
                    onChanged: (v) => setState(() => _selectedSeverity = v!),
                  ),

                  const SizedBox(height: 24),
                  ElevatedButton(
                    onPressed: canSubmit ? _submitForm : null,
                    child: _isLoading
                        ? const CircularProgressIndicator(color: Colors.white)
                        : Text(widget.bullyingId == null ? 'Kirim Laporan' : 'Update Laporan'),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/features/bullying/presentation/pages/bullying_report_wizard_page.dart">
import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';
import 'package:sikap/features/bullying/data/repositories/bullying_repository.dart';
import 'package:sikap/core/network/api_client.dart';
import 'package:sikap/core/network/auth_header_provider.dart';

class BullyingReportWizardPage extends StatefulWidget {
  const BullyingReportWizardPage({super.key});

  @override
  State<BullyingReportWizardPage> createState() =>
      _BullyingReportWizardPageState();
}

class _BullyingReportWizardPageState extends State<BullyingReportWizardPage> {
  static const int totalSteps = 4;
  int currentStep = 1;

  // form state
  String? selectedCategory; // step 1
  final TextEditingController descriptionController =
      TextEditingController(); // step 2
  final List<String> evidences = []; // step 3 (placeholder path strings)
  bool anonymous = false; // step 4
  bool confirmTruth = false; // step 4

  @override
  void dispose() {
    descriptionController.dispose();
    super.dispose();
  }

  double get progress => currentStep / totalSteps;

  void next() {
    if (currentStep < totalSteps) {
      setState(() {
        currentStep += 1;
      });
    }
  }

  void previous() {
    if (currentStep > 1) {
      setState(() {
        currentStep -= 1;
      });
    } else {
      // Jika di step pertama, kembali ke halaman sebelumnya
      Navigator.of(context).pop();
    }
  }

  Widget _header() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('Langkah $currentStep dari $totalSteps',
            style: const TextStyle(color: Colors.white70, fontSize: 12)),
        const SizedBox(height: 6),
        ClipRRect(
          borderRadius: BorderRadius.circular(4),
          child: LinearProgressIndicator(
            value: progress,
            minHeight: 6,
            backgroundColor: Colors.white24,
            valueColor: const AlwaysStoppedAnimation<Color>(Colors.white),
          ),
        ),
      ],
    );
  }

  Widget _stepTitle(String title) {
    return Text(
      title,
      style: const TextStyle(
        fontSize: 26,
        fontWeight: FontWeight.w800,
        color: Colors.white,
      ),
    );
  }

  Widget _bullyingTypeButton({
    required String key,
    required String title,
    required String description,
    required IconData icon,
    required bool isSelected,
    required VoidCallback onTap,
  }) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: isSelected
                ? const Color(0xFFE6D7FF)
                : const Color(
                    0xFFF5F5DC), // Purple tint when selected, beige when not
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: isSelected
                  ? const Color(0xFF7F55B1)
                  : const Color(0xFF7F55B1).withValues(alpha: 0.3),
              width: isSelected ? 2 : 1,
            ),
            boxShadow: [
              BoxShadow(
                color: isSelected
                    ? const Color(0xFF7F55B1).withValues(alpha: 0.2)
                    : Colors.black.withValues(alpha: 0.1),
                blurRadius: isSelected ? 12 : 8,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: Row(
            children: [
              // Left section - Icon
              Container(
                width: 50,
                height: 50,
                decoration: BoxDecoration(
                  color: isSelected ? const Color(0xFF7F55B1) : Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: isSelected
                          ? const Color(0xFF7F55B1).withValues(alpha: 0.3)
                          : Colors.black.withValues(alpha: 0.1),
                      blurRadius: 4,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Icon(
                  icon,
                  color: isSelected ? Colors.white : const Color(0xFF7F55B1),
                  size: 28,
                ),
              ),
              const SizedBox(width: 16),
              // Right section - Title and Description
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Top right - Bullying type title
                    Text(
                      title,
                      style: const TextStyle(
                        fontWeight: FontWeight.w800,
                        fontSize: 18,
                        color: Color(0xFF8B4513), // Brownish color
                      ),
                    ),
                    const SizedBox(height: 8),
                    // Bottom right - Type description
                    Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 12, vertical: 6),
                      decoration: BoxDecoration(
                        color: const Color(
                            0xFFFFE4B5), // Light orange/peach background
                        borderRadius: BorderRadius.circular(8),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withValues(alpha: 0.05),
                            blurRadius: 2,
                            offset: const Offset(0, 1),
                          ),
                        ],
                      ),
                      child: Text(
                        description,
                        style: const TextStyle(
                          color: Colors.black87,
                          fontSize: 12,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _step1() {
    final items = <Map<String, dynamic>>[
      {
        'key': 'fisik',
        'title': 'Secara fisik',
        'description': 'misalnya mendorong, memukul',
        'icon': Icons.pan_tool, // Fist icon
      },
      {
        'key': 'verbal',
        'title': 'Secara verbal',
        'description': 'misalnya mengejek, menghina',
        'icon': Icons.record_voice_over,
      },
      {
        'key': 'cyber',
        'title': 'Cyberbullying',
        'description': 'di media sosial, pesan teks',
        'icon': Icons.computer,
      },
      {
        'key': 'sosial',
        'title': 'Pengucilan',
        'description': 'menyebarkan rumor, mengabaikan',
        'icon': Icons.group_off,
      },
      {
        'key': 'lainnya',
        'title': 'Lainnya',
        'description': 'tipe lain',
        'icon': Icons.more_horiz,
      },
    ];

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _stepTitle('Apa yang terjadi?'),
        const SizedBox(height: 8),
        const Text('Pilih sesuai kategori kejadian bullying',
            style: TextStyle(color: Colors.white70)),
        const SizedBox(height: 16),
        ...items.map((item) {
          final isSelected = selectedCategory == item['key'];
          return _bullyingTypeButton(
            key: item['key'],
            title: item['title'],
            description: item['description'],
            icon: item['icon'],
            isSelected: isSelected,
            onTap: () => setState(() => selectedCategory = item['key']),
          );
        }),
      ],
    );
  }

  Widget _step2() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _stepTitle('Ceritakan kepada kami apa yang terjadi'),
        const SizedBox(height: 8),
        const Text(
          'Jelaskan apa yang terjadi, siapa yang terlibat, dan kapan/di mana kejadian tersebut berlangsung. Jelaskan selengkap mungkin.',
          style: TextStyle(color: Colors.white70),
        ),
        const SizedBox(height: 16),
        Container(
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(16),
              boxShadow: [
                BoxShadow(
                    color: Colors.black.withValues(alpha: 0.08), blurRadius: 8),
              ]),
          child: TextField(
            controller: descriptionController,
            maxLines: 10,
            style: const TextStyle(
              color: Colors.black87,
              fontSize: 16,
            ),
            decoration: const InputDecoration.collapsed(
              hintText: 'Tulis kronologi kejadian...',
              hintStyle: TextStyle(
                color: Colors.black54,
                fontSize: 16,
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _step3() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _stepTitle('Apakah kamu punya bukti yang bisa dibagikan?'),
        const SizedBox(height: 8),
        const Text(
            'Bukti dapat berupa foto, video, atau dokumen PDF. (Placeholder daftar)',
            style: TextStyle(color: Colors.white70)),
        const SizedBox(height: 12),
        ...evidences.map((e) => Padding(
              padding: const EdgeInsets.only(bottom: 8),
              child: Container(
                padding:
                    const EdgeInsets.symmetric(horizontal: 12, vertical: 14),
                decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12)),
                child: Row(
                  children: [
                    const Icon(Icons.insert_drive_file,
                        color: Color(0xFF7F55B1)),
                    const SizedBox(width: 8),
                    Expanded(child: Text(e)),
                    IconButton(
                        onPressed: () => setState(() => evidences.remove(e)),
                        icon: const Icon(Icons.close))
                  ],
                ),
              ),
            )),
        OutlinedButton.icon(
          onPressed: () {
            setState(() {
              evidences.add('Bukti ${evidences.length + 1}');
            });
          },
          icon: const Icon(Icons.add),
          label: const Text('Tambah bukti (placeholder)'),
          style: OutlinedButton.styleFrom(
              foregroundColor: Colors.white,
              side: const BorderSide(color: Colors.white70)),
        ),
      ],
    );
  }

  Widget _step4() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _stepTitle('Periksa kembali laporanmu'),
        const SizedBox(height: 12),
        Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
              color: Colors.white, borderRadius: BorderRadius.circular(16)),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text('Kategori Bullying: ${selectedCategory ?? '-'}'),
              const SizedBox(height: 8),
              const Text('Penjelasan:'),
              Text(descriptionController.text.isEmpty
                  ? '-'
                  : descriptionController.text),
              const SizedBox(height: 8),
              const Text('Bukti:'),
              Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children:
                      evidences.map((e) => Chip(label: Text(e))).toList()),
            ],
          ),
        ),
        const SizedBox(height: 12),
        CheckboxListTile(
          value: confirmTruth,
          onChanged: (v) => setState(() => confirmTruth = v ?? false),
          title: const Text(
              'Saya menyatakan bahwa informasi ini adalah kejadian yang benar-benar terjadi.',
              style: TextStyle(color: Colors.white)),
          controlAffinity: ListTileControlAffinity.leading,
          activeColor: Colors.white,
          checkColor: const Color(0xFF7F55B1),
        ),
      ],
    );
  }

  Widget _content() {
    switch (currentStep) {
      case 1:
        return _step1();
      case 2:
        return _step2();
      case 3:
        return _step3();
      default:
        return _step4();
    }
  }

  @override
  Widget build(BuildContext context) {
    return PopScope(
      canPop: currentStep == 1,
      onPopInvokedWithResult: (bool didPop, dynamic result) {
        if (!didPop && currentStep > 1) {
          // Jika tidak di step pertama, kembali ke step sebelumnya
          previous();
        }
      },
      child: Scaffold(
        body: Container(
          decoration: const BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
              colors: [
                Color(0xFF7F55B1), // Purple at 76%
                Color(0xFFFFDBB6), // Light peach/orange at 100%
              ],
              stops: [0.76, 1.0],
            ),
          ),
          child: SafeArea(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  child: Padding(
                    padding: const EdgeInsets.symmetric(
                        horizontal: 20.0, vertical: 16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _header(),
                        const SizedBox(height: 16),
                        Expanded(
                          child: SingleChildScrollView(
                            child: _content(),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                // Footer dengan background SVG
                SizedBox(
                  height: 95, // Fixed height from SVG
                  child: Stack(
                    children: [
                      // SVG background
                      Positioned.fill(
                        child: SvgPicture.asset(
                          'assets/others/footer_form.svg',
                          fit: BoxFit.fill,
                        ),
                      ),
                      // Buttons
                      Padding(
                        padding: const EdgeInsets.symmetric(
                            horizontal: 20.0, vertical: 24),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          crossAxisAlignment: CrossAxisAlignment.center,
                          children: [
                            // Back Button
                            Container(
                              width: 50,
                              height: 50,
                              decoration: const BoxDecoration(
                                color: Color(
                                    0xAA9D6CFF), // Purple-ish color with opacity
                                shape: BoxShape.circle,
                              ),
                              child: IconButton(
                                onPressed: previous,
                                icon: const Icon(
                                  Icons.arrow_back_ios_new,
                                  color: Colors.white,
                                  size: 20,
                                ),
                                padding: EdgeInsets.zero,
                              ),
                            ),

                            // Selanjutnya Button
                            Container(
                              padding: const EdgeInsets.symmetric(
                                  horizontal: 24, vertical: 14),
                              decoration: BoxDecoration(
                                color: const Color(
                                    0xFFC89EFF), // Light purple color
                                borderRadius: BorderRadius.circular(30),
                              ),
                              child: ElevatedButton(
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: const Color(
                                      0xFFC89EFF), // Light purple color
                                  foregroundColor: Colors.white,
                                  padding: EdgeInsets
                                      .zero, // Padding sudah diatur di Container
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(30),
                                  ),
                                  elevation:
                                      0, // Remove default elevation since we're using custom shadow
                                ),
                                onPressed: currentStep < totalSteps
                                    ? () {
                                        if (currentStep == 1 &&
                                            selectedCategory == null) {
                                          return;
                                        }
                                        next();
                                      }
                                    : (confirmTruth
                                        ? () async {
                                            final data = {
                                              'incident_type': selectedCategory,
                                              'description':
                                                  descriptionController.text,
                                              'evidences': evidences,
                                              'anonymous': anonymous,
                                              'confirm_truth': confirmTruth,
                                            };
                                            try {
                                              print(
                                                  "[DEBUG] Submitting bullying report");
                                              final repo = BullyingRepository(
                                                  apiClient: ApiClient(),
                                                  auth: AuthHeaderProvider(
                                                      loadUserToken: () async =>
                                                          null,
                                                      loadGuestToken:
                                                          () async => null));
                                              final result = await repo
                                                  .createBullyingReport(data,
                                                      asGuest: true);
                                              print(
                                                  "[DEBUG] Submit result: ${result.data}");
                                              if (result.success) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(const SnackBar(
                                                        content: Text(
                                                            'Report submitted successfully')));
                                                Navigator.of(context)
                                                    .pushReplacement(
                                                  MaterialPageRoute(
                                                    builder: (_) =>
                                                        const BullyingReportSuccessPage(),
                                                  ),
                                                );
                                              } else {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(SnackBar(
                                                        content: Text(
                                                            'Failed to submit report: ${result.message}')));
                                              }
                                            } catch (e) {
                                              print(
                                                  "[DEBUG] Error submitting report: $e");
                                              ScaffoldMessenger.of(context)
                                                  .showSnackBar(SnackBar(
                                                      content: Text(
                                                          'Error submitting report: $e')));
                                            }
                                          }
                                        : null),
                                child: Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    Text(
                                      currentStep < totalSteps
                                          ? 'Selanjutnya'
                                          : 'Kirim Laporan',
                                      style: const TextStyle(
                                        color: Colors.white,
                                        fontWeight: FontWeight.w600,
                                        fontSize: 16,
                                      ),
                                    ),
                                    const SizedBox(width: 8),
                                    const Icon(
                                      Icons.arrow_forward,
                                      color: Colors.white,
                                      size: 20,
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class BullyingReportSuccessPage extends StatelessWidget {
  const BullyingReportSuccessPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF7F55B1),
              Color(0xFFFFDBB6),
            ],
            stops: [0.76, 1.0],
          ),
        ),
        child: SafeArea(
          child: Center(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 24.0),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Container(
                    width: 96,
                    height: 96,
                    decoration: const BoxDecoration(
                      color: Color(0xAA9D6CFF),
                      shape: BoxShape.circle,
                    ),
                    child: const Icon(
                      Icons.check,
                      color: Colors.white,
                      size: 48,
                    ),
                  ),
                  const SizedBox(height: 24),
                  const Text(
                    'Terima kasih telah menjadi berani. Laporan anda akan segera kami tinjau',
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: 20,
                      color: Colors.white,
                      fontWeight: FontWeight.w700,
                    ),
                  ),
                  const SizedBox(height: 24),
                  ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFFC89EFF),
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(30),
                      ),
                    ),
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Padding(
                      padding:
                          EdgeInsets.symmetric(horizontal: 20.0, vertical: 12),
                      child: Text(
                        'Selesai',
                        style: TextStyle(
                          fontWeight: FontWeight.w600,
                          fontSize: 16,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
</file>

</files>
